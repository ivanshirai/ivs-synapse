{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workspaceName": {
			"type": "string",
			"metadata": "Workspace name",
			"defaultValue": "ivs-synapse"
		},
		"ivs-synapse-WorkspaceDefaultSqlServer_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'ivs-synapse-WorkspaceDefaultSqlServer'",
			"defaultValue": "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=tcp:ivs-synapse.sql.azuresynapse.net,1433;Initial Catalog=@{linkedService().DBName}"
		},
		"serverless_ARIR_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'serverless_ARIR'",
			"defaultValue": "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=ivs-synapse-ondemand.sql.azuresynapse.net;Initial Catalog=@{linkedService().p_database}"
		},
		"BloombergAPI_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://api.bloomberg.com/eap"
		},
		"azuresynapse_REST_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "@{concat('https://', linkedService().p_workspace, '.dev.azuresynapse.net')}"
		},
		"azuresynapse_REST_properties_typeProperties_aadResourceId": {
			"type": "string",
			"defaultValue": "https://dev.azuresynapse.net/"
		},
		"ivs-synapse-WorkspaceDefaultStorage_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://ivsdatastorage.dfs.core.windows.net"
		},
		"template_kv_properties_typeProperties_baseUrl": {
			"type": "string",
			"defaultValue": "https://ivs-dwh-kv.vault.azure.net/"
		},
		"templatecurst_ARIR_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://ivscur.dfs.core.windows.net/"
		},
		"templateenrst_ARIR_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://ivsenr.dfs.core.windows.net/"
		},
		"templaterawst_ARIR_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://ivsraw.dfs.core.windows.net/"
		},
		"SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_subscription": {
			"type": "string",
			"defaultValue": "f939f8f3-2652-4a45-88ae-78a7782ec9df"
		},
		"SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_resourceGroup": {
			"type": "string",
			"defaultValue": "ivs-dwh-rg"
		},
		"SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_workspace": {
			"type": "string",
			"defaultValue": "ivs-synapse"
		},
		"SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_sqlPool": {
			"type": "string",
			"defaultValue": "ivs_sqlpool"
		}
	},
	"variables": {
		"workspaceId": "[concat('Microsoft.Synapse/workspaces/', parameters('workspaceName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('workspaceName'), '/FromDeltaToWideDelta')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "GetTargetDeltaMetadata",
						"type": "GetMetadata",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataset": {
								"referenceName": "GenericEnrichedJsonFolder",
								"type": "DatasetReference",
								"parameters": {
									"p_container": {
										"value": "@pipeline().parameters.c_trg_container",
										"type": "Expression"
									},
									"p_folder": {
										"value": "@concat(pipeline().parameters.c_trg_root_folder, '/', pipeline().parameters.c_trg_object)",
										"type": "Expression"
									}
								}
							},
							"fieldList": [
								"exists"
							],
							"storeSettings": {
								"type": "AzureBlobFSReadSettings",
								"recursive": true,
								"enablePartitionDiscovery": false
							},
							"formatSettings": {
								"type": "JsonReadSettings"
							}
						}
					},
					{
						"name": "EnrichedLakeSettings",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', pipeline().parameters.c_trg_linked_service, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "SourceQueryParts",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "GetTargetDeltaMetadata",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "Set v_cdc",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "serverless_ARIR",
							"type": "LinkedServiceReference",
							"parameters": {
								"p_database": {
									"value": "@pipeline().parameters.c_serverless_db",
									"type": "Expression"
								}
							}
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": {
										"value": "declare @SQLScript nvarchar(max)\n\nwith src as (\nselect *\n   FROM OPENJSON('@{replace(string(pipeline().parameters.p_src_objects), '''', '''''')}') \n   WITH (\n    iteration integer '$.iteration',\n    object NVARCHAR(max) '$.object',\n    dbschema NVARCHAR(max) '$.schema',\n    alias NVARCHAR(max) '$.alias',\n    trgKeyCol NVARCHAR(max) '$.trgKeyCol',\n    cdcCol NVARCHAR(max) '$.cdcCol',\n    selectCols NVARCHAR(max) '$.selectCols',\n    joinCondition NVARCHAR(max) '$.joinCondition',\n    joinType NVARCHAR(max) '$.joinType',\n    joinOrder integer '$.joinOrder')\n),\nkcl as (    select src.*, k.keyCols from src left outer join(select iteration, string_agg(coalesce(alias, object) + '_' + replace(replace(trgKeyCol, ' ', ''), ',', ', ' + coalesce(alias, object) + '_'), ', ') keyCols\n   FROM OPENJSON('@{replace(string(pipeline().parameters.p_src_objects), '''', '''''')}') \n   WITH (\n    iteration integer '$.iteration',\n    object NVARCHAR(max) '$.object',\n    dbschema NVARCHAR(max) '$.schema',\n    alias NVARCHAR(max) '$.alias',\n    trgKeyCol NVARCHAR(max) '$.trgKeyCol',\n    cdcCol NVARCHAR(max) '$.cdcCol',\n    selectCols NVARCHAR(max) '$.selectCols',\n    joinCondition NVARCHAR(max) '$.joinCondition',\n    joinType NVARCHAR(max) '$.joinType',\n    joinOrder integer '$.joinOrder')\n\twhere iteration = 0 group by iteration) k \non 1 = 1),\nrpl as (select kcl.*, r.replace_start, r.replace_end from kcl join\n(select iteration, string_agg('replace(', '') replace_start, \nstring_agg(', ''' + case when left(trim(object), 1) = '(' and right(trim(object), 1) = ')' \nthen alias + '.' else object + '.' end + ''', ''' + coalesce(alias, object) + '.'')', '') replace_end\n   FROM OPENJSON('@{replace(string(pipeline().parameters.p_src_objects), '''', '''''')}') \n   WITH (\n    iteration integer '$.iteration',\n    object NVARCHAR(max) '$.object',\n    dbschema NVARCHAR(max) '$.schema',\n    alias NVARCHAR(max) '$.alias',\n    trgKeyCol NVARCHAR(max) '$.trgKeyCol',\n    cdcCol NVARCHAR(max) '$.cdcCol',\n    selectCols NVARCHAR(max) '$.selectCols',\n    joinCondition NVARCHAR(max) '$.joinCondition',\n    joinType NVARCHAR(max) '$.joinType',\n    joinOrder integer '$.joinOrder')\n\tgroup by iteration) r\n\ton r.iteration = kcl.iteration)\nselect @SQLScript = STRING_AGG(cast(SQLScript as nvarchar(max)), ' union ') from (\nselect 'select ' + cast(rpl.iteration as varchar(10)) + ' as iteration, ' +\ncoalesce('''' + replace(rpl.object, char(39), char(39) + char(39)) + '''', 'null') + ' as object, ' +\ncoalesce('''' + replace(rpl.dbschema, char(39), char(39) + char(39)) + '''', 'null') + ' as dbschema, ' +\ncoalesce('''' + replace(rpl.alias, char(39), char(39) + char(39)) + '''', 'null') + ' as alias, ' +\ncoalesce('''' + replace(rpl.trgKeyCol, char(39), char(39) + char(39)) + '''', 'null') + ' as trgKeyCol, ' +\ncoalesce('''' + replace(rpl.cdcCol, char(39), char(39) + char(39)) + '''', 'null') + ' as cdcCol, ' +\ncoalesce('''' + replace(rpl.selectCols, char(39), char(39) + char(39)) + '''', 'null') + ' as selectCols, ' +\ncoalesce('''' + replace(rpl.joinCondition, char(39), char(39) + char(39)) + '''', 'null') + ' as joinCondition, ' +\ncoalesce('''' + replace(rpl.joinType, char(39), char(39) + char(39)) + '''', 'null') + ' as joinType, ' +\ncast(rpl.joinOrder as varchar(10)) + ' as joinOrder, ' +\ncoalesce('''' + replace(rpl.replace_start, char(39), char(39) + char(39)) + '''', 'null') + ' as replaceStart, ' +\ncoalesce('''' + replace(rpl.replace_end, char(39), char(39) + char(39)) + '''', 'null') + ' as replaceEnd, ' +\ncoalesce('''' + replace(rpl.keyCols, char(39), char(39) + char(39)) + '''', 'null') + ' as keyColsStatement, ' +\ncoalesce('''' + replace(CASE trim(rpl.selectCols)\n\t\t\t\tWHEN '*' THEN (select string_agg(cast('<obj>.' + c.name + ' as <obj>_' + c.name as nvarchar(max)), ', ') \n\t\t\t\t\tfrom sys.columns c \n\t\t\t\t\tjoin sys.views v on c.object_id = v.object_id\n\t\t\t\t\tjoin sys.schemas s on s.schema_id = v.schema_id\n\t\t\t\t\twhere v.name = rpl.object and s.name = rpl.dbschema)\n\t\t\t\tELSE (select string_agg(cast('<obj>.' + value + ' as <obj>_' + value as nvarchar(max)), ', ') \n\t\t\t\t\tfrom string_split(replace(replace(rpl.selectCols, char(39), char(39) + char(39)), ' ', ''), ',')\n\t\t\t\t\twhere lower(value) <> rpl.cdcCol) + coalesce(', ' + cast('<obj>.' + rpl.cdcCol + ' as <obj>_' + rpl.cdcCol as nvarchar(max)), '') END, '<obj>', coalesce(rpl.alias, rpl.object)) + '''', 'null') + ' as selectStatement, ' +\ncoalesce('''' + CASE WHEN left(trim(object), 1) = '(' and right(trim(object), 1) = ')' \n\t\t\t\tTHEN replace(replace(object, char(39), char(39) + char(39)), '<schema>', rpl.dbschema) + ' ' + alias\n\t\t\t\tELSE replace(rpl.object, rpl.object, rpl.dbschema + '.' + rpl.object + ' as ' + coalesce(rpl.alias, rpl.object)) \n\t\t\t\tEND + '''', 'null') + ' as fromStatement, ' + \ncoalesce('' + rpl.replace_start + char(39) + \nreplace(CASE WHEN rpl.iteration = 0 THEN rpl.joinCondition ELSE replace(rpl.joinCondition, '<trgtab>', '_stg') END, char(39), char(39) + char(39)) + char(39) + rpl.replace_end, 'null') + ' as joinStatement, ' + \ncoalesce('''' + coalesce(alias, object) +'.' + rpl.cdcCol + ' > '''''' + ' + coalesce('cast(max(' + @{if(empty(pipeline().parameters.p_datetime_from), if(activity('GetTargetDeltaMetadata').output.exists, 'dbSys.colName', '''''''1900-01-01'''''''), concat('''', pipeline().parameters.p_datetime_from, ''''))} + ') as varchar(50)) ', '''1900-01-01''') + ' + ''''''''', 'null') + ' as whereStatement' +\ncase when dbSys.colName is null or @{if(activity('GetTargetDeltaMetadata').output.exists, '1=0', '1=1')} then '' else ' from @{pipeline().parameters.c_trg_schema}.@{pipeline().parameters.c_trg_object}' end as SQLScript\nfrom rpl\nleft outer join \n(select c.name as colName, v.name as viewName, s.name as schemaName\nfrom sys.columns c\njoin sys.views v on c.object_id = v.object_id \njoin sys.schemas s on v.schema_id = s.schema_id) dbSys \non dbSys.ColName = coalesce(rpl.alias, rpl.object) + '_' + cdcCol\nand dbSys.schemaName = '@{pipeline().parameters.c_trg_schema}'\nand dbSys.viewName = '@{pipeline().parameters.c_trg_object}') q\n\nexec('select * from (' + @SQLScript + ') q order by iteration, joinOrder')",
										"type": "Expression"
									}
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					},
					{
						"name": "SourceQuery",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "SourceQueryParts",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "serverless_ARIR",
							"type": "LinkedServiceReference",
							"parameters": {
								"p_database": {
									"value": "@pipeline().parameters.c_serverless_db",
									"type": "Expression"
								}
							}
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": {
										"value": "declare @SQLScript nvarchar(max)\n\nSELECT @SQLScript = STRING_AGG('select ' + cast(iteration as nvarchar(max)) + ' as iteration, ''' \n+ keyCols + ''' as keyCols, ' + sourceQuery + ' as sourceQuery, ' + pruningQuery + ' as pruningQuery', ' union ') FROM (\nSELECT iteration, min(keyColsStatement) as keyCols, '''select '''\n+ coalesce(' + ''@{pipeline().parameters.c_trg_alias}.' + replace(replace(replace(min(case iteration when 0 then null else keyColsStatement end), ' ', ''), ',', ', @{pipeline().parameters.c_trg_alias}.'), char(39), char(39) + char(39)) + ', ''', '')\n+ (' + ''' + replace(STRING_AGG(selectStatement, ', '), char(39), char(39) + char(39)) + '''')\n+ coalesce(' + '', '' + ' + CASE WHEN iteration = 0 THEN min(replaceStart) + ''''\n+ replace('@{replace(pipeline().parameters.c_partition_formula, '''', '''''')}', char(39), char(39) + char(39)) + '''' + min(replaceEnd) ELSE '''@{pipeline().parameters.c_trg_alias}.@{pipeline().parameters.c_trg_partition_col}''' END + ' + '' as @{pipeline().parameters.c_trg_partition_col}''', '')\n+ @{if(empty(pipeline().parameters.c_trg_cdc_col), '', concat(''' + '''', cast(''''''''', variables('v_cdc'), ''''''''' as datetime2) as ', pipeline().parameters.c_trg_cdc_col, ''''''''))}\n+ coalesce(' + '' from ' + CASE WHEN iteration = 0 THEN '' ELSE '@{concat(pipeline().parameters.c_trg_schema, '.', pipeline().parameters.c_trg_object, ' as ', pipeline().parameters.c_trg_alias)} ' END + replace(STRING_AGG(coalesce(coalesce(joinType + ' join ', '') + fromStatement, '')\n+ coalesce(' on ' +  joinStatement, ''), ' '), char(39), char(39) + char(39)) + '''', '')\n+ coalesce(' + '' where (' + replace(STRING_AGG(whereStatement, ' or ') + CASE WHEN iteration = 0 THEN '' ELSE ' or @{pipeline().parameters.c_trg_alias}.@{pipeline().parameters.c_trg_cdc_col} = ''@{variables('v_cdc')}''' END, char(39), char(39) + char(39)) + ')''', '') as sourceQuery,\n'''select distinct(''' + coalesce(' + ' + CASE WHEN iteration = 0 THEN min(replaceStart) + '''' + replace('@{replace(pipeline().parameters.c_partition_formula, '''', '''''')}', char(39), char(39) + char(39)) + '''' + min(replaceEnd) ELSE '''_stg._PARTITION''' END + ' + '') as _PARTITION''', '') \n+ coalesce(' + '' from ' + CASE WHEN iteration = 0 THEN '' ELSE '@{concat(pipeline().parameters.c_trg_schema, '.', pipeline().parameters.c_trg_object, ' as ', pipeline().parameters.c_trg_alias)} ' END + replace(STRING_AGG(coalesce(coalesce(joinType + ' join ', '') + fromStatement, '')\n+ coalesce(' on ' +  joinStatement, ''), ' '), char(39), char(39) + char(39)) + '''', '')\n+ coalesce(' + '' where (' + replace(STRING_AGG(whereStatement, ' or ') + CASE WHEN iteration = 0 THEN '' ELSE ' or @{pipeline().parameters.c_trg_alias}.@{pipeline().parameters.c_trg_cdc_col} = ''@{variables('v_cdc')}''' END, char(39), char(39) + char(39)) + ')''', '') as pruningQuery\nFROM OPENJSON('@{replace(string(activity('SourceQueryParts').output.resultSets[0].rows), '''', '''''')}')\nWITH (\n    iteration integer '$.iteration',\n    object NVARCHAR(max) '$.object',\n    alias NVARCHAR(max) '$.alias',\n    trgKeyCol NVARCHAR(max) '$.trgKeyCol',\n    cdcCol NVARCHAR(max) '$.cdcCol',\n    selectCols NVARCHAR(max) '$.selectCols',\n    joinCondition NVARCHAR(max) '$.joinCondition',\n    joinType NVARCHAR(max) '$.joinType',\n    joinOrder integer '$.joinOrder',\n    replaceStart NVARCHAR(max) '$.replaceStart',\n    replaceEnd NVARCHAR(max) '$.replaceEnd',\n    keyColsStatement NVARCHAR(max) '$.keyColsStatement',\n    selectStatement NVARCHAR(max) '$.selectStatement',\n    fromStatement NVARCHAR(max) '$.fromStatement',\n    joinStatement NVARCHAR(max) '$.joinStatement',\n    whereStatement NVARCHAR(max) '$.whereStatement')\ngroup by iteration\n) q\n\nexec(@SQLScript)",
										"type": "Expression"
									}
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					},
					{
						"name": "Set v_cdc",
						"type": "SetVariable",
						"dependsOn": [],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_cdc",
							"value": {
								"value": "@utcNow()",
								"type": "Expression"
							}
						}
					},
					{
						"name": "ForEachIteration",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "SourceQuery",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "EnrichedLakeSettings",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@activity('SourceQuery').output.resultSets[0].rows",
								"type": "Expression"
							},
							"isSequential": true,
							"activities": [
								{
									"name": "FromDeltaToWideDelta",
									"type": "ExecuteDataFlow",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"dataflow": {
											"referenceName": "FromDeltaToWideDelta",
											"type": "DataFlowReference",
											"parameters": {
												"c_trg_object": {
													"value": "'@{pipeline().parameters.c_trg_object}'",
													"type": "Expression"
												},
												"c_trg_container": {
													"value": "'@{pipeline().parameters.c_trg_container}'",
													"type": "Expression"
												},
												"c_trg_root_folder": {
													"value": "'@{pipeline().parameters.c_trg_root_folder}'",
													"type": "Expression"
												},
												"p_keyCols": {
													"value": "'@{item().keyCols}'",
													"type": "Expression"
												},
												"p_source_query": {
													"value": "@concat('\"', item().sourceQuery, '\"')",
													"type": "Expression"
												},
												"p_pruning_query": {
													"value": "@concat('\"', item().pruningQuery, '\"')",
													"type": "Expression"
												},
												"c_trg_partition_col": {
													"value": "'@{pipeline().parameters.c_trg_partition_col}'",
													"type": "Expression"
												},
												"p_iteration": {
													"value": "@item().iteration",
													"type": "Expression"
												}
											},
											"datasetParameters": {
												"sourceWide": {
													"p_database": {
														"value": "@pipeline().parameters.c_serverless_db",
														"type": "Expression"
													},
													"p_schema": "dbo",
													"p_table": "dummy"
												},
												"sourcePartitionPruning": {
													"p_database": {
														"value": "@pipeline().parameters.c_serverless_db",
														"type": "Expression"
													},
													"p_schema": "dbo",
													"p_table": "dummy"
												},
												"sinkWide": {},
												"sinkPartitionPruning": {}
											}
										},
										"staging": {},
										"compute": {
											"coreCount": 8,
											"computeType": "General"
										},
										"traceLevel": "Fine"
									}
								},
								{
									"name": "CreateTargetView",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "FromDeltaToWideDelta",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "create or alter view @{pipeline().parameters.c_trg_schema}.@{pipeline().parameters.c_trg_object} as\nselect * from OPENROWSET(\n        BULK '@{activity('EnrichedLakeSettings').output.properties.typeProperties.url}@{if(endswith(activity('EnrichedLakeSettings').output.properties.typeProperties.url, '/'), '', '/')}@{pipeline().parameters.c_trg_container}/@{pipeline().parameters.c_trg_root_folder}/@{pipeline().parameters.c_trg_object}/',\n        FORMAT = 'DELTA'\n    ) AS [result]",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_src_objects": {
						"type": "array",
						"defaultValue": [
							{
								"iteration": 0,
								"object": "dataflows_datasets_REST_API",
								"schema": "enr",
								"alias": "dataflows_datasets",
								"trgKeyCol": "name,propertiestypePropertiessourcesdatasetreferenceName",
								"cdcCol": "enrTimestamp",
								"selectCols": "*",
								"joinCondition": null,
								"joinType": null,
								"joinOrder": 0
							},
							{
								"iteration": 0,
								"object": "dataflows_REST_API",
								"schema": "enr",
								"alias": "dataflows",
								"trgKeyCol": null,
								"cdcCol": "enrTimestamp",
								"selectCols": "*",
								"joinCondition": "dataflows.name = dataflows_datasets.name",
								"joinType": "left outer",
								"joinOrder": 1
							},
							{
								"iteration": 0,
								"object": "datasets_REST_API",
								"schema": "enr",
								"alias": "datasets",
								"trgKeyCol": null,
								"cdcCol": "enrTimestamp",
								"selectCols": "*",
								"joinCondition": "datasets.name = dataflows_datasets.propertiestypePropertiessourcesdatasetreferenceName",
								"joinType": "left outer",
								"joinOrder": 2
							}
						]
					},
					"p_datetime_from": {
						"type": "string"
					},
					"c_trg_object": {
						"type": "string",
						"defaultValue": "dataflows_datasets_WIDE"
					},
					"c_trg_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_trg_root_folder": {
						"type": "string",
						"defaultValue": "FromDeltaToWideDelta"
					},
					"c_serverless_db": {
						"type": "string",
						"defaultValue": "templateDB"
					},
					"c_trg_schema": {
						"type": "string",
						"defaultValue": "enr"
					},
					"c_partition_formula": {
						"type": "string",
						"defaultValue": "dataflows_datasets_REST_API.DELTA_PARTITION"
					},
					"c_trg_partition_col": {
						"type": "string",
						"defaultValue": "_PARTITION"
					},
					"c_trg_cdc_col": {
						"type": "string",
						"defaultValue": "_DSS_UPDATE_TIME"
					},
					"c_trg_alias": {
						"type": "string",
						"defaultValue": "_stg"
					},
					"c_trg_linked_service": {
						"type": "string",
						"defaultValue": "templateenrst_ARIR"
					}
				},
				"variables": {
					"v_master_query_parts": {
						"type": "Array"
					},
					"v_slave_row_count": {
						"type": "Integer"
					},
					"v_cdc": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:45:16Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericEnrichedJsonFolder')]",
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]",
				"[concat(variables('workspaceId'), '/dataflows/FromDeltaToWideDelta')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromJsonToDeltaParquet')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "ForEachDataset",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "GenericRawJson linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericEnrichedParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "Set v_dss_update_time",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@pipeline().parameters.p_datasets",
								"type": "Expression"
							},
							"isSequential": false,
							"activities": [
								{
									"name": "copyFileList",
									"type": "Copy",
									"dependsOn": [
										{
											"activity": "DatetimeFrom",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "SqlDWSource",
											"sqlReaderQuery": {
												"value": "@concat('SELECT STRING_AGG(cast(jsonName as varchar(max)), char(10)) ListOfFiles ',\n        'FROM ( SELECT right(result.filepath(), ',\n        'len(result.filepath()) - charindex(''', \n        pipeline().parameters.c_raw_root_folder, \n        ''', result.filepath()) + 1) jsonName, max(',\n        item().keyCol, ') ', item().keyCol, ' FROM OPENROWSET(',\n        'BULK ''', activity('GenericRawJson linked service').output.properties.typeProperties.url, \n        pipeline().parameters.c_raw_container, '/', \n        pipeline().parameters.c_raw_root_folder, '/',\n        item().target, '/*.json'',  FORMAT = ''CSV'', FIELDQUOTE = ''0x0b'', ',\n        'FIELDTERMINATOR =''0x0b'', ROWTERMINATOR = ''\\n'') ',\n        'WITH (jsonContent nvarchar(MAX)) ',\n        'AS [result] CROSS apply ',\n        'openjson(JSON_QUERY(jsonContent, ''$.value'')) ',\n        'WITH (', item().keyCol, ' nvarchar(1000) ''$.\"',\n        item().keyCol, '\"'') WHERE reverse(substring(reverse(result.filepath()), 1, charindex(''/'', reverse(result.filepath())) - 1))',\n        if(\n                not(empty(pipeline().parameters.p_datetime_to)), \n                ' between ',\n                ' >= '\n        ),\n        '''', item().target, '_', \n        activity('DatetimeFrom').output.resultSets[0].rows[0].CDCTimestamp, '.json''',\n        if(not(empty(pipeline().parameters.p_datetime_to)), \n            concat(' and ''', item().target, '_', \n                replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_to, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ), \n                '.json'''\n            ), \n            ''\n        ), \n        ' GROUP BY result.filepath()) q'\n)",
												"type": "Expression"
											},
											"queryTimeout": "02:00:00",
											"partitionOption": "None"
										},
										"sink": {
											"type": "DelimitedTextSink",
											"storeSettings": {
												"type": "AzureBlobFSWriteSettings"
											},
											"formatSettings": {
												"type": "DelimitedTextWriteSettings",
												"quoteAllText": true,
												"fileExtension": ".txt"
											}
										},
										"enableStaging": false,
										"translator": {
											"type": "TabularTranslator",
											"mappings": [
												{
													"source": {
														"name": "ListOfFiles",
														"physicalType": "nvarchar"
													},
													"sink": {
														"ordinal": 1
													}
												}
											],
											"typeConversion": true,
											"typeConversionSettings": {
												"allowDataTruncation": true,
												"treatBooleanAsNumber": false
											}
										}
									},
									"inputs": [
										{
											"referenceName": "GenericServerlessSQL",
											"type": "DatasetReference",
											"parameters": {
												"p_database": {
													"value": "@pipeline().parameters.c_serverless_db",
													"type": "Expression"
												},
												"p_schema": "dummy",
												"p_table": "master"
											}
										}
									],
									"outputs": [
										{
											"referenceName": "GenericRawCSV_NoHeaderNoQuote",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_monitoring_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
													"type": "Expression"
												},
												"p_file": {
													"value": "@pipeline().parameters.c_file_list_blob",
													"type": "Expression"
												}
											}
										}
									]
								},
								{
									"name": "countRows",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "DatetimeFrom",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": "master"
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@concat('select count(*) countRows FROM OPENROWSET(',\n        'BULK ''', activity('GenericRawJson linked service').output.properties.typeProperties.url, \n        pipeline().parameters.c_raw_container, '/', \n        pipeline().parameters.c_raw_root_folder, '/',\n        item().target, '/*.json'',  FORMAT = ''CSV'', FIELDQUOTE = ''0x0b'', ',\n        'FIELDTERMINATOR =''0x0b'', ROWTERMINATOR = ''\\n'') ',\n        'WITH (jsonContent nvarchar(MAX)) ',\n        'AS [result] CROSS apply ',\n        'openjson(JSON_QUERY(jsonContent, ''$.value'')) ',\n        'WITH (', item().keyCol, ' nvarchar(1000) ''$.\"',\n        item().keyCol, '\"'')  WHERE reverse(substring(reverse(result.filepath()), 1, charindex(''/'', reverse(result.filepath())) - 1))',\n        if(not(empty(pipeline().parameters.p_datetime_to)), \n           ' between ',\n           ' >= '),\n        '''', item().target, '_', \n        activity('DatetimeFrom').output.resultSets[0].rows[0].CDCTimestamp, '.json''',\n        if(not(empty(pipeline().parameters.p_datetime_to)), \n            concat(' and ''', item().target, '_', \n                replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_to, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ), \n                '.json'''\n            ), \n            ''\n        )\n)",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "switchTypes",
									"type": "Switch",
									"dependsOn": [
										{
											"activity": "copyFileList",
											"dependencyConditions": [
												"Succeeded"
											]
										},
										{
											"activity": "countRows",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"on": {
											"value": "@if(greater(activity('countRows').output.resultSets[0].rows[0].countRows, 0),\nitem().type, 'none')",
											"type": "Expression"
										},
										"cases": [
											{
												"value": "relationsMM",
												"activities": [
													{
														"name": "FromJsonToDeltaParquet_RelationsMM",
														"type": "ExecuteDataFlow",
														"dependsOn": [],
														"policy": {
															"timeout": "0.12:00:00",
															"retry": 2,
															"retryIntervalInSeconds": 30,
															"secureOutput": false,
															"secureInput": false
														},
														"userProperties": [],
														"typeProperties": {
															"dataflow": {
																"referenceName": "FromJsonToDeltaParquet_RelationsMM",
																"type": "DataFlowReference",
																"parameters": {
																	"c_target_container": {
																		"value": "'@{pipeline().parameters.c_enriched_container}'",
																		"type": "Expression"
																	},
																	"c_target_folder": {
																		"value": "'@{concat(pipeline().parameters.c_enriched_root_folder, '/',\nitem().target)}'",
																		"type": "Expression"
																	},
																	"c_key_column_name": {
																		"value": "'@{item().keyCol}'",
																		"type": "Expression"
																	},
																	"c_cdc_column_name": {
																		"value": "'@{coalesce(item().cdcCol, 'fileName')}'",
																		"type": "Expression"
																	},
																	"c_enriched_cdc_column": {
																		"value": "'@{pipeline().parameters.c_enriched_cdc_column}'",
																		"type": "Expression"
																	},
																	"c_relation_column_name": {
																		"value": "'@{item().relCol}'",
																		"type": "Expression"
																	},
																	"p_partition_formula": {
																		"value": "@concat('\"', item().partitionFormula, '\"')",
																		"type": "Expression"
																	},
																	"p_dss_update_time": {
																		"value": "'@{formatDateTime(variables('v_dss_update_time'), 'yyyy-MM-ddTHH:mm:ssZ')}'",
																		"type": "Expression"
																	},
																	"c_raw_cdc_column": {
																		"value": "'@{pipeline().parameters.c_raw_cdc_column}'",
																		"type": "Expression"
																	}
																},
																"datasetParameters": {
																	"RawDataset": {
																		"p_container": {
																			"value": "@pipeline().parameters.c_raw_monitoring_container",
																			"type": "Expression"
																		},
																		"p_folder": {
																			"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/', \npipeline().parameters.c_raw_root_folder, '/',\nitem().target)",
																			"type": "Expression"
																		},
																		"p_file": {
																			"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																			"type": "Expression"
																		}
																	},
																	"PartitionPruning": {
																		"p_container": {
																			"value": "@pipeline().parameters.c_raw_monitoring_container",
																			"type": "Expression"
																		},
																		"p_folder": {
																			"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/', \npipeline().parameters.c_raw_root_folder, '/',\nitem().target)",
																			"type": "Expression"
																		},
																		"p_file": {
																			"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																			"type": "Expression"
																		}
																	},
																	"dummyPartitionPruning": {
																		"p_database": "master",
																		"p_schema": "dummy",
																		"p_table": "dummy"
																	},
																	"EnrichedDeltaLake": {},
																	"sinkPartitionPruning": {}
																}
															},
															"staging": {},
															"compute": {
																"coreCount": 8,
																"computeType": "General"
															},
															"traceLevel": "Fine"
														}
													}
												]
											},
											{
												"value": "relations11",
												"activities": [
													{
														"name": "FromJsonToDeltaParquet_Relations11",
														"type": "ExecuteDataFlow",
														"dependsOn": [],
														"policy": {
															"timeout": "0.12:00:00",
															"retry": 2,
															"retryIntervalInSeconds": 30,
															"secureOutput": false,
															"secureInput": false
														},
														"userProperties": [],
														"typeProperties": {
															"dataflow": {
																"referenceName": "FromJsonToDeltaParquet_Relations11",
																"type": "DataFlowReference",
																"parameters": {
																	"c_target_container": {
																		"value": "'@{pipeline().parameters.c_enriched_container}'",
																		"type": "Expression"
																	},
																	"c_target_folder": {
																		"value": "'@{concat(pipeline().parameters.c_enriched_root_folder, '/',\nitem().target)}'",
																		"type": "Expression"
																	},
																	"c_key_column_name": {
																		"value": "'@{item().keyCol}'",
																		"type": "Expression"
																	},
																	"c_cdc_column_name": {
																		"value": "'@{coalesce(item().cdcCol, 'fileName')}'",
																		"type": "Expression"
																	},
																	"c_enriched_cdc_column": {
																		"value": "'@{pipeline().parameters.c_enriched_cdc_column}'",
																		"type": "Expression"
																	},
																	"p_partition_formula": {
																		"value": "@concat('\"', item().partitionFormula, '\"')",
																		"type": "Expression"
																	},
																	"p_dss_update_time": {
																		"value": "'@{formatDateTime(variables('v_dss_update_time'), 'yyyy-MM-ddTHH:mm:ssZ')}'",
																		"type": "Expression"
																	},
																	"c_raw_cdc_column": {
																		"value": "'@{pipeline().parameters.c_raw_cdc_column}'",
																		"type": "Expression"
																	}
																},
																"datasetParameters": {
																	"RawDataset": {
																		"p_container": {
																			"value": "@pipeline().parameters.c_raw_monitoring_container",
																			"type": "Expression"
																		},
																		"p_folder": {
																			"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/', \npipeline().parameters.c_raw_root_folder, '/',\nitem().target)",
																			"type": "Expression"
																		},
																		"p_file": {
																			"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																			"type": "Expression"
																		}
																	},
																	"PartitionPruning": {
																		"p_container": {
																			"value": "@pipeline().parameters.c_raw_monitoring_container",
																			"type": "Expression"
																		},
																		"p_folder": {
																			"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/', \npipeline().parameters.c_raw_root_folder, '/',\nitem().target)",
																			"type": "Expression"
																		},
																		"p_file": {
																			"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																			"type": "Expression"
																		}
																	},
																	"dummyPartitionPruning": {
																		"p_database": "master",
																		"p_schema": "dummy",
																		"p_table": "dummy"
																	},
																	"EnrichedDeltaLake": {},
																	"sinkPartitionPruning": {}
																}
															},
															"staging": {},
															"compute": {
																"coreCount": 8,
																"computeType": "General"
															},
															"traceLevel": "Fine"
														}
													}
												]
											},
											{
												"value": "basic",
												"activities": [
													{
														"name": "FromJsonToDeltaParquet_Basic",
														"type": "ExecuteDataFlow",
														"dependsOn": [],
														"policy": {
															"timeout": "0.12:00:00",
															"retry": 2,
															"retryIntervalInSeconds": 30,
															"secureOutput": false,
															"secureInput": false
														},
														"userProperties": [],
														"typeProperties": {
															"dataflow": {
																"referenceName": "FromJsonToDeltaParquet_Basic",
																"type": "DataFlowReference",
																"parameters": {
																	"c_target_container": {
																		"value": "'@{pipeline().parameters.c_enriched_container}'",
																		"type": "Expression"
																	},
																	"c_target_folder": {
																		"value": "'@{concat(pipeline().parameters.c_enriched_root_folder, '/',\nitem().target)}'",
																		"type": "Expression"
																	},
																	"c_key_column_name": {
																		"value": "'@{item().keyCol}'",
																		"type": "Expression"
																	},
																	"c_cdc_column_name": {
																		"value": "'@{coalesce(item().cdcCol, 'fileName')}'",
																		"type": "Expression"
																	},
																	"c_enriched_cdc_column": {
																		"value": "'@{pipeline().parameters.c_enriched_cdc_column}'",
																		"type": "Expression"
																	},
																	"p_partition_formula": {
																		"value": "@concat('\"', item().partitionFormula, '\"')",
																		"type": "Expression"
																	},
																	"p_dss_update_time": {
																		"value": "'@{formatDateTime(variables('v_dss_update_time'), 'yyyy-MM-ddTHH:mm:ssZ')}'",
																		"type": "Expression"
																	},
																	"c_raw_cdc_column": {
																		"value": "'@{pipeline().parameters.c_raw_cdc_column}'",
																		"type": "Expression"
																	}
																},
																"datasetParameters": {
																	"RawDataset": {
																		"p_container": {
																			"value": "@pipeline().parameters.c_raw_monitoring_container",
																			"type": "Expression"
																		},
																		"p_folder": {
																			"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
																			"type": "Expression"
																		},
																		"p_file": {
																			"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																			"type": "Expression"
																		}
																	},
																	"PartitionPruning": {
																		"p_container": {
																			"value": "@pipeline().parameters.c_raw_monitoring_container",
																			"type": "Expression"
																		},
																		"p_folder": {
																			"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
																			"type": "Expression"
																		},
																		"p_file": {
																			"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																			"type": "Expression"
																		}
																	},
																	"dummyPartitionPruning": {
																		"p_database": "master",
																		"p_schema": "dummy",
																		"p_table": "dummy"
																	},
																	"EnrichedDeltaLake": {},
																	"sinkPartitionPruning": {}
																}
															},
															"staging": {},
															"compute": {
																"coreCount": 8,
																"computeType": "General"
															},
															"traceLevel": "Fine"
														}
													}
												]
											}
										]
									}
								},
								{
									"name": "If dataTypeReplace not empty",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "If RowCount not Zero",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@and(not(empty(item().dataTypeReplace)),\ngreater(activity('countRows').output.resultSets[0].rows[0].countRows, 0))",
											"type": "Expression"
										},
										"ifTrueActivities": [
											{
												"name": "Generate SQL",
												"type": "Script",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": {
															"value": "@pipeline().parameters.c_serverless_db",
															"type": "Expression"
														}
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "select 'create or alter view  \n@{concat(if(empty(pipeline().parameters.c_enriched_schema), '', concat(pipeline().parameters.c_enriched_schema, '.')), item().target)}\nas select * from OPENROWSET(\n      BULK ''@{activity('GenericEnrichedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_enriched_container}/@{pipeline().parameters.c_enriched_root_folder}/@{item().target}'',\t\n\tFORMAT = ''Delta''\n) WITH (' +\nSTRING_AGG('[' + \ncast(colName as varchar(max)) + '] ' + \ndataType, ',' + char(10)) \nWITHIN GROUP (ORDER BY column_id ASC) +\n') as r' as SQL\nfrom (select \nc.name colName, coalesce(r.dataType,\nCASE \n      WHEN t.[name] IN ('varchar', 'char', 'varbinary') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length AS VARCHAR(25))) + ')' \n      WHEN t.[name] IN ('nvarchar','nchar') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length / 2 AS VARCHAR(25)))+ ')'      \n      WHEN t.[name] IN ('decimal', 'numeric') THEN t.[name] + '(' + CAST(c.[precision] AS VARCHAR(25)) + ', ' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      WHEN t.[name] IN ('datetime2') THEN t.[name] + '(' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      ELSE t.[name]\nEND) AS dataType,\nc.column_id\nfrom sys.columns c\njoin sys.views v on v.object_id = c.object_id\njoin sys.schemas s on s.schema_id = v.schema_id\njoin sys.types t on c.user_type_id = t.user_type_id \nleft outer join (select * from OpenJson(N'@{item().dataTypeReplace}')\nWITH (col varchar(255), dataType varchar(255)) as r) r\non r.col = c.name\nwhere s.name = '@{pipeline().parameters.c_enriched_schema}' and v.name = '@{item().target}') q",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											},
											{
												"name": "rebuildView",
												"type": "Script",
												"dependsOn": [
													{
														"activity": "Generate SQL",
														"dependencyConditions": [
															"Succeeded"
														]
													}
												],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": {
															"value": "@pipeline().parameters.c_serverless_db",
															"type": "Expression"
														}
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "NonQuery",
															"text": {
																"value": "@activity('Generate SQL').output.resultSets[0].rows[0].SQL",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											}
										]
									}
								},
								{
									"name": "DatetimeFrom",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@if(and(empty(pipeline().parameters.p_datetime_from),\n        not(empty(pipeline().parameters.c_raw_cdc_column))\n    ),\n    concat('if exists (select 1 from sys.columns c join sys.views v on v.object_id = c.object_id join sys.schemas s on s.schema_id = v.schema_id where s.name = ''', pipeline().parameters.c_enriched_schema, ''' and v.name = ''', item().target, ''' and c.name = ''', pipeline().parameters.c_raw_cdc_column, ''') ',\n        'exec(''select dateadd(mcs, 1, cast(max(', pipeline().parameters.c_raw_cdc_column, ') as datetime2)) CDCTimestamp from ',\n        if(empty(pipeline().parameters.c_enriched_schema), '', concat(pipeline().parameters.c_enriched_schema, '.')), item().target,\n        ''') else select ''1900-01-01'' as CDCTimestamp'\n    ),\n    concat('select ''', replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_from, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ),\n        ''' as CDCTimestamp'\n    )\n)",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "If RowCount not Zero",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "switchTypes",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@greater(activity('countRows').output.resultSets[0].rows[0].countRows, 0)",
											"type": "Expression"
										},
										"ifTrueActivities": [
											{
												"name": "createView",
												"type": "Script",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": {
															"value": "@pipeline().parameters.c_serverless_db",
															"type": "Expression"
														}
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "create or alter view \n@{if(empty(pipeline().parameters.c_enriched_schema), item().target, concat(pipeline().parameters.c_enriched_schema, '.', item().target))}\nas select * from OPENROWSET(\n\tBULK '@{activity('GenericEnrichedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_enriched_container}/@{pipeline().parameters.c_enriched_root_folder}/@{item().target}',\n\tFORMAT = 'Delta'\n) as r",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											}
										]
									}
								}
							]
						}
					},
					{
						"name": "GenericRawJson attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericRawJson?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericRawJson linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericRawJson attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericRawJson attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericEnrichedParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericEnrichedParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericEnrichedParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericEnrichedParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericEnrichedParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "Set v_dss_update_time",
						"type": "SetVariable",
						"dependsOn": [],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_dss_update_time",
							"value": {
								"value": "@utcNow()",
								"type": "Expression"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"type": "basic",
								"target": "dataflows_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": [
									{
										"col": "type",
										"dataType": "nvarchar(200)"
									}
								],
								"relCol": null,
								"partitionFormula": "'dummy'"
							},
							{
								"type": "basic",
								"target": "datasets_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": [
									{
										"col": "type",
										"dataType": "nvarchar(200)"
									}
								],
								"relCol": null,
								"partitionFormula": "'dummy'"
							},
							{
								"type": "relationsMM",
								"target": "dataflows_datasets_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": null,
								"relCol": "properties.typeProperties.sources.dataset.referenceName",
								"partitionFormula": "'dummy'"
							},
							{
								"type": "relations11",
								"target": "datasets_relations11_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": null,
								"relCol": null,
								"partitionFormula": "'dummy'"
							}
						]
					},
					"p_datetime_from": {
						"type": "string"
					},
					"p_datetime_to": {
						"type": "string"
					},
					"c_raw_root_folder": {
						"type": "string",
						"defaultValue": "FromRESTAPIToJson"
					},
					"c_raw_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_enriched_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_enriched_root_folder": {
						"type": "string",
						"defaultValue": "FromJsonToDeltaParquet"
					},
					"c_file_list_blob": {
						"type": "string",
						"defaultValue": "fileList"
					},
					"c_serverless_db": {
						"type": "string",
						"defaultValue": "templateDB"
					},
					"c_raw_monitoring_folder": {
						"type": "string",
						"defaultValue": "PipelineMonitoring"
					},
					"c_external_data_source": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_enriched_schema": {
						"type": "string",
						"defaultValue": "enr"
					},
					"c_enriched_cdc_column": {
						"type": "string",
						"defaultValue": "enrTimestamp"
					},
					"c_raw_monitoring_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_raw_cdc_column": {
						"type": "string",
						"defaultValue": "rawTimestamp"
					}
				},
				"variables": {
					"v_datetime_from": {
						"type": "String"
					},
					"v_datetime_to": {
						"type": "String"
					},
					"v_array": {
						"type": "Array"
					},
					"v_array_tmp": {
						"type": "Array"
					},
					"v_string": {
						"type": "String"
					},
					"v_dss_update_time": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:45:19Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/datasets/GenericRawCSV_NoHeaderNoQuote')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]",
				"[concat(variables('workspaceId'), '/dataflows/FromJsonToDeltaParquet_RelationsMM')]",
				"[concat(variables('workspaceId'), '/dataflows/FromJsonToDeltaParquet_Relations11')]",
				"[concat(variables('workspaceId'), '/dataflows/FromJsonToDeltaParquet_Basic')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromParquetToDeltaParquet')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "ForEachDataset",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "GenericRawParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "Set v_dss_update_time",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericEnrichedParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@pipeline().parameters.p_datasets",
								"type": "Expression"
							},
							"isSequential": false,
							"activities": [
								{
									"name": "copyFileList",
									"type": "Copy",
									"dependsOn": [
										{
											"activity": "DatetimeFrom",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "SqlDWSource",
											"sqlReaderQuery": {
												"value": "@concat('SELECT STRING_AGG(cast(parquetName as varchar(max)), char(10)) ListOfFiles ',\n        'FROM ( SELECT right(result.filepath(), ',\n        'len(result.filepath()) - charindex(''', \n        pipeline().parameters.c_raw_root_folder, \n        ''', result.filepath()) + 1) parquetName, max(',\n        first(item().keyCol), ') ', first(item().keyCol), ' FROM OPENROWSET(',\n        'BULK ''', activity('GenericRawParquet linked service').output.properties.typeProperties.url, \n        pipeline().parameters.c_raw_container, '/', \n        pipeline().parameters.c_raw_root_folder, '/',\n        if(equals(length(item().target), 0), item().sourceObject, item().target), '/*.parquet'',  FORMAT = ''PARQUET'') ',\n        'AS [result] WHERE reverse(substring(reverse(result.filepath()), 1, charindex(''/'', reverse(result.filepath())) - 1))',\n        if(\n                not(empty(pipeline().parameters.p_datetime_to)), \n                ' between ',\n                ' >= '\n        ),\n        '''', if(equals(length(item().target), 0), item().sourceObject, item().target), if(empty(item().cdcCol), '', concat('_', activity('DatetimeFrom').output.resultSets[0].rows[0].CDCTimestamp)), '.parquet''',\n        if(not(empty(pipeline().parameters.p_datetime_to)), \n            concat(' and ''', if(equals(length(item().target), 0), item().sourceObject, item().target), '_', \n                replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_to, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ), \n                '.parquet'''\n            ), \n            ''\n        ), \n        ' GROUP BY result.filepath()) q'\n)",
												"type": "Expression"
											},
											"queryTimeout": "02:00:00",
											"partitionOption": "None"
										},
										"sink": {
											"type": "DelimitedTextSink",
											"storeSettings": {
												"type": "AzureBlobFSWriteSettings"
											},
											"formatSettings": {
												"type": "DelimitedTextWriteSettings",
												"quoteAllText": true,
												"fileExtension": ".txt"
											}
										},
										"enableStaging": false,
										"translator": {
											"type": "TabularTranslator",
											"mappings": [
												{
													"source": {
														"name": "ListOfFiles",
														"physicalType": "nvarchar"
													},
													"sink": {
														"ordinal": 1
													}
												}
											],
											"typeConversion": true,
											"typeConversionSettings": {
												"allowDataTruncation": true,
												"treatBooleanAsNumber": false
											}
										}
									},
									"inputs": [
										{
											"referenceName": "GenericServerlessSQL",
											"type": "DatasetReference",
											"parameters": {
												"p_database": "master",
												"p_schema": "dummy",
												"p_table": "dummy"
											}
										}
									],
									"outputs": [
										{
											"referenceName": "GenericRawCSV_NoHeaderNoQuote",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_monitoring_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
													"type": "Expression"
												},
												"p_file": {
													"value": "@concat(pipeline().parameters.c_file_list_blob)",
													"type": "Expression"
												}
											}
										}
									]
								},
								{
									"name": "countRows",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "DatetimeFrom",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": "master"
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@concat('select count(*) countRows FROM OPENROWSET(',\n        'BULK ''', activity('GenericRawParquet linked service').output.properties.typeProperties.url, \n        pipeline().parameters.c_raw_container, '/', \n        pipeline().parameters.c_raw_root_folder, '/',\n        if(equals(length(item().target), 0), item().sourceObject, item().target), '/*.parquet'',  FORMAT = ''PARQUET'') ', 'AS [result] WHERE reverse(substring(reverse(result.filepath()), 1, charindex(''/'', reverse(result.filepath())) - 1))',\n        if(not(empty(pipeline().parameters.p_datetime_to)), \n           ' between ',\n           ' >= '),\n        '''', if(equals(length(item().target), 0), item().sourceObject, item().target), if(empty(item().cdcCol), '', concat('_', activity('DatetimeFrom').output.resultSets[0].rows[0].CDCTimestamp)), '.parquet''',\n        if(not(empty(pipeline().parameters.p_datetime_to)), \n            concat(' and ''', if(equals(length(item().target), 0), item().sourceObject, item().target), '_', \n                replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_to, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ), \n                '.parquet'''\n            ), \n            ''\n        )\n)",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "If dataTypeReplace not empty",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "If RowCount not Zero",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@and(not(empty(item().dataTypeReplace)),\ngreater(activity('countRows').output.resultSets[0].rows[0].countRows, 0))",
											"type": "Expression"
										},
										"ifTrueActivities": [
											{
												"name": "Generate SQL",
												"type": "Script",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": "ICP_Data_Store"
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "select 'create or alter view  \n@{concat(if(empty(pipeline().parameters.c_enriched_schema), '', concat(pipeline().parameters.c_enriched_schema, '.')), item().target)}\nas select * from OPENROWSET(\n      BULK ''@{activity('GenericEnrichedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_enriched_container}/@{pipeline().parameters.c_enriched_root_folder}/@{item().target}'', \t\n\tFORMAT = ''Delta''\n) WITH (' +\nSTRING_AGG('[' + \ncast(colName as varchar(max)) + '] ' + \ndataType, ',' + char(10)) \nWITHIN GROUP (ORDER BY column_id ASC) +\n') as r' as SQL\nfrom (select \nc.name colName, coalesce(r.dataType,\nCASE \n      WHEN t.[name] IN ('varchar', 'char', 'varbinary') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length AS VARCHAR(25))) + ')' \n      WHEN t.[name] IN ('nvarchar','nchar') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length / 2 AS VARCHAR(25)))+ ')'      \n      WHEN t.[name] IN ('decimal', 'numeric') THEN t.[name] + '(' + CAST(c.[precision] AS VARCHAR(25)) + ', ' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      WHEN t.[name] IN ('datetime2') THEN t.[name] + '(' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      ELSE t.[name]\nEND) AS dataType,\nc.column_id\nfrom sys.columns c\njoin sys.views v on v.object_id = c.object_id\njoin sys.schemas s on s.schema_id = v.schema_id\njoin sys.types t on c.user_type_id = t.user_type_id \nleft outer join (select * from OpenJson(N'@{item().dataTypeReplace}')\nWITH (col varchar(255), dataType varchar(255)) as r) r\non r.col = c.name\nwhere s.name = '@{pipeline().parameters.c_enriched_schema}' and v.name = '@{item().target}') q",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											},
											{
												"name": "rebuildView",
												"type": "Script",
												"dependsOn": [
													{
														"activity": "Generate SQL",
														"dependencyConditions": [
															"Succeeded"
														]
													}
												],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": "ICP_Data_Store"
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "NonQuery",
															"text": {
																"value": "@activity('Generate SQL').output.resultSets[0].rows[0].SQL",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											}
										]
									}
								},
								{
									"name": "DatetimeFrom",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@if(and(empty(pipeline().parameters.p_datetime_from),\n        not(empty(pipeline().parameters.c_raw_cdc_column))\n    ),\n    concat('if exists (select 1 from sys.columns c join sys.views v on v.object_id = c.object_id join sys.schemas s on s.schema_id = v.schema_id where s.name = ''', pipeline().parameters.c_enriched_schema, ''' and v.name = ''', item().target, ''' and c.name = ''', pipeline().parameters.c_raw_cdc_column, ''') ',\n        'exec(''select dateadd(mcs, 1, cast(max(', pipeline().parameters.c_raw_cdc_column, ') as datetime2)) CDCTimestamp from ',\n        if(empty(pipeline().parameters.c_enriched_schema), '', concat(pipeline().parameters.c_enriched_schema, '.')), item().target,\n        ''') else select ''1900-01-01'' as CDCTimestamp'\n    ),\n    concat('select ''', replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_from, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ),\n        ''' as CDCTimestamp'\n    )\n)",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "If RowCount not Zero",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "copyFileList",
											"dependencyConditions": [
												"Succeeded"
											]
										},
										{
											"activity": "countRows",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@greater(activity('countRows').output.resultSets[0].rows[0].countRows, 0)",
											"type": "Expression"
										},
										"ifTrueActivities": [
											{
												"name": "createView",
												"type": "Script",
												"dependsOn": [
													{
														"activity": "FromParquetToDeltaParquet",
														"dependencyConditions": [
															"Succeeded"
														]
													}
												],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": {
															"value": "@pipeline().parameters.c_serverless_db",
															"type": "Expression"
														}
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "create or alter view \n@{if(empty(pipeline().parameters.c_enriched_schema), item().target, concat(pipeline().parameters.c_enriched_schema, '.', item().target))}\nas select * from OPENROWSET(\n\tBULK '@{activity('GenericEnrichedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_enriched_container}/@{pipeline().parameters.c_enriched_root_folder}/@{item().target}', \t\n\tFORMAT = 'Delta'\n) as r",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											},
											{
												"name": "FromParquetToDeltaParquet",
												"type": "ExecuteDataFlow",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"dataflow": {
														"referenceName": "FromParquetToDeltaParquet",
														"type": "DataFlowReference",
														"parameters": {
															"c_target_container": {
																"value": "'@{pipeline().parameters.c_enriched_container}'",
																"type": "Expression"
															},
															"c_key_column_name": {
																"value": "@item().keyCol",
																"type": "Expression"
															},
															"c_raw_cdc_column": {
																"value": "'@{pipeline().parameters.c_raw_cdc_column}'",
																"type": "Expression"
															},
															"p_dss_update_time": {
																"value": "'@{formatDateTime(variables('v_dss_update_time'), 'yyyy-MM-ddTHH:mm:ssZ')}'",
																"type": "Expression"
															},
															"c_enr_cdc_column": {
																"value": "'@{pipeline().parameters.c_enr_cdc_column}'",
																"type": "Expression"
															},
															"p_partition_formula": {
																"value": "@concat('\"', item().partitionFormula, '\"')",
																"type": "Expression"
															},
															"c_target_root_folder": {
																"value": "'@{pipeline().parameters.c_enriched_root_folder}'",
																"type": "Expression"
															},
															"p_object": {
																"value": "'@{item().target}'",
																"type": "Expression"
															},
															"p_processing_mode": {
																"value": "'@{item().processingMode}'",
																"type": "Expression"
															}
														},
														"datasetParameters": {
															"RawDataset": {
																"p_container": {
																	"value": "@pipeline().parameters.c_raw_monitoring_container",
																	"type": "Expression"
																},
																"p_folder": {
																	"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
																	"type": "Expression"
																},
																"p_file": {
																	"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																	"type": "Expression"
																}
															},
															"RawPartitionPruning": {
																"p_container": {
																	"value": "@pipeline().parameters.c_raw_monitoring_container",
																	"type": "Expression"
																},
																"p_folder": {
																	"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
																	"type": "Expression"
																},
																"p_file": {
																	"value": "@concat(pipeline().parameters.c_file_list_blob, '.csv')",
																	"type": "Expression"
																}
															},
															"dummyPartitionPruning": {
																"p_database": "master",
																"p_schema": "dummy",
																"p_table": "dummy"
															},
															"EnrichedDeltaLake": {},
															"sinkPartitionPruning": {}
														}
													},
													"staging": {},
													"compute": {
														"coreCount": 8,
														"computeType": "General"
													},
													"traceLevel": "Fine"
												}
											}
										]
									}
								}
							]
						}
					},
					{
						"name": "GenericRawParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericRawParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericRawParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericRawParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericRawParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "Set v_dss_update_time",
						"type": "SetVariable",
						"dependsOn": [],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_dss_update_time",
							"value": {
								"value": "@utcNow()",
								"type": "Expression"
							}
						}
					},
					{
						"name": "GenericEnrichedParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericEnrichedParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericEnrichedParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericEnrichedParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericEnrichedParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"sourceObject": "dataflows_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_SQL",
								"processingMode": "bulk",
								"cdcCol": "",
								"keyCol": [
									"name"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							},
							{
								"sourceObject": "datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "datasets_SQL",
								"processingMode": "bulk",
								"cdcCol": "",
								"keyCol": [
									"name"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							},
							{
								"sourceObject": "datasets_relations11_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "datasets_relations11_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp",
								"keyCol": [
									"name"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							},
							{
								"sourceObject": "dataflows_datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_datasets_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp",
								"keyCol": [
									"name",
									"propertiestypePropertiessourcesdatasetreferenceName"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							}
						]
					},
					"p_datetime_from": {
						"type": "string"
					},
					"p_datetime_to": {
						"type": "string"
					},
					"c_raw_root_folder": {
						"type": "string",
						"defaultValue": "FromSQLToParquet"
					},
					"c_raw_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_enriched_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_enriched_root_folder": {
						"type": "string",
						"defaultValue": "FromParquetToDeltaParquet"
					},
					"c_file_list_blob": {
						"type": "string",
						"defaultValue": "fileList"
					},
					"c_serverless_db": {
						"type": "string",
						"defaultValue": "templateDB"
					},
					"c_raw_monitoring_folder": {
						"type": "string",
						"defaultValue": "PipelineMonitoring"
					},
					"c_enriched_schema": {
						"type": "string",
						"defaultValue": "enr"
					},
					"c_enr_cdc_column": {
						"type": "string",
						"defaultValue": "enrTimestamp_ParquetToDeltaParquet"
					},
					"c_raw_monitoring_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_raw_cdc_column": {
						"type": "string",
						"defaultValue": "rawTimestamp_ParquetToDeltaParquet"
					}
				},
				"variables": {
					"v_datetime_from": {
						"type": "String"
					},
					"v_datetime_to": {
						"type": "String"
					},
					"v_array": {
						"type": "Array"
					},
					"v_array_tmp": {
						"type": "Array"
					},
					"v_string": {
						"type": "String"
					},
					"v_dss_update_time": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:45:23Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/datasets/GenericRawCSV_NoHeaderNoQuote')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]",
				"[concat(variables('workspaceId'), '/dataflows/FromParquetToDeltaParquet')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromRESTAPIToJson')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "ForEachDataset",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "Set v_datetime_to",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericRawJson linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@pipeline().parameters.p_datasets",
								"type": "Expression"
							},
							"isSequential": false,
							"activities": [
								{
									"name": "CopyDataset",
									"type": "Copy",
									"dependsOn": [
										{
											"activity": "ReadMonitoringBlob",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "7.00:00:00",
										"retry": 3,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "RestSource",
											"httpRequestTimeout": "00:01:40",
											"requestInterval": "00.00:00:00.010",
											"requestMethod": "GET"
										},
										"sink": {
											"type": "JsonSink",
											"storeSettings": {
												"type": "AzureBlobFSWriteSettings"
											},
											"formatSettings": {
												"type": "JsonWriteSettings"
											}
										},
										"enableStaging": false
									},
									"inputs": [
										{
											"referenceName": "azuresynapse",
											"type": "DatasetReference",
											"parameters": {
												"p_workspace": {
													"value": "@pipeline().DataFactory",
													"type": "Expression"
												},
												"p_relative_url": {
													"value": "@if(\n    and(\n        item().delta, \n        equals(length(activity('ReadMonitoringBlob').output.firstRow.DeltaLink), 0)\n    ),\n    concat(item().path, \n        item().source, \n        '/delta',\n        if(\n            and(\n                empty(item().select), \n                empty(item().filter)), '',\n            concat('?', item().select, item().filter)\n        )\n    ), \n    if(\n        item().delta,\n        activity('ReadMonitoringBlob').output.firstRow.DeltaLink,\n        concat(\n            item().path, \n            item().source, \n            if(\n                and(\n                    empty(item().select), \n                    and(empty(item().filter), empty(item().cdcCol))), '',\n                concat('?', \n                    if(empty(item().select), '', concat(item().select, '&')),\n                    if(empty(item().filter),\n                        if(not(empty(item().cdcCol)), '$filter=', ''),\n                        if(not(empty(item().cdcCol)), concat(item().filter, '&'), item().filter)\n                    ),\n                    if(and(not(item().delta), not(empty(item().cdcCol))),\n                        concat('(DateModified gt ',\n                            formatDateTime(\n                                if(empty(pipeline().parameters.p_datetime_from),\n                                    addHours(\n                                        activity('ReadMonitoringBlob').output.firstRow.CDCTimestamp,\n                                        pipeline().parameters.c_cdc_offset_hr\n                                    ),                                        \n                                    pipeline().parameters.p_datetime_from\n                                ),\n                            'yyyy-MM-ddTHH:mm:ss.fffffffZ'),\n                            ' and DateModified le ',\n                            formatDateTime(\n                                variables('v_datetime_to'), \n                                'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                            ), ')'\n                        ), ''\n                    )\n                )\n            )\n        )\n    )\n)",
													"type": "Expression"
												}
											}
										}
									],
									"outputs": [
										{
											"referenceName": "GenericRawJson",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_root_folder, '/',\nif(equals(length(item().target), 0), item().source, item().target))",
													"type": "Expression"
												},
												"p_file": {
													"value": "@concat(if(\n    equals(length(item().target), 0), item().source, item().target),\n    '_', variables('v_cdc_timestamp'))",
													"type": "Expression"
												}
											}
										}
									]
								},
								{
									"name": "CheckPipelineMonitoringBlob",
									"type": "GetMetadata",
									"dependsOn": [],
									"policy": {
										"timeout": "7.00:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"dataset": {
											"referenceName": "GenericRawJson",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_monitoring_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
													"type": "Expression"
												},
												"p_file": {
													"value": "@item().target",
													"type": "Expression"
												}
											}
										},
										"fieldList": [
											"exists",
											"lastModified"
										],
										"storeSettings": {
											"type": "AzureBlobFSReadSettings",
											"recursive": true,
											"enablePartitionDiscovery": false
										},
										"formatSettings": {
											"type": "JsonReadSettings"
										}
									}
								},
								{
									"name": "If Monitoring Blob Exists",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "CheckPipelineMonitoringBlob",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@activity('CheckPipelineMonitoringBlob').output.exists",
											"type": "Expression"
										},
										"ifFalseActivities": [
											{
												"name": "CopyDefaultMonitoringData",
												"type": "Copy",
												"dependsOn": [],
												"policy": {
													"timeout": "7.00:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"source": {
														"type": "JsonSource",
														"additionalColumns": [
															{
																"name": "PipelineName",
																"value": {
																	"value": "@pipeline().Pipeline",
																	"type": "Expression"
																}
															},
															{
																"name": "BlobRootDirectory",
																"value": {
																	"value": "@concat(pipeline().parameters.c_raw_root_folder)",
																	"type": "Expression"
																}
															},
															{
																"name": "DatetimeFrom",
																"value": ""
															},
															{
																"name": "DatetimeTo",
																"value": ""
															},
															{
																"name": "CDCTimestamp",
																"value": {
																	"value": "@concat('1900-01-01')",
																	"type": "Expression"
																}
															},
															{
																"name": "CurrentUTC",
																"value": {
																	"value": "@utcnow()",
																	"type": "Expression"
																}
															},
															{
																"name": "DeltaLink",
																"value": ""
															},
															{
																"name": "RowCount",
																"value": ""
															}
														],
														"storeSettings": {
															"type": "AzureBlobFSReadSettings",
															"recursive": true,
															"enablePartitionDiscovery": false
														},
														"formatSettings": {
															"type": "JsonReadSettings"
														}
													},
													"sink": {
														"type": "JsonSink",
														"storeSettings": {
															"type": "AzureBlobFSWriteSettings"
														},
														"formatSettings": {
															"type": "JsonWriteSettings"
														}
													},
													"enableStaging": false
												},
												"inputs": [
													{
														"referenceName": "DummyJson",
														"type": "DatasetReference",
														"parameters": {}
													}
												],
												"outputs": [
													{
														"referenceName": "GenericRawJson",
														"type": "DatasetReference",
														"parameters": {
															"p_container": {
																"value": "@pipeline().parameters.c_raw_monitoring_container",
																"type": "Expression"
															},
															"p_folder": {
																"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
																"type": "Expression"
															},
															"p_file": {
																"value": "@item().target",
																"type": "Expression"
															}
														}
													}
												]
											}
										]
									}
								},
								{
									"name": "ReadMonitoringBlob",
									"type": "Lookup",
									"dependsOn": [
										{
											"activity": "If Monitoring Blob Exists",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "JsonSource",
											"storeSettings": {
												"type": "AzureBlobFSReadSettings",
												"recursive": false,
												"enablePartitionDiscovery": false
											},
											"formatSettings": {
												"type": "JsonReadSettings"
											}
										},
										"dataset": {
											"referenceName": "GenericRawJson",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_monitoring_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
													"type": "Expression"
												},
												"p_file": {
													"value": "@item().target",
													"type": "Expression"
												}
											}
										}
									}
								},
								{
									"name": "countRows",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "CopyDataset",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": "master"
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "SELECT count(@{if(empty(item().crossApplyField), concat('JSON_VALUE (jsonContent, ''$.', item().keyCol, ''')'), 'keyColumn')}) countRows\n   FROM OPENROWSET(\n          BULK '@{activity('GenericRawJson linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_raw_container}/@{pipeline().parameters.c_raw_root_folder}/@{item().target}/@{concat(if(equals(length(item().target), 0), item().source, item().target), '_', variables('v_cdc_timestamp'))}.json', \n          FORMAT = 'CSV', FIELDQUOTE = '0x0b', FIELDTERMINATOR ='0x0b', ROWTERMINATOR = '\\n') \n          WITH (jsonContent varchar(MAX)) AS [result]\n@{if(empty(item().crossApplyField), '', concat(' cross apply openjson(JSON_QUERY(jsonContent, ''$.', item().crossApplyField, ''')) with (keyColumn varchar(100) ''$.', item().keyCol, ''')'))}\n",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "If RowCount not zero",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "countRows",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@greater(\n    activity('countRows').output.resultSets[0].rows[0].countRows,\n    0)",
											"type": "Expression"
										},
										"ifFalseActivities": [
											{
												"name": "Delete Blob with no Data",
												"type": "Delete",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"dataset": {
														"referenceName": "GenericRawJson",
														"type": "DatasetReference",
														"parameters": {
															"p_container": {
																"value": "@pipeline().parameters.c_raw_container",
																"type": "Expression"
															},
															"p_folder": {
																"value": "@concat(pipeline().parameters.c_raw_root_folder, '/',\nif(equals(length(item().target), 0), item().source, item().target))",
																"type": "Expression"
															},
															"p_file": {
																"value": "@concat(if(\n    equals(length(item().target), 0), item().source, item().target),\n    '_', variables('v_cdc_timestamp'))",
																"type": "Expression"
															}
														}
													},
													"enableLogging": false,
													"storeSettings": {
														"type": "AzureBlobFSReadSettings",
														"recursive": false,
														"enablePartitionDiscovery": false
													}
												}
											}
										],
										"ifTrueActivities": [
											{
												"name": "GetIncrementalReference",
												"type": "Script",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": "master"
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "@if(item().delta,\n   concat('SELECT deltaLink FROM OPENROWSET(BULK ''',\n      activity('GenericRawJson linked service').output.properties.typeProperties.url,\n      pipeline().parameters.c_raw_container, '/',\n      pipeline().parameters.c_raw_root_folder, '/',\n      item().target, '/',\n      if(equals(length(item().target), 0), item().source, item().target),\n      '_', variables('v_cdc_timestamp'), '.json', \n      ''', FORMAT = ''CSV'', FIELDQUOTE = ''0x0b'', ',\n      'FIELDTERMINATOR =''0x0b'', ROWTERMINATOR = ''\\n'') ',\n      'WITH (jsonContent nvarchar(MAX)) AS [result] ',\n      'cross apply openjson(jsonContent) with (deltaLink varchar(max) ',\n      '''$.\"', pipeline().parameters.c_delta_link_field, '\"'') ',\n      'where deltaLink is not null'\n   ),\n   'SELECT '''' as deltaLink'\n)",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											},
											{
												"name": "CopyMonitoringData",
												"type": "Copy",
												"dependsOn": [
													{
														"activity": "GetIncrementalReference",
														"dependencyConditions": [
															"Succeeded"
														]
													},
													{
														"activity": "GetCDCTimeStamp",
														"dependencyConditions": [
															"Succeeded"
														]
													}
												],
												"policy": {
													"timeout": "7.00:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"source": {
														"type": "JsonSource",
														"additionalColumns": [
															{
																"name": "PipelineName",
																"value": {
																	"value": "@pipeline().Pipeline",
																	"type": "Expression"
																}
															},
															{
																"name": "BlobRootDirectory",
																"value": {
																	"value": "@concat(pipeline().parameters.c_raw_root_folder)",
																	"type": "Expression"
																}
															},
															{
																"name": "DatetimeFrom",
																"value": {
																	"value": "@pipeline().parameters.p_datetime_from",
																	"type": "Expression"
																}
															},
															{
																"name": "DatetimeTo",
																"value": {
																	"value": "@pipeline().parameters.p_datetime_to",
																	"type": "Expression"
																}
															},
															{
																"name": "CDCTimestamp",
																"value": {
																	"value": "@if(\n    greaterOrEquals(\n        formatDateTime(\n            variables('v_datetime_to'), \n            'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n        ), \n        activity('GetCDCTimeStamp').output.resultSets[0].rows[0].CDCTimestamp\n    ),\n    activity('GetCDCTimeStamp').output.resultSets[0].rows[0].CDCTimestamp,\n    activity('ReadMonitoringBlob').output.firstRow.CDCTimestamp\n)\n",
																	"type": "Expression"
																}
															},
															{
																"name": "CurrentUTC",
																"value": {
																	"value": "@utcnow()",
																	"type": "Expression"
																}
															},
															{
																"name": "DeltaLink",
																"value": {
																	"value": "@activity('GetIncrementalReference').output.resultSets[0].rows[0].deltaLink",
																	"type": "Expression"
																}
															},
															{
																"name": "RowCount",
																"value": {
																	"value": "@activity('countRows').output.resultSets[0].rows[0].countRows",
																	"type": "Expression"
																}
															}
														],
														"storeSettings": {
															"type": "AzureBlobFSReadSettings",
															"recursive": true,
															"enablePartitionDiscovery": false
														},
														"formatSettings": {
															"type": "JsonReadSettings"
														}
													},
													"sink": {
														"type": "JsonSink",
														"storeSettings": {
															"type": "AzureBlobFSWriteSettings"
														},
														"formatSettings": {
															"type": "JsonWriteSettings"
														}
													},
													"enableStaging": false
												},
												"inputs": [
													{
														"referenceName": "DummyJson",
														"type": "DatasetReference",
														"parameters": {}
													}
												],
												"outputs": [
													{
														"referenceName": "GenericRawJson",
														"type": "DatasetReference",
														"parameters": {
															"p_container": {
																"value": "@pipeline().parameters.c_raw_monitoring_container",
																"type": "Expression"
															},
															"p_folder": {
																"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    item().target)",
																"type": "Expression"
															},
															"p_file": {
																"value": "@item().target",
																"type": "Expression"
															}
														}
													}
												]
											},
											{
												"name": "GetCDCTimeStamp",
												"type": "Script",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": "master"
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "@if(or(item().delta, empty(item().cdcCol)),\n   concat('SELECT ''', variables('v_cdc_timestamp'), ''' as CDCTimestamp'),\n   concat('SELECT max(CDCTimestamp) CDCTimestamp ',\n      'FROM OPENROWSET(BULK ''',\n      activity('GenericRawJson linked service').output.properties.typeProperties.url,\n      pipeline().parameters.c_raw_container, '/',\n      pipeline().parameters.c_raw_root_folder, '/',\n      item().target, '/',\n      if(equals(length(item().target), 0), item().source, item().target),\n      '_', variables('v_cdc_timestamp'), '.json', \n      ''', FORMAT = ''CSV'', FIELDQUOTE = ''0x0b'', ',\n      'FIELDTERMINATOR =''0x0b'', ROWTERMINATOR = ''\\n'') ',\n      'WITH (jsonContent nvarchar(MAX)) AS [result] ',\n      'cross apply openjson(JSON_QUERY(jsonContent, ''$.value'')) ',\n      ' WITH (CDCTimestamp nvarchar(max) ''$.\"', item().cdcCol, '\"'')'\n   )\n)",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											}
										]
									}
								}
							]
						}
					},
					{
						"name": "Set v_cdc_timestamp",
						"type": "SetVariable",
						"dependsOn": [],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_cdc_timestamp",
							"value": {
								"value": "@if(empty(pipeline().parameters.c_cdc_timestamp), utcNow(),\npipeline().parameters.c_cdc_timestamp)",
								"type": "Expression"
							}
						}
					},
					{
						"name": "Set v_datetime_to",
						"type": "SetVariable",
						"dependsOn": [
							{
								"activity": "Set v_cdc_timestamp",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_datetime_to",
							"value": {
								"value": "@if(empty(pipeline().parameters.p_datetime_to),\nvariables('v_cdc_timestamp'),\npipeline().parameters.p_datetime_to)",
								"type": "Expression"
							}
						}
					},
					{
						"name": "GenericRawJson attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericRawJson?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericRawJson linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericRawJson attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericRawJson attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"source": "dataflows",
								"target": "dataflows_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": null
							},
							{
								"source": "datasets",
								"target": "datasets_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": null
							},
							{
								"source": "datasets",
								"target": "datasets_relations11_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": null
							},
							{
								"source": "dataflows",
								"target": "dataflows_datasets_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": "properties.typeProperties.sources.dataset.referenceName"
							}
						]
					},
					"c_raw_root_folder": {
						"type": "string",
						"defaultValue": "FromRESTAPIToJson"
					},
					"c_raw_monitoring_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_raw_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"p_datetime_from": {
						"type": "string"
					},
					"p_datetime_to": {
						"type": "string"
					},
					"c_raw_monitoring_folder": {
						"type": "string",
						"defaultValue": "PipelineMonitoring"
					},
					"c_delta_link_field": {
						"type": "string"
					},
					"c_cdc_timestamp": {
						"type": "string"
					},
					"c_cdc_offset_hr": {
						"type": "int",
						"defaultValue": 0
					}
				},
				"variables": {
					"v_cdc_timestamp": {
						"type": "String"
					},
					"v_datetime_to": {
						"type": "String"
					},
					"v_monitor": {
						"type": "String"
					},
					"v_test": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:44:28Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/datasets/azuresynapse')]",
				"[concat(variables('workspaceId'), '/datasets/GenericRawJson')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]",
				"[concat(variables('workspaceId'), '/datasets/DummyJson')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromSQLtoRawParquet')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "ForEach in p_datasets",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "Set v_cdc_timestamp",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericRawParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@pipeline().parameters.p_datasets",
								"type": "Expression"
							},
							"activities": [
								{
									"name": "CopyDataset",
									"type": "Copy",
									"dependsOn": [
										{
											"activity": "ReadMonitoringBlob",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "SqlDWSource",
											"sqlReaderQuery": {
												"value": "select * from @{item().sourceSchema}.@{item().sourceObject}\n@{if(equals(item().processingMode, 'bulk'), '', concat(' where ', item().cdcCol, ' > ''', if(and(empty(pipeline().parameters.p_datetime_from), empty(pipeline().parameters.p_datetime_to)), activity('ReadMonitoringBlob').output.firstRow.CDCTimestamp, if(and(empty(pipeline().parameters.p_datetime_from), not(empty(pipeline().parameters.p_datetime_to))), '1900-01-01', pipeline().parameters.p_datetime_from)), ''''))}\n@{if(equals(item().processingMode, 'bulk'), '', concat(' and ', item().cdcCol, ' <= ''', if(empty(pipeline().parameters.p_datetime_to), '9999-12-31', pipeline().parameters.p_datetime_to), ''''))}\n@{if(equals(length(item().whereStatement), 0), '', concat(if(equals(item().processingMode, 'bulk'), ' where ', ' and '), item().whereStatement))}",
												"type": "Expression"
											},
											"queryTimeout": "02:00:00",
											"partitionOption": "None"
										},
										"sink": {
											"type": "ParquetSink",
											"storeSettings": {
												"type": "AzureBlobFSWriteSettings"
											},
											"formatSettings": {
												"type": "ParquetWriteSettings"
											}
										},
										"enableStaging": false,
										"translator": {
											"type": "TabularTranslator",
											"typeConversion": true,
											"typeConversionSettings": {
												"allowDataTruncation": true,
												"treatBooleanAsNumber": false
											}
										}
									},
									"inputs": [
										{
											"referenceName": "GenericServerlessSQL",
											"type": "DatasetReference",
											"parameters": {
												"p_database": {
													"value": "@pipeline().parameters.c_sql_db",
													"type": "Expression"
												},
												"p_schema": {
													"value": "@item().sourceSchema",
													"type": "Expression"
												},
												"p_table": {
													"value": "@item().sourceObject",
													"type": "Expression"
												}
											}
										}
									],
									"outputs": [
										{
											"referenceName": "GenericRawParquet",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_root_folder, '/', if(equals(length(item().target), 0), item().source, item().target))",
													"type": "Expression"
												},
												"p_file": {
													"value": "@concat(if(equals(length(item().target), 0), item().sourceObject, item().target), if(equals(item().processingMode, 'bulk'), '', concat('_', variables('v_cdc_timestamp'))))",
													"type": "Expression"
												}
											}
										}
									]
								},
								{
									"name": "CheckMonitoringBlob",
									"type": "GetMetadata",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"dataset": {
											"referenceName": "GenericRawJson",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_monitoring_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
													"type": "Expression"
												},
												"p_file": {
													"value": "@if(equals(length(item().target), 0), item().sourceObject, item().target)",
													"type": "Expression"
												}
											}
										},
										"fieldList": [
											"exists"
										],
										"storeSettings": {
											"type": "AzureBlobFSReadSettings",
											"recursive": true,
											"enablePartitionDiscovery": false
										},
										"formatSettings": {
											"type": "JsonReadSettings"
										}
									}
								},
								{
									"name": "IfMonitoringBlobExists",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "CheckMonitoringBlob",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@activity('CheckMonitoringBlob').output.exists",
											"type": "Expression"
										},
										"ifFalseActivities": [
											{
												"name": "CopyDefaultMonitoringBlob",
												"type": "Copy",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"source": {
														"type": "JsonSource",
														"additionalColumns": [
															{
																"name": "pipelineName",
																"value": {
																	"value": "@pipeline().Pipeline",
																	"type": "Expression"
																}
															},
															{
																"name": "blobDirectory",
																"value": {
																	"value": "@concat(pipeline().parameters.c_raw_root_folder, '/', item().sourceObject)",
																	"type": "Expression"
																}
															},
															{
																"name": "datetimeFrom",
																"value": ""
															},
															{
																"name": "datetimeTo",
																"value": ""
															},
															{
																"name": "CDCTimestamp",
																"value": "1900-01-01"
															},
															{
																"name": "currentUTC",
																"value": {
																	"value": "@utcNow()",
																	"type": "Expression"
																}
															},
															{
																"name": "deltaLink",
																"value": ""
															},
															{
																"name": "rowCount",
																"value": ""
															}
														],
														"storeSettings": {
															"type": "AzureBlobFSReadSettings",
															"recursive": true,
															"enablePartitionDiscovery": false
														},
														"formatSettings": {
															"type": "JsonReadSettings"
														}
													},
													"sink": {
														"type": "JsonSink",
														"storeSettings": {
															"type": "AzureBlobFSWriteSettings"
														},
														"formatSettings": {
															"type": "JsonWriteSettings"
														}
													},
													"enableStaging": false
												},
												"inputs": [
													{
														"referenceName": "DummyJson",
														"type": "DatasetReference",
														"parameters": {}
													}
												],
												"outputs": [
													{
														"referenceName": "GenericRawJson",
														"type": "DatasetReference",
														"parameters": {
															"p_container": {
																"value": "@pipeline().parameters.c_raw_monitoring_container",
																"type": "Expression"
															},
															"p_folder": {
																"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
																"type": "Expression"
															},
															"p_file": {
																"value": "@if(equals(length(item().target), 0), item().sourceObject, item().target)",
																"type": "Expression"
															}
														}
													}
												]
											}
										]
									}
								},
								{
									"name": "ReadMonitoringBlob",
									"type": "Lookup",
									"dependsOn": [
										{
											"activity": "IfMonitoringBlobExists",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "JsonSource",
											"storeSettings": {
												"type": "AzureBlobFSReadSettings",
												"recursive": true,
												"enablePartitionDiscovery": false
											},
											"formatSettings": {
												"type": "JsonReadSettings"
											}
										},
										"dataset": {
											"referenceName": "GenericRawJson",
											"type": "DatasetReference",
											"parameters": {
												"p_container": {
													"value": "@pipeline().parameters.c_raw_monitoring_container",
													"type": "Expression"
												},
												"p_folder": {
													"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
													"type": "Expression"
												},
												"p_file": {
													"value": "@if(equals(length(item().target), 0), item().sourceObject, item().target)",
													"type": "Expression"
												}
											}
										}
									}
								},
								{
									"name": "IfRowsCopiedNotZero",
									"type": "IfCondition",
									"dependsOn": [
										{
											"activity": "CopyDataset",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"expression": {
											"value": "@greater(activity('CopyDataset').output.rowsCopied, 0)",
											"type": "Expression"
										},
										"ifFalseActivities": [
											{
												"name": "DeleteBlob",
												"type": "Delete",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"dataset": {
														"referenceName": "GenericRawParquet",
														"type": "DatasetReference",
														"parameters": {
															"p_container": {
																"value": "@pipeline().parameters.c_raw_container",
																"type": "Expression"
															},
															"p_folder": {
																"value": "@concat(pipeline().parameters.c_raw_root_folder, '/', item().sourceObject)",
																"type": "Expression"
															},
															"p_file": {
																"value": "@concat(if(equals(length(item().target), 0), item().sourceObject, item().target), if(equals(item().processingMode, 'bulk'), '', concat('_', variables('v_cdc_timestamp'))))",
																"type": "Expression"
															}
														}
													},
													"enableLogging": false,
													"storeSettings": {
														"type": "AzureBlobFSReadSettings",
														"recursive": true,
														"enablePartitionDiscovery": false
													}
												}
											}
										],
										"ifTrueActivities": [
											{
												"name": "GetCDCTimeStamp",
												"type": "Script",
												"dependsOn": [],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"linkedServiceName": {
													"referenceName": "serverless_ARIR",
													"type": "LinkedServiceReference",
													"parameters": {
														"p_database": "master"
													}
												},
												"typeProperties": {
													"scripts": [
														{
															"type": "Query",
															"text": {
																"value": "@if(or(equals(item().processingMode, 'bulk'), not(empty(pipeline().parameters.p_datetime_to))), concat('select ''', activity('ReadMonitoringBlob').output.firstRow.CDCTimestamp, ''' CDCTimestamp'), concat('select max(', item().cdcCol, ') CDCTimestamp from OPENROWSET(BULK ''', activity('GenericRawParquet linked service').output.properties.typeProperties.url, pipeline().parameters.c_raw_container, '/', pipeline().parameters.c_raw_root_folder, '/', if(equals(length(item().target), 0), item().sourceObject, item().target), '/', if(equals(length(item().target), 0), item().sourceObject, item().target), if(equals(item().processingMode, 'bulk'), '', concat('_', variables('v_cdc_timestamp'))), '.parquet'', FORMAT = ''PARQUET'') as r'))",
																"type": "Expression"
															}
														}
													],
													"scriptBlockExecutionTimeout": "02:00:00"
												}
											},
											{
												"name": "CopyMonitoringBlob",
												"type": "Copy",
												"dependsOn": [
													{
														"activity": "GetCDCTimeStamp",
														"dependencyConditions": [
															"Succeeded"
														]
													}
												],
												"policy": {
													"timeout": "0.12:00:00",
													"retry": 2,
													"retryIntervalInSeconds": 30,
													"secureOutput": false,
													"secureInput": false
												},
												"userProperties": [],
												"typeProperties": {
													"source": {
														"type": "JsonSource",
														"additionalColumns": [
															{
																"name": "pipelineName",
																"value": {
																	"value": "@pipeline().Pipeline",
																	"type": "Expression"
																}
															},
															{
																"name": "blobDirectory",
																"value": {
																	"value": "@concat(pipeline().parameters.c_raw_root_folder, '/', item().sourceObject)",
																	"type": "Expression"
																}
															},
															{
																"name": "datetimeFrom",
																"value": {
																	"value": "@pipeline().parameters.p_datetime_from",
																	"type": "Expression"
																}
															},
															{
																"name": "datetimeTo",
																"value": {
																	"value": "@pipeline().parameters.p_datetime_to",
																	"type": "Expression"
																}
															},
															{
																"name": "CDCTimestamp",
																"value": {
																	"value": "@if(empty(pipeline().parameters.p_datetime_to), activity('GetCDCTimeStamp').output.resultSets[0].rows[0].CDCTimestamp, activity('ReadMonitoringBlob').output.firstRow.CDCTimestamp)",
																	"type": "Expression"
																}
															},
															{
																"name": "currentUTC",
																"value": {
																	"value": "@utcnow()",
																	"type": "Expression"
																}
															},
															{
																"name": "deltaLink",
																"value": ""
															},
															{
																"name": "rowCount",
																"value": {
																	"value": "@activity('CopyDataset').output.rowsCopied",
																	"type": "Expression"
																}
															}
														],
														"storeSettings": {
															"type": "AzureBlobFSReadSettings",
															"recursive": true,
															"enablePartitionDiscovery": false
														},
														"formatSettings": {
															"type": "JsonReadSettings"
														}
													},
													"sink": {
														"type": "JsonSink",
														"storeSettings": {
															"type": "AzureBlobFSWriteSettings"
														},
														"formatSettings": {
															"type": "JsonWriteSettings"
														}
													},
													"enableStaging": false
												},
												"inputs": [
													{
														"referenceName": "DummyJson",
														"type": "DatasetReference",
														"parameters": {}
													}
												],
												"outputs": [
													{
														"referenceName": "GenericRawJson",
														"type": "DatasetReference",
														"parameters": {
															"p_container": {
																"value": "@pipeline().parameters.c_raw_monitoring_container",
																"type": "Expression"
															},
															"p_folder": {
																"value": "@concat(pipeline().parameters.c_raw_monitoring_folder, '/',\n    pipeline().parameters.c_raw_root_folder, '/', \n    if(equals(length(item().target), 0), item().sourceObject, item().target))",
																"type": "Expression"
															},
															"p_file": {
																"value": "@if(equals(length(item().target), 0), item().sourceObject, item().target)",
																"type": "Expression"
															}
														}
													}
												]
											}
										]
									}
								}
							]
						}
					},
					{
						"name": "Set v_cdc_timestamp",
						"type": "SetVariable",
						"dependsOn": [],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_cdc_timestamp",
							"value": {
								"value": "@utcNow()",
								"type": "Expression"
							}
						}
					},
					{
						"name": "GenericRawParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericRawParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericRawParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericRawParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericRawParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"sourceObject": "dataflows_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_SQL",
								"processingMode": "bulk",
								"cdcCol": ""
							},
							{
								"sourceObject": "datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "lower(name) like '%template%' or lower(name) like '%generic%'",
								"target": "datasets_SQL",
								"processingMode": "bulk",
								"cdcCol": ""
							},
							{
								"sourceObject": "datasets_relations11_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "datasets_relations11_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp"
							},
							{
								"sourceObject": "dataflows_datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_datasets_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp"
							}
						]
					},
					"c_raw_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_raw_root_folder": {
						"type": "string",
						"defaultValue": "FromSQLToParquet"
					},
					"p_datetime_from": {
						"type": "string"
					},
					"p_datetime_to": {
						"type": "string"
					},
					"c_raw_monitoring_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_raw_monitoring_folder": {
						"type": "string",
						"defaultValue": "PipelineMonitoring"
					},
					"c_sql_db": {
						"type": "string",
						"defaultValue": "templateDB"
					}
				},
				"variables": {
					"v_cdc_timestamp": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:44:34Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/datasets/GenericRawParquet')]",
				"[concat(variables('workspaceId'), '/datasets/GenericRawJson')]",
				"[concat(variables('workspaceId'), '/datasets/DummyJson')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SQLPoolPause')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "SQLPoolGetStatus",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 200,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://management.azure.com/subscriptions/', pipeline().parameters.p_subscription, '/resourceGroups/', pipeline().parameters.p_resourceGroup, '/providers/Microsoft.Synapse/workspaces/', pipeline().parameters.p_workspace, '/sqlPools/', pipeline().parameters.p_sqlPool, '/?api-version=2019-06-01-preview')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "AutoResolveIntegrationRuntime",
								"type": "IntegrationRuntimeReference"
							},
							"body": {
								"sku": {
									"name": "DW100c"
								}
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://management.azure.com/"
							}
						}
					},
					{
						"name": "StatusCheck",
						"type": "IfCondition",
						"dependsOn": [
							{
								"activity": "SQLPoolGetStatus",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"expression": {
								"value": "@equals(activity('SQLPoolGetStatus').output.properties.status, 'Paused')",
								"type": "Expression"
							},
							"ifFalseActivities": [
								{
									"name": "SQLPoolPause",
									"type": "WebActivity",
									"dependsOn": [],
									"policy": {
										"timeout": "7.00:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 200,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"method": "POST",
										"headers": {},
										"url": {
											"value": "@concat('https://management.azure.com/subscriptions/', pipeline().parameters.p_subscription, '/resourceGroups/', pipeline().parameters.p_resourceGroup, '/providers/Microsoft.Synapse/workspaces/', pipeline().parameters.p_workspace, '/sqlPools/', pipeline().parameters.p_sqlPool, '/pause?api-version=2019-06-01-preview')",
											"type": "Expression"
										},
										"body": {
											"value": "'{ ]'",
											"type": "Expression"
										},
										"authentication": {
											"type": "MSI",
											"resource": "https://management.azure.com/"
										}
									}
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_subscription": {
						"type": "string",
						"defaultValue": "f939f8f3-2652-4a45-88ae-78a7782ec9df"
					},
					"p_resourceGroup": {
						"type": "string",
						"defaultValue": "ivs-dwh-rg"
					},
					"p_workspace": {
						"type": "string",
						"defaultValue": "ivs-synapse"
					},
					"p_sqlPool": {
						"type": "string",
						"defaultValue": "ivs_sqlpool"
					}
				},
				"folder": {
					"name": "Scheduled"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:41:33Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SQLPoolStartStop')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"description": "Use p_action = 'resume' to start or 'pause to stop dedicated SQL pool",
				"activities": [
					{
						"name": "If not PROD",
						"type": "IfCondition",
						"dependsOn": [
							{
								"activity": "FilterSystem",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"expression": {
								"value": "@equals(activity('FilterSystem').output.FilteredItemsCount, 0)",
								"type": "Expression"
							},
							"ifFalseActivities": [
								{
									"name": "Start SQL Pool",
									"type": "WebActivity",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"method": "POST",
										"headers": {},
										"url": {
											"value": "@concat('https://management.azure.com/subscriptions/', \nactivity('FilterSystem').output.Value[0].subscriptionId, \n'/resourceGroups/', \nactivity('FilterSystem').output.Value[0].resourceGroup, \n'/providers/Microsoft.Synapse/workspaces/', \npipeline().DataFactory, \n'/sqlPools/', activity('FilterSystem').output.Value[0].sqlPool,\n'/', pipeline().parameters.p_action, '?api-version=2019-06-01-preview')",
											"type": "Expression"
										},
										"connectVia": {
											"referenceName": "SHIR",
											"type": "IntegrationRuntimeReference"
										},
										"body": "'{ }'",
										"authentication": {
											"type": "MSI",
											"resource": "https://management.azure.com/"
										}
									}
								}
							]
						}
					},
					{
						"name": "FilterSystem",
						"type": "Filter",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@pipeline().parameters.c_system_landscape",
								"type": "Expression"
							},
							"condition": {
								"value": "@equals(item().SynapseWorkspace, pipeline().DataFactory)",
								"type": "Expression"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_action": {
						"type": "string",
						"defaultValue": "pause"
					},
					"c_system_landscape": {
						"type": "array",
						"defaultValue": [
							{
								"environment": "DV",
								"SynapseWorkspace": "ivs-synapse",
								"resourceGroup": "ivs-dwh-rg",
								"subscriptionId": "f939f8f3-2652-4a45-88ae-78a7782ec9df",
								"sqlPool": "ivssql"
							}
						]
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:41:36Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ServerlessDBDeploy')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"description": "Pipeline runs automatically after release deploy to create serverless DB, master key and default credentials",
				"activities": [
					{
						"name": "ForEachServerlessDB",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "FilterKeyVault",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@pipeline().parameters.p_serverless_db",
								"type": "Expression"
							},
							"isSequential": true,
							"activities": [
								{
									"name": "MasterKeySecret",
									"type": "WebActivity",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": true,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"method": "GET",
										"headers": {},
										"url": {
											"value": "@concat(activity('FilterKeyVault').output.Value[0].properties.typeProperties.baseUrl,\n'secrets/', item().MasterKeySecret, '?api-version=7.3')",
											"type": "Expression"
										},
										"connectVia": {
											"referenceName": "SHIR",
											"type": "IntegrationRuntimeReference"
										},
										"authentication": {
											"type": "MSI",
											"resource": "https://vault.azure.net"
										}
									}
								},
								{
									"name": "ServerlessDBCreate",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "MasterKeySecret",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": "master"
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "NonQuery",
												"text": {
													"value": "if not exists (select name from sys.databases WHERE name = '@{item().serverlessDB}')\nbegin create database @{item().serverlessDB} end\n",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "ServerlessDBCredentials",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "ServerlessDBCreate",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": true
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@item().serverlessDB",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "NonQuery",
												"text": {
													"value": "IF NOT EXISTS (SELECT [name] from sys.symmetric_keys WHERE [name] = '##MS_DatabaseMasterKey##')\nBEGIN CREATE MASTER KEY ENCRYPTION BY PASSWORD = '@{activity('MasterKeySecret').output.value}' END\n\nIF NOT EXISTS (SELECT [name] from sys.database_scoped_credentials WHERE [name] = '@{item().scopedCredential}')\nBEGIN CREATE DATABASE SCOPED CREDENTIAL @{item().scopedCredential} WITH IDENTITY = 'Managed Identity'  END \n",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								}
							]
						}
					},
					{
						"name": "LinkedServiceList",
						"description": "",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, \n'.dev.azuresynapse.net/linkedservices?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net"
							}
						}
					},
					{
						"name": "FilterKeyVault",
						"type": "Filter",
						"dependsOn": [
							{
								"activity": "LinkedServiceList",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@activity('LinkedServiceList').output.value",
								"type": "Expression"
							},
							"condition": {
								"value": "@and(equals(item().properties.type, 'AzureKeyVault'), equals(item().name, pipeline().parameters.p_key_vault_linked_service))",
								"type": "Expression"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_serverless_db": {
						"type": "array",
						"defaultValue": [
							{
								"serverlessDB": "templateDB",
								"masterkeySecret": "template-sqlpool-master-key",
								"scopedCredential": "SynapseIdentity"
							}
						]
					},
					"p_key_vault_linked_service": {
						"type": "string",
						"defaultValue": "template_kv"
					}
				},
				"variables": {
					"v_test": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:42:55Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ServerlessObjectsDeploy')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "Copy SQL scripts",
						"type": "Copy",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"source": {
								"type": "RestSource",
								"httpRequestTimeout": "00:01:40",
								"requestInterval": "00.00:00:00.010",
								"requestMethod": "GET",
								"paginationRules": {
									"AbsoluteUrl": "$.nextLink"
								}
							},
							"sink": {
								"type": "ParquetSink",
								"storeSettings": {
									"type": "AzureBlobFSWriteSettings"
								},
								"formatSettings": {
									"type": "ParquetWriteSettings"
								}
							},
							"enableStaging": false,
							"translator": {
								"type": "TabularTranslator",
								"mappings": [
									{
										"source": {
											"path": "['id']"
										},
										"sink": {
											"name": "id"
										}
									},
									{
										"source": {
											"path": "['name']"
										},
										"sink": {
											"name": "name"
										}
									},
									{
										"source": {
											"path": "['type']"
										},
										"sink": {
											"name": "type"
										}
									},
									{
										"source": {
											"path": "['etag']"
										},
										"sink": {
											"name": "etag"
										}
									},
									{
										"source": {
											"path": "['properties']['folder']['name']"
										},
										"sink": {
											"name": "folderName"
										}
									},
									{
										"source": {
											"path": "['properties']['content']['query']"
										},
										"sink": {
											"name": "query"
										}
									},
									{
										"source": {
											"path": "['properties']['content']['metadata']['language']"
										},
										"sink": {
											"name": "language"
										}
									},
									{
										"source": {
											"path": "['properties']['content']['currentConnection']['databaseName']"
										},
										"sink": {
											"name": "databaseName"
										}
									},
									{
										"source": {
											"path": "['properties']['content']['currentConnection']['poolName']"
										},
										"sink": {
											"name": "poolName"
										}
									},
									{
										"source": {
											"path": "['properties']['content']['resultLimit']"
										},
										"sink": {
											"name": "resultLimit"
										}
									},
									{
										"source": {
											"path": "['properties']['type']"
										},
										"sink": {
											"name": "connectionType"
										}
									}
								],
								"collectionReference": "$['value']"
							}
						},
						"inputs": [
							{
								"referenceName": "azuresynapse",
								"type": "DatasetReference",
								"parameters": {
									"p_workspace": {
										"value": "@pipeline().DataFactory",
										"type": "Expression"
									},
									"p_relative_url": "/sqlScripts/?api-version=2020-12-01"
								}
							}
						],
						"outputs": [
							{
								"referenceName": "GenericRawParquet",
								"type": "DatasetReference",
								"parameters": {
									"p_container": {
										"value": "@pipeline().parameters.c_raw_container",
										"type": "Expression"
									},
									"p_folder": {
										"value": "@pipeline().parameters.c_raw_folder",
										"type": "Expression"
									},
									"p_file": {
										"value": "@pipeline().parameters.c_raw_file",
										"type": "Expression"
									}
								}
							}
						]
					},
					{
						"name": "Sort Scripts",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "Copy SQL scripts",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericRawParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "serverless_ARIR",
							"type": "LinkedServiceReference",
							"parameters": {
								"p_database": "master"
							}
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": {
										"value": "SELECT\n    ' ' + name as name, query\nFROM\n    OPENROWSET(\n        BULK '@{activity('GenericRawParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_raw_container}/@{pipeline().parameters.c_raw_folder}/@{pipeline().parameters.c_raw_file}.parquet',\n        FORMAT = 'PARQUET'\n    ) \nWITH (id nvarchar(1000),\nname nvarchar(255),\ntype nvarchar(100),\netag nvarchar(100),\nfolderName nvarchar(1000),\nquery nvarchar(max),\nlanguage nvarchar(100),\ndatabaseName nvarchar(100),\npoolName nvarchar(100),\nresultLimit int,\nconnectionType nvarchar(100)\n) AS [result]\nwhere left(folderName, len('@{pipeline().parameters.c_script_folder}')) = '@{pipeline().parameters.c_script_folder}'\nand charindex('@{pipeline().parameters.c_init_script_suffix}', name) > 0\n\nunion\n\nSELECT\n    name, query\nFROM\n    OPENROWSET(\n        BULK '@{activity('GenericRawParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_raw_container}/@{pipeline().parameters.c_raw_folder}/@{pipeline().parameters.c_raw_file}.parquet',\n        FORMAT = 'PARQUET'\n    ) \nWITH (id nvarchar(1000),\nname nvarchar(255),\ntype nvarchar(100),\netag nvarchar(100),\nfolderName nvarchar(1000),\nquery nvarchar(max),\nlanguage nvarchar(100),\ndatabaseName nvarchar(100),\npoolName nvarchar(100),\nresultLimit int,\nconnectionType nvarchar(100)\n) AS [result]\nwhere left(folderName, len('@{pipeline().parameters.c_script_folder}')) = '@{pipeline().parameters.c_script_folder}'\nand charindex('@{pipeline().parameters.c_init_script_suffix}', name) = 0\n\norder by name",
										"type": "Expression"
									}
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					},
					{
						"name": "ForEachScript",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "ForEachTextReplaceMap",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@variables('v_scripts')",
								"type": "Expression"
							},
							"isSequential": false,
							"activities": [
								{
									"name": "Run Init Script",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": "master"
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "NonQuery",
												"text": {
													"value": "@item().query",
													"type": "Expression"
												}
											}
										]
									}
								}
							]
						}
					},
					{
						"name": "ForEachTextReplaceMap",
						"type": "ForEach",
						"dependsOn": [
							{
								"activity": "Set v_scripts",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@json(string(pipeline().parameters.c_text_replacement))",
								"type": "Expression"
							},
							"isSequential": true,
							"activities": [
								{
									"name": "Set v_scripts_tmp Init",
									"type": "SetVariable",
									"dependsOn": [],
									"policy": {
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"variableName": "v_scripts_tmp",
										"value": {
											"value": "@replace(string(variables('v_scripts')), item().textToFind, item().textForReplace)",
											"type": "Expression"
										}
									}
								},
								{
									"name": "Update v_scripts Init",
									"type": "SetVariable",
									"dependsOn": [
										{
											"activity": "Set v_scripts_tmp Init",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"variableName": "v_scripts",
										"value": {
											"value": "@json(variables('v_scripts_tmp'))",
											"type": "Expression"
										}
									}
								}
							]
						}
					},
					{
						"name": "Set v_scripts",
						"type": "SetVariable",
						"dependsOn": [
							{
								"activity": "Sort Scripts",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_scripts",
							"value": {
								"value": "@activity('Sort Scripts').output.resultSets[0].rows",
								"type": "Expression"
							}
						}
					},
					{
						"name": "GenericRawParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericRawParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericRawParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericRawParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericRawParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"c_script_folder": {
						"type": "string",
						"defaultValue": "Serverless Deploy"
					},
					"c_raw_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_raw_folder": {
						"type": "string",
						"defaultValue": "ServerlessObjectsDeploy"
					},
					"c_raw_file": {
						"type": "string",
						"defaultValue": "sqlScripts"
					},
					"c_text_replacement": {
						"type": "array",
						"defaultValue": [
							{
								"textToFind": "{raw_storage_account}",
								"textForReplace": "ivsraw"
							},
							{
								"textToFind": "{enr_storage_account}",
								"textForReplace": "ivscur"
							},
							{
								"textToFind": "{cur_storage_account}",
								"textForReplace": "ivscur"
							}
						]
					},
					"c_init_script_suffix": {
						"type": "string",
						"defaultValue": "_Init_"
					}
				},
				"variables": {
					"v_scripts_tmp": {
						"type": "String"
					},
					"v_scripts": {
						"type": "Array"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:44:39Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/azuresynapse')]",
				"[concat(variables('workspaceId'), '/datasets/GenericRawParquet')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]",
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/StarSchemaDimension')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "StarSchemaDimension",
						"type": "ExecuteDataFlow",
						"dependsOn": [
							{
								"activity": "If Target Delta Exists",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "StarSchemaDimension",
								"type": "DataFlowReference",
								"parameters": {
									"p_src_key_cols": {
										"value": "@pipeline().parameters.p_src_key_cols",
										"type": "Expression"
									},
									"p_src_cdc_col": {
										"value": "'@{pipeline().parameters.p_src_cdc_col}'",
										"type": "Expression"
									},
									"p_surrogate_key_col": {
										"value": "'@{pipeline().parameters.p_surrogate_key_col}'",
										"type": "Expression"
									},
									"c_trg_dss_update_col": {
										"value": "'@{pipeline().parameters.c_trg_dss_update_col}'",
										"type": "Expression"
									},
									"c_trg_dss_create_col": {
										"value": "'@{pipeline().parameters.c_trg_dss_create_col}'",
										"type": "Expression"
									},
									"p_partition_formula": {
										"value": "@concat('\"', pipeline().parameters.p_partition_formula, '\"')",
										"type": "Expression"
									},
									"c_trg_partition_col": {
										"value": "'@{pipeline().parameters.c_trg_partition_col}'",
										"type": "Expression"
									},
									"p_src_schema": {
										"value": "'@{pipeline().parameters.p_src_schema}'",
										"type": "Expression"
									},
									"p_src_object": {
										"value": "'@{pipeline().parameters.p_src_object}'",
										"type": "Expression"
									},
									"p_datetime_from": {
										"value": "'@{variables('v_datetime_from')}'",
										"type": "Expression"
									},
									"p_trg_table": {
										"value": "'@{pipeline().parameters.p_trg_table}'",
										"type": "Expression"
									},
									"p_init_load": {
										"value": "@not(activity('GetTargetDeltaMetadata').output.exists)",
										"type": "Expression"
									},
									"c_trg_container": {
										"value": "'@{pipeline().parameters.c_trg_container}'",
										"type": "Expression"
									},
									"c_trg_root_folder": {
										"value": "'@{pipeline().parameters.c_trg_root_folder}'",
										"type": "Expression"
									}
								},
								"datasetParameters": {
									"DataSource": {
										"p_database": {
											"value": "@pipeline().parameters.c_serverless_db",
											"type": "Expression"
										},
										"p_schema": "dummy",
										"p_table": "dummy"
									},
									"Dimension": {
										"p_database": {
											"value": "@pipeline().parameters.c_serverless_db",
											"type": "Expression"
										},
										"p_schema": "dummy",
										"p_table": "dummy"
									},
									"DimensionMaxKey": {
										"p_database": {
											"value": "@pipeline().parameters.c_serverless_db",
											"type": "Expression"
										},
										"p_schema": "dummy",
										"p_table": "dummy"
									},
									"DimensionZeroRow": {
										"p_database": {
											"value": "@pipeline().parameters.c_serverless_db",
											"type": "Expression"
										},
										"p_schema": "dummy",
										"p_table": "dummy"
									},
									"SourcePartitionPruning": {
										"p_database": {
											"value": "@pipeline().parameters.c_serverless_db",
											"type": "Expression"
										},
										"p_schema": "dummy",
										"p_table": "dummy"
									},
									"dummyPartitionPruning": {
										"p_database": {
											"value": "@pipeline().parameters.c_serverless_db",
											"type": "Expression"
										},
										"p_schema": "dummy",
										"p_table": "dummy"
									},
									"CacheMaxKey": {},
									"sinkZeroRecord": {},
									"sinkDimension": {},
									"sinkPartitionPruning": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					},
					{
						"name": "GetTargetDeltaMetadata",
						"type": "GetMetadata",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataset": {
								"referenceName": "GenericCuratedJsonFolder",
								"type": "DatasetReference",
								"parameters": {
									"p_container": {
										"value": "@pipeline().parameters.c_trg_container",
										"type": "Expression"
									},
									"p_folder": {
										"value": "@concat(pipeline().parameters.c_trg_root_folder, '/', pipeline().parameters.p_trg_table)",
										"type": "Expression"
									}
								}
							},
							"fieldList": [
								"exists"
							],
							"storeSettings": {
								"type": "AzureBlobFSReadSettings",
								"recursive": true,
								"enablePartitionDiscovery": false
							},
							"formatSettings": {
								"type": "JsonReadSettings"
							}
						}
					},
					{
						"name": "If Target Delta Exists",
						"type": "IfCondition",
						"dependsOn": [
							{
								"activity": "GetTargetDeltaMetadata",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericCuratedParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"expression": {
								"value": "@and(activity('GetTargetDeltaMetadata').output.exists, not(empty(pipeline().parameters.p_src_cdc_col)))",
								"type": "Expression"
							},
							"ifFalseActivities": [
								{
									"name": "Set v_datetime_from False",
									"type": "SetVariable",
									"dependsOn": [],
									"policy": {
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"variableName": "v_datetime_from",
										"value": {
											"value": "@pipeline().parameters.p_datetime_from",
											"type": "Expression"
										}
									}
								}
							],
							"ifTrueActivities": [
								{
									"name": "DatetimeFrom",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@if(empty(pipeline().parameters.p_datetime_from),\n    concat('select max(', pipeline().parameters.p_src_cdc_col, ') as CDCTimestamp from openrowset( bulk ''',activity('GenericCuratedParquet linked service').output.properties.typeProperties.url, pipeline().parameters.c_trg_container, '/', pipeline().parameters.c_trg_root_folder, '/', pipeline().parameters.p_trg_table, ''', format = ''DELTA'') as result'),\n    concat('select ''', replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_from, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ),\n        ''' as CDCTimestamp'\n    )\n)",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "Set v_datetime_from True",
									"type": "SetVariable",
									"dependsOn": [
										{
											"activity": "DatetimeFrom",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"variableName": "v_datetime_from",
										"value": {
											"value": "@activity('DatetimeFrom').output.resultSets[0].rows[0].CDCTimestamp",
											"type": "Expression"
										}
									}
								}
							]
						}
					},
					{
						"name": "GenericCuratedParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericCuratedParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericCuratedParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericCuratedParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericCuratedParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "createTmpView",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "StarSchemaDimension",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 2,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "serverless_ARIR",
							"type": "LinkedServiceReference",
							"parameters": {
								"p_database": {
									"value": "@pipeline().parameters.c_serverless_db",
									"type": "Expression"
								}
							}
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": {
										"value": "create or alter view \n@{pipeline().parameters.p_trg_table}_tmp\nas select * from OPENROWSET(\n\tBULK '@{activity('GenericCuratedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_trg_container}/@{pipeline().parameters.c_trg_root_folder}/@{pipeline().parameters.p_trg_table}',\n\tFORMAT = 'Delta'\n) as r",
										"type": "Expression"
									}
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					},
					{
						"name": "ExternalTableSQL",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "createTmpView",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "serverless_ARIR",
							"type": "LinkedServiceReference",
							"parameters": {
								"p_database": {
									"value": "@pipeline().parameters.c_serverless_db",
									"type": "Expression"
								}
							}
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": {
										"value": "select 'CREATE EXTERNAL TABLE ' +\n'@{pipeline().parameters.p_trg_table} (' + \nchar(10) +\nSTRING_AGG('[' + \ncast(colName as varchar(max)) + '] ' + \ndataType, ',' + char(10)) \nWITHIN GROUP (ORDER BY column_id ASC) + char(10) +\n') WITH (LOCATION = ''@{pipeline().parameters.c_trg_root_folder}/@{pipeline().parameters.p_trg_table}'', DATA_SOURCE = @{pipeline().parameters.c_cur_data_source},  FILE_FORMAT = Delta)' as SQL\nfrom (select \nc.name colName, coalesce(r.dataType,\nCASE \n      WHEN t.[name] IN ('varchar', 'char', 'varbinary') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length AS VARCHAR(25))) + ')' \n      WHEN t.[name] IN ('nvarchar','nchar') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length / 2 AS VARCHAR(25)))+ ')'      \n      WHEN t.[name] IN ('decimal', 'numeric') THEN t.[name] + '(' + CAST(c.[precision] AS VARCHAR(25)) + ', ' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      WHEN t.[name] IN ('datetime2') THEN t.[name] + '(' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      ELSE t.[name]\nEND) AS dataType,\nc.column_id\nfrom sys.columns c\njoin sys.views v on v.object_id = c.object_id\njoin sys.schemas s on s.schema_id = v.schema_id\njoin sys.types t on c.user_type_id = t.user_type_id \nleft outer join \n@{if(empty(pipeline().parameters.p_data_type_replace), \n'(select null col, null dataType) r',\nconcat('(select * from OpenJson(N''',\nstring(pipeline().parameters.p_data_type_replace),\n''') WITH (col varchar(255), dataType varchar(255)) as r) r'))}\non r.col = c.name\nwhere s.name = 'dbo' and c.name <> '@{pipeline().parameters.c_trg_partition_col}' and v.name = \n'@{pipeline().parameters.p_trg_table}_tmp') q",
										"type": "Expression"
									}
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					},
					{
						"name": "CreateExternalTable",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "ExternalTableSQL",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "serverless_ARIR",
							"type": "LinkedServiceReference",
							"parameters": {
								"p_database": {
									"value": "@pipeline().parameters.c_serverless_db",
									"type": "Expression"
								}
							}
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": {
										"value": "begin transaction\n\nif exists (select * from sys.external_tables t join sys.schemas s on s.schema_id = t.schema_id where s.name = 'dbo' and t.name = '@{pipeline().parameters.p_trg_table}')\ndrop external table @{pipeline().parameters.p_trg_table};\n\n@{activity('ExternalTableSQL').output.resultSets[0].rows[0].SQL};\n\ndrop view @{pipeline().parameters.p_trg_table}_tmp;\n\ncommit;\n",
										"type": "Expression"
									}
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_trg_table": {
						"type": "string",
						"defaultValue": "DimDataflows"
					},
					"p_datetime_from": {
						"type": "string"
					},
					"p_surrogate_key_col": {
						"type": "string",
						"defaultValue": "dataflows_key"
					},
					"p_src_schema": {
						"type": "string",
						"defaultValue": "enr"
					},
					"p_src_object": {
						"type": "string",
						"defaultValue": "dataflows_REST_API"
					},
					"p_src_key_cols": {
						"type": "array",
						"defaultValue": [
							"name"
						]
					},
					"p_src_cdc_col": {
						"type": "string",
						"defaultValue": "enrTimestamp"
					},
					"p_data_type_replace": {
						"type": "array",
						"defaultValue": [
							{
								"col": "name",
								"dataType": "varchar(255)"
							}
						]
					},
					"p_partition_formula": {
						"type": "string",
						"defaultValue": "'dummy'"
					},
					"c_serverless_db": {
						"type": "string",
						"defaultValue": "templateDB"
					},
					"c_trg_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_trg_root_folder": {
						"type": "string",
						"defaultValue": "StarSchemaObjects"
					},
					"c_cur_data_source": {
						"type": "string",
						"defaultValue": "TemplateCuratedSource"
					},
					"c_trg_partition_col": {
						"type": "string",
						"defaultValue": "DIM_PARTITION"
					},
					"c_trg_dss_update_col": {
						"type": "string",
						"defaultValue": "dss_update_time"
					},
					"c_trg_dss_create_col": {
						"type": "string",
						"defaultValue": "dss_create_time"
					}
				},
				"variables": {
					"v_datetime_from": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:45:30Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/dataflows/StarSchemaDimension')]",
				"[concat(variables('workspaceId'), '/datasets/GenericCuratedJsonFolder')]",
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/StarSchemaFact')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "GetTargetDeltaMetadata",
						"type": "GetMetadata",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataset": {
								"referenceName": "GenericCuratedJsonFolder",
								"type": "DatasetReference",
								"parameters": {
									"p_container": {
										"value": "@pipeline().parameters.c_trg_container",
										"type": "Expression"
									},
									"p_folder": {
										"value": "@concat(pipeline().parameters.c_trg_root_folder, '/', pipeline().parameters.p_trg_table)",
										"type": "Expression"
									}
								}
							},
							"fieldList": [
								"exists"
							],
							"storeSettings": {
								"type": "AzureBlobFSReadSettings",
								"recursive": true,
								"enablePartitionDiscovery": false
							},
							"formatSettings": {
								"type": "JsonReadSettings"
							}
						}
					},
					{
						"name": "If Target Delta Exists",
						"type": "IfCondition",
						"dependsOn": [
							{
								"activity": "GetTargetDeltaMetadata",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericCuratedParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"expression": {
								"value": "@and(activity('GetTargetDeltaMetadata').output.exists, not(empty(pipeline().parameters.p_src_cdc_col)))",
								"type": "Expression"
							},
							"ifFalseActivities": [
								{
									"name": "Set v_datetime_from False",
									"type": "SetVariable",
									"dependsOn": [],
									"policy": {
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"variableName": "v_datetime_from",
										"value": {
											"value": "@pipeline().parameters.p_datetime_from",
											"type": "Expression"
										}
									}
								}
							],
							"ifTrueActivities": [
								{
									"name": "DatetimeFrom",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@if(empty(pipeline().parameters.p_datetime_from),\n    concat('select max(', pipeline().parameters.p_src_cdc_col, ') as CDCTimestamp from openrowset( bulk ''',activity('GenericCuratedParquet linked service').output.properties.typeProperties.url, pipeline().parameters.c_trg_container, '/', pipeline().parameters.c_trg_root_folder, '/', pipeline().parameters.p_trg_table, ''', format = ''DELTA'') as result'),\n    concat('select ''', replace(replace(replace(replace(replace(\n                    formatDateTime(\n                        pipeline().parameters.p_datetime_from, \n                        'yyyy-MM-ddTHH:mm:ss.fffffffZ'\n                    ), \n                    '0000Z', 'Z'), '000Z', 'Z'), '00Z', 'Z'), '0Z', 'Z'), '.Z', 'Z'\n                ),\n        ''' as CDCTimestamp'\n    )\n)",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "Set v_datetime_from True",
									"type": "SetVariable",
									"dependsOn": [
										{
											"activity": "DatetimeFrom",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"variableName": "v_datetime_from",
										"value": {
											"value": "@activity('DatetimeFrom').output.resultSets[0].rows[0].CDCTimestamp",
											"type": "Expression"
										}
									}
								}
							]
						}
					},
					{
						"name": "GenericCuratedParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericCuratedParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericCuratedParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericCuratedParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericCuratedParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "StagingParquet",
						"type": "Copy",
						"dependsOn": [
							{
								"activity": "If Target Delta Exists",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"source": {
								"type": "SqlDWSource",
								"sqlReaderQuery": {
									"value": "select * from @{pipeline().parameters.p_src_schema}.@{pipeline().parameters.p_src_object} \nwhere @{pipeline().parameters.p_src_cdc_col} > '@{variables('v_datetime_from')}'",
									"type": "Expression"
								},
								"queryTimeout": "02:00:00",
								"partitionOption": "None"
							},
							"sink": {
								"type": "ParquetSink",
								"storeSettings": {
									"type": "AzureBlobFSWriteSettings"
								},
								"formatSettings": {
									"type": "ParquetWriteSettings"
								}
							},
							"enableStaging": false,
							"translator": {
								"type": "TabularTranslator",
								"typeConversion": true,
								"typeConversionSettings": {
									"allowDataTruncation": true,
									"treatBooleanAsNumber": false
								}
							}
						},
						"inputs": [
							{
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference",
								"parameters": {
									"p_database": {
										"value": "@pipeline().parameters.c_serverless_db",
										"type": "Expression"
									},
									"p_schema": {
										"value": "@pipeline().parameters.p_src_schema",
										"type": "Expression"
									},
									"p_table": {
										"value": "@pipeline().parameters.p_src_object",
										"type": "Expression"
									}
								}
							}
						],
						"outputs": [
							{
								"referenceName": "GenericEnrichedParquet",
								"type": "DatasetReference",
								"parameters": {
									"p_container": {
										"value": "@pipeline().parameters.c_stg_container",
										"type": "Expression"
									},
									"p_folder": {
										"value": "@pipeline().parameters.c_stg_root_folder",
										"type": "Expression"
									},
									"p_file": {
										"value": "@concat(pipeline().parameters.p_trg_table, 'Stg')",
										"type": "Expression"
									}
								}
							}
						]
					},
					{
						"name": "If RowCount above 0",
						"type": "IfCondition",
						"dependsOn": [
							{
								"activity": "StagingParquet",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "GenericEnrichedParquet linked service",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"expression": {
								"value": "@greater(activity('StagingParquet').output.rowsCopied, 0)",
								"type": "Expression"
							},
							"ifTrueActivities": [
								{
									"name": "StarSchemaDimension",
									"type": "ExecuteDataFlow",
									"dependsOn": [
										{
											"activity": "ScriptStagingDimKeysSQL",
											"dependencyConditions": [
												"Succeeded"
											]
										},
										{
											"activity": "ScriptFactCreateTime",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"dataflow": {
											"referenceName": "StarSchemaFact",
											"type": "DataFlowReference",
											"parameters": {
												"p_src_key_cols": {
													"value": "@pipeline().parameters.p_src_key_cols",
													"type": "Expression"
												},
												"c_trg_dss_update_col": {
													"value": "'@{pipeline().parameters.c_trg_dss_update_col}'",
													"type": "Expression"
												},
												"c_trg_dss_create_col": {
													"value": "'@{pipeline().parameters.c_trg_dss_create_col}'",
													"type": "Expression"
												},
												"p_partition_formula": {
													"value": "@concat('\"', pipeline().parameters.p_partition_formula, '\"')",
													"type": "Expression"
												},
												"c_trg_partition_col": {
													"value": "'@{pipeline().parameters.c_trg_partition_col}'",
													"type": "Expression"
												},
												"p_trg_table": {
													"value": "'@{pipeline().parameters.p_trg_table}'",
													"type": "Expression"
												},
												"c_trg_container": {
													"value": "'@{pipeline().parameters.c_trg_container}'",
													"type": "Expression"
												},
												"c_trg_root_folder": {
													"value": "'@{pipeline().parameters.c_trg_root_folder}'",
													"type": "Expression"
												},
												"p_src_query": {
													"value": "@concat('\"', activity('ScriptStagingDimKeysSQL').output.resultSets[0].rows[0].sourceQuery, '\"')",
													"type": "Expression"
												},
												"p_trg_query": {
													"value": "@concat('\"', activity('ScriptFactCreateTime').output.resultSets[0].rows[0].targetQuery, '\"')",
													"type": "Expression"
												}
											},
											"datasetParameters": {
												"DataSource": {
													"p_database": {
														"value": "@pipeline().parameters.c_serverless_db",
														"type": "Expression"
													},
													"p_schema": "dummy",
													"p_table": "dummy"
												},
												"Fact": {
													"p_database": {
														"value": "@pipeline().parameters.c_serverless_db",
														"type": "Expression"
													},
													"p_schema": "dummy",
													"p_table": "dummy"
												},
												"SourcePartitionPruning": {
													"p_database": {
														"value": "@pipeline().parameters.c_serverless_db",
														"type": "Expression"
													},
													"p_schema": "dummy",
													"p_table": "dummy"
												},
												"dummyPartitionPruning": {
													"p_database": {
														"value": "@pipeline().parameters.c_serverless_db",
														"type": "Expression"
													},
													"p_schema": "dummy",
													"p_table": "dummy"
												},
												"sinkDimension": {},
												"sinkPartitionPruning": {}
											}
										},
										"staging": {},
										"compute": {
											"coreCount": 8,
											"computeType": "General"
										},
										"traceLevel": "Fine"
									}
								},
								{
									"name": "createTmpView",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "StarSchemaDimension",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "create or alter view \n@{pipeline().parameters.p_trg_table}_tmp\nas select * from OPENROWSET(\n\tBULK '@{activity('GenericCuratedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_trg_container}/@{pipeline().parameters.c_trg_root_folder}/@{pipeline().parameters.p_trg_table}',\n\tFORMAT = 'Delta'\n) as r",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "ExternalTableSQL",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "createTmpView",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "select 'CREATE EXTERNAL TABLE ' +\n'@{pipeline().parameters.p_trg_table} (' + \nchar(10) +\nSTRING_AGG('[' + \ncast(colName as varchar(max)) + '] ' + \ndataType, ',' + char(10)) \nWITHIN GROUP (ORDER BY column_id ASC) + char(10) +\n') WITH (LOCATION = ''@{pipeline().parameters.c_trg_root_folder}/@{pipeline().parameters.p_trg_table}'', DATA_SOURCE = @{pipeline().parameters.c_cur_data_source},  FILE_FORMAT = Delta)' as SQL\nfrom (select \nc.name colName, coalesce(r.dataType,\nCASE \n      WHEN t.[name] IN ('varchar', 'char', 'varbinary') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length AS VARCHAR(25))) + ')' \n      WHEN t.[name] IN ('nvarchar','nchar') THEN t.[name] + '(' + IIF(c.max_length = -1, 'max', CAST(c.max_length / 2 AS VARCHAR(25)))+ ')'      \n      WHEN t.[name] IN ('decimal', 'numeric') THEN t.[name] + '(' + CAST(c.[precision] AS VARCHAR(25)) + ', ' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      WHEN t.[name] IN ('datetime2') THEN t.[name] + '(' + CAST(c.[scale] AS VARCHAR(25)) + ')'\n      ELSE t.[name]\nEND) AS dataType,\nc.column_id\nfrom sys.columns c\njoin sys.views v on v.object_id = c.object_id\njoin sys.schemas s on s.schema_id = v.schema_id\njoin sys.types t on c.user_type_id = t.user_type_id \nleft outer join \n@{if(empty(pipeline().parameters.p_data_type_replace), \n'(select null col, null dataType) r',\nconcat('(select * from OpenJson(N''',\nstring(pipeline().parameters.p_data_type_replace),\n''') WITH (col varchar(255), dataType varchar(255)) as r) r'))}\non r.col = c.name\nwhere s.name = 'dbo' and c.name <> '@{pipeline().parameters.c_trg_partition_col}' and v.name = \n'@{pipeline().parameters.p_trg_table}_tmp') q",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "CreateExternalTable",
									"type": "Script",
									"dependsOn": [
										{
											"activity": "ExternalTableSQL",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "begin transaction\n\nif exists (select * from sys.external_tables t join sys.schemas s on s.schema_id = t.schema_id where s.name = 'dbo' and t.name = '@{pipeline().parameters.p_trg_table}')\ndrop external table @{pipeline().parameters.p_trg_table};\n\n@{activity('ExternalTableSQL').output.resultSets[0].rows[0].SQL};\n\ndrop view @{pipeline().parameters.p_trg_table}_tmp;\n\ncommit;\n",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "ScriptStagingDimKeysSQL",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "select 'select ' + \nSTRING_AGG('coalesce(' + coalesce(dimAlias, dimTab) + '.' + dimKey + ', 0) ' + coalesce(keyAlias, dimKey), ', ') + ', ' + 'stg.*' +\n' from openrowset(bulk ''@{activity('GenericEnrichedParquet linked service').output.properties.typeProperties.url}@{pipeline().parameters.c_stg_container}/@{pipeline().parameters.c_stg_root_folder}/@{pipeline().parameters.p_trg_table}Stg.parquet'', format = ''PARQUET'') as stg ' +\nSTRING_AGG('left outer join ' + dimTab + ' ' + coalesce(dimAlias, dimTab) + ' on ' + replace(joinStatement,  dimTab, coalesce(dimAlias, dimTab)), ' ') sourceQuery\nfrom\n(select * from OPENJSON('@{replace(string(pipeline().parameters.p_dw_dim_tabs), '''', '''''')}')\nWITH (\n    dimTab NVARCHAR(max) '$.dimTab',\n    dimAlias NVARCHAR(max) '$.dimAlias',\n    dimKey NVARCHAR(max) '$.dimKey',\n    keyAlias NVARCHAR(max) '$.keyAlias',\n    joinStatement NVARCHAR(max) '$.joinStatement'\n)) q",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								},
								{
									"name": "ScriptFactCreateTime",
									"type": "Script",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"linkedServiceName": {
										"referenceName": "serverless_ARIR",
										"type": "LinkedServiceReference",
										"parameters": {
											"p_database": {
												"value": "@pipeline().parameters.c_serverless_db",
												"type": "Expression"
											}
										}
									},
									"typeProperties": {
										"scripts": [
											{
												"type": "Query",
												"text": {
													"value": "@if(activity('GetTargetDeltaMetadata').output.exists, \nconcat('select ''select '' + STRING_AGG(value, '', '') + '', ', pipeline().parameters.c_trg_dss_create_col, ' from ', pipeline().parameters.p_trg_table, ''' targetQuery from OPENJSON (''', string(pipeline().parameters.p_src_key_cols), ''')'), \nconcat('select ''select null as '' + STRING_AGG(value, '', null as '') + '', cast(null as datetime) as ', pipeline().parameters.c_trg_dss_create_col, ' where 1 = 0'' targetQuery from OPENJSON (''', string(pipeline().parameters.p_src_key_cols), ''') as r'))\n\n",
													"type": "Expression"
												}
											}
										],
										"scriptBlockExecutionTimeout": "02:00:00"
									}
								}
							]
						}
					},
					{
						"name": "GenericEnrichedParquet attributes",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/datasets/GenericEnrichedParquet?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					},
					{
						"name": "GenericEnrichedParquet linked service",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "GenericEnrichedParquet attributes",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "GET",
							"headers": {},
							"url": {
								"value": "@concat('https://', pipeline().DataFactory, '.dev.azuresynapse.net/linkedservices/', activity('GenericEnrichedParquet attributes').output.properties.linkedServiceName.referenceName, '?api-version=2020-12-01')",
								"type": "Expression"
							},
							"connectVia": {
								"referenceName": "SHIR",
								"type": "IntegrationRuntimeReference"
							},
							"authentication": {
								"type": "MSI",
								"resource": "https://dev.azuresynapse.net/"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_trg_table": {
						"type": "string",
						"defaultValue": "FactDataflowsDatasets"
					},
					"p_datetime_from": {
						"type": "string"
					},
					"p_src_schema": {
						"type": "string",
						"defaultValue": "enr"
					},
					"p_src_object": {
						"type": "string",
						"defaultValue": "dataflows_datasets_WIDE"
					},
					"p_src_key_cols": {
						"type": "array",
						"defaultValue": [
							"dataflows_name",
							"datasets_name"
						]
					},
					"p_src_cdc_col": {
						"type": "string",
						"defaultValue": "_DSS_UPDATE_TIME"
					},
					"p_data_type_replace": {
						"type": "array",
						"defaultValue": [
							{
								"col": "dataflows_datasets_name",
								"dataType": "varchar(255)"
							},
							{
								"col": "dataflows_name",
								"dataType": "varchar(255)"
							},
							{
								"col": "datasets_name",
								"dataType": "varchar(255)"
							}
						]
					},
					"p_partition_formula": {
						"type": "string",
						"defaultValue": "'dummy'"
					},
					"c_serverless_db": {
						"type": "string",
						"defaultValue": "templateDB"
					},
					"c_trg_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_trg_root_folder": {
						"type": "string",
						"defaultValue": "StarSchemaObjects"
					},
					"c_cur_data_source": {
						"type": "string",
						"defaultValue": "TemplateCuratedSource"
					},
					"c_trg_partition_col": {
						"type": "string",
						"defaultValue": "FACT_PARTITION"
					},
					"c_trg_dss_update_col": {
						"type": "string",
						"defaultValue": "dss_update_time"
					},
					"c_trg_dss_create_col": {
						"type": "string",
						"defaultValue": "dss_create_time"
					},
					"c_stg_container": {
						"type": "string",
						"defaultValue": "template"
					},
					"c_stg_root_folder": {
						"type": "string",
						"defaultValue": "Staging"
					},
					"p_dw_dim_tabs": {
						"type": "array",
						"defaultValue": [
							{
								"dimTab": "DimDataflows",
								"dimAlias": "DimDataflows",
								"dimKey": "dataflows_key",
								"keyAlias": "dataflows_key",
								"joinStatement": "stg.dataflows_name = DimDataflows.name"
							},
							{
								"dimTab": "DimDatasets",
								"dimAlias": "DimDatasets",
								"dimKey": "datasets_key",
								"keyAlias": "datasets_key",
								"joinStatement": "stg.datasets_name = DimDatasets.name"
							}
						]
					}
				},
				"variables": {
					"v_datetime_from": {
						"type": "String"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:45:35Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericCuratedJsonFolder')]",
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/datasets/GenericEnrichedParquet')]",
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]",
				"[concat(variables('workspaceId'), '/dataflows/StarSchemaFact')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TemplateOrchestration')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "ServerlessDBDeploy",
						"type": "ExecutePipeline",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "ServerlessDBDeploy",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_serverless_db": {
									"value": "@pipeline().parameters.p_serverless_db",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "ServerlessObjectsDeploy",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "ServerlessDBDeploy",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "ServerlessObjectsDeploy",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"c_text_replacement": {
									"value": "@pipeline().parameters.c_text_replacement",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "FromRESTAPIToJson",
						"type": "ExecutePipeline",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "FromRESTAPIToJson",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_datasets": {
									"value": "@pipeline().parameters.p_rest_api_datasets",
									"type": "Expression"
								},
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "FromJsonToDeltaParquet",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "FromRESTAPIToJson",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "ServerlessObjectsDeploy",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "FromJsonToDeltaParquet",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_datasets": {
									"value": "@pipeline().parameters.p_json_to_delta_datasets",
									"type": "Expression"
								},
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "FromSQLtoRawParquet",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "FromJsonToDeltaParquet",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "FromSQLtoRawParquet",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_datasets": {
									"value": "@pipeline().parameters.p_sql_to_parquet_datasets",
									"type": "Expression"
								},
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "FromParquetToDeltaParquet",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "FromSQLtoRawParquet",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "FromParquetToDeltaParquet",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_datasets": {
									"value": "@pipeline().parameters.p_parquet_to_delta_datasets",
									"type": "Expression"
								},
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "Dataflows_StarSchemaDimension",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "FromJsonToDeltaParquet",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "StarSchemaDimension",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_trg_table": "DimDataflows",
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								},
								"p_surrogate_key_col": "dataflows_key",
								"p_src_object": "dataflows_REST_API",
								"p_src_key_cols": "[\"name\"]",
								"p_data_type_replace": "[{\"col\":\"name\",\"dataType\":\"varchar(255)\"}]"
							}
						}
					},
					{
						"name": "Datasets_StarSchemaDimension",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "FromJsonToDeltaParquet",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "StarSchemaDimension",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_trg_table": "DimDatasets",
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								},
								"p_surrogate_key_col": "datasets_key",
								"p_src_object": "datasets_REST_API",
								"p_src_key_cols": "[\"name\"]",
								"p_data_type_replace": "[{\"col\":\"name\",\"dataType\":\"varchar(255)\"}]"
							}
						}
					},
					{
						"name": "FromDeltaToWideDelta",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "FromJsonToDeltaParquet",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "FromDeltaToWideDelta",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_src_objects": {
									"value": "@pipeline().parameters.p_delta_to_wide_src_objects",
									"type": "Expression"
								},
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "StarSchemaFact",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "Dataflows_StarSchemaDimension",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "Datasets_StarSchemaDimension",
								"dependencyConditions": [
									"Succeeded"
								]
							},
							{
								"activity": "FromDeltaToWideDelta",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "StarSchemaFact",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_trg_table": "FactDataflowsDatasets",
								"p_datetime_from": {
									"value": "@pipeline().parameters.p_datetime_from",
									"type": "Expression"
								},
								"p_src_object": "dataflows_datasets_WIDE",
								"p_src_key_cols": "[\"dataflows_name\",\"datasets_name\"]",
								"p_data_type_replace": "{\"col\":\"dataflows_datasets_name\",\"dataType\":\"varchar(255)\"},{\"col\":\"dataflows_name\",\"dataType\":\"varchar(255)\"},{\"col\":\"datasets_name\",\"dataType\":\"varchar(255)\"}]",
								"p_dw_dim_tabs": {
									"value": "@pipeline().parameters.p_star_schema_dw_dim_tabs",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "WarningEmail",
						"type": "ExecutePipeline",
						"dependsOn": [
							{
								"activity": "Set v_error_array",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"userProperties": [],
						"typeProperties": {
							"pipeline": {
								"referenceName": "WarningEmail",
								"type": "PipelineReference"
							},
							"waitOnCompletion": true,
							"parameters": {
								"p_error_array": {
									"value": "@variables('v_error_array')",
									"type": "Expression"
								}
							}
						}
					},
					{
						"name": "Set v_error_array",
						"type": "SetVariable",
						"dependsOn": [
							{
								"activity": "FromDeltaToWideDelta",
								"dependencyConditions": [
									"Completed"
								]
							},
							{
								"activity": "Datasets_StarSchemaDimension",
								"dependencyConditions": [
									"Completed"
								]
							},
							{
								"activity": "Dataflows_StarSchemaDimension",
								"dependencyConditions": [
									"Completed"
								]
							}
						],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "v_error_array",
							"value": {
								"value": "@json(concat('[', replace(concat(\nif(empty(activity('Dataflows_StarSchemaDimension').error?.target), '', activity('Dataflows_StarSchemaDimension').error),\nif(empty(activity('Datasets_StarSchemaDimension').error?.target), '', activity('Datasets_StarSchemaDimension').error),\nif(empty(activity('FromDeltaToWideDelta').error?.target), '', activity('FromDeltaToWideDelta').error)\n), '}{', '},{'), ']'))",
								"type": "Expression"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"p_serverless_db": {
						"type": "array",
						"defaultValue": [
							{
								"serverlessDB": "templateDB",
								"masterkeySecret": "template-sqlpool-master-key",
								"scopedCredential": "SynapseIdentity"
							}
						]
					},
					"p_rest_api_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"source": "dataflows",
								"target": "dataflows_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": null
							},
							{
								"source": "datasets",
								"target": "datasets_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": null
							},
							{
								"source": "datasets",
								"target": "datasets_relations11_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": null
							},
							{
								"source": "dataflows",
								"target": "dataflows_datasets_REST_API",
								"path": "/",
								"delta": false,
								"crossApplyField": "value",
								"select": null,
								"filter": "api-version=2020-12-01",
								"cdcCol": null,
								"keyCol": "name",
								"relCol": "properties.typeProperties.sources.dataset.referenceName"
							}
						]
					},
					"c_text_replacement": {
						"type": "array",
						"defaultValue": [
							{
								"textToFind": "{raw_storage_account}",
								"textForReplace": "ivsraw"
							},
							{
								"textToFind": "{enr_storage_account}",
								"textForReplace": "ivscur"
							},
							{
								"textToFind": "{cur_storage_account}",
								"textForReplace": "ivscur"
							}
						]
					},
					"p_json_to_delta_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"type": "basic",
								"target": "dataflows_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": [
									{
										"col": "type",
										"dataType": "nvarchar(200)"
									}
								],
								"relCol": null,
								"partitionFormula": "'dummy'"
							},
							{
								"type": "basic",
								"target": "datasets_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": [
									{
										"col": "type",
										"dataType": "nvarchar(200)"
									}
								],
								"relCol": null,
								"partitionFormula": "'dummy'"
							},
							{
								"type": "relationsMM",
								"target": "dataflows_datasets_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": null,
								"relCol": "properties.typeProperties.sources.dataset.referenceName",
								"partitionFormula": "'dummy'"
							},
							{
								"type": "relations11",
								"target": "datasets_relations11_REST_API",
								"cdcCol": null,
								"keyCol": "name",
								"dataTypeReplace": null,
								"relCol": null,
								"partitionFormula": "'dummy'"
							}
						]
					},
					"p_sql_to_parquet_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"sourceObject": "dataflows_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_SQL",
								"processingMode": "bulk",
								"cdcCol": ""
							},
							{
								"sourceObject": "datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "lower(name) like '%template%' or lower(name) like '%generic%'",
								"target": "datasets_SQL",
								"processingMode": "bulk",
								"cdcCol": ""
							},
							{
								"sourceObject": "datasets_relations11_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "datasets_relations11_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp"
							},
							{
								"sourceObject": "dataflows_datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_datasets_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp"
							}
						]
					},
					"p_parquet_to_delta_datasets": {
						"type": "array",
						"defaultValue": [
							{
								"sourceObject": "dataflows_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_SQL",
								"processingMode": "bulk",
								"cdcCol": "",
								"keyCol": [
									"name"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							},
							{
								"sourceObject": "datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "datasets_SQL",
								"processingMode": "bulk",
								"cdcCol": "",
								"keyCol": [
									"name"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							},
							{
								"sourceObject": "datasets_relations11_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "datasets_relations11_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp",
								"keyCol": [
									"name"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							},
							{
								"sourceObject": "dataflows_datasets_REST_API",
								"sourceSchema": "enr",
								"whereStatement": "",
								"target": "dataflows_datasets_SQL",
								"processingMode": "incremental",
								"cdcCol": "enrTimestamp",
								"keyCol": [
									"name",
									"propertiestypePropertiessourcesdatasetreferenceName"
								],
								"dataTypeReplace": null,
								"partitionFormula": "'dummy'"
							}
						]
					},
					"p_delta_to_wide_src_objects": {
						"type": "array",
						"defaultValue": [
							{
								"iteration": 0,
								"object": "dataflows_datasets_REST_API",
								"schema": "enr",
								"alias": "dataflows_datasets",
								"trgKeyCol": "name,propertiestypePropertiessourcesdatasetreferenceName",
								"cdcCol": "enrTimestamp",
								"selectCols": "*",
								"joinCondition": null,
								"joinType": null,
								"joinOrder": 0
							},
							{
								"iteration": 0,
								"object": "dataflows_REST_API",
								"schema": "enr",
								"alias": "dataflows",
								"trgKeyCol": null,
								"cdcCol": "enrTimestamp",
								"selectCols": "*",
								"joinCondition": "dataflows.name = dataflows_datasets.name",
								"joinType": "left outer",
								"joinOrder": 1
							},
							{
								"iteration": 0,
								"object": "datasets_REST_API",
								"schema": "enr",
								"alias": "datasets",
								"trgKeyCol": null,
								"cdcCol": "enrTimestamp",
								"selectCols": "*",
								"joinCondition": "datasets.name = dataflows_datasets.propertiestypePropertiessourcesdatasetreferenceName",
								"joinType": "left outer",
								"joinOrder": 2
							}
						]
					},
					"p_star_schema_dw_dim_tabs": {
						"type": "array",
						"defaultValue": [
							{
								"dimTab": "DimDataflows",
								"dimAlias": "DimDataflows",
								"dimKey": "dataflows_key",
								"keyAlias": "dataflows_key",
								"joinStatement": "stg.dataflows_name = DimDataflows.name"
							},
							{
								"dimTab": "DimDatasets",
								"dimAlias": "DimDatasets",
								"dimKey": "datasets_key",
								"keyAlias": "datasets_key",
								"joinStatement": "stg.datasets_name = DimDatasets.name"
							}
						]
					},
					"p_datetime_from": {
						"type": "string"
					}
				},
				"variables": {
					"v_error_array": {
						"type": "Array"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:45:39Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/pipelines/ServerlessDBDeploy')]",
				"[concat(variables('workspaceId'), '/pipelines/ServerlessObjectsDeploy')]",
				"[concat(variables('workspaceId'), '/pipelines/FromRESTAPIToJson')]",
				"[concat(variables('workspaceId'), '/pipelines/FromJsonToDeltaParquet')]",
				"[concat(variables('workspaceId'), '/pipelines/FromSQLtoRawParquet')]",
				"[concat(variables('workspaceId'), '/pipelines/FromParquetToDeltaParquet')]",
				"[concat(variables('workspaceId'), '/pipelines/StarSchemaDimension')]",
				"[concat(variables('workspaceId'), '/pipelines/FromDeltaToWideDelta')]",
				"[concat(variables('workspaceId'), '/pipelines/StarSchemaFact')]",
				"[concat(variables('workspaceId'), '/pipelines/WarningEmail')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/WarningEmail')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "If Errors",
						"type": "IfCondition",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"expression": {
								"value": "@greater(length(pipeline().parameters.p_error_array), 0)",
								"type": "Expression"
							},
							"ifTrueActivities": [
								{
									"name": "WarningEmail_Ingestion",
									"type": "WebActivity",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 2,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"method": "POST",
										"headers": {},
										"url": {
											"value": "@pipeline().parameters.c_warning_email_url",
											"type": "Expression"
										},
										"connectVia": {
											"referenceName": "SHIR",
											"type": "IntegrationRuntimeReference"
										},
										"body": {
											"value": "{\n    \"CCReceiver\": \"@{pipeline().parameters.c_warning_ccreceiver}\",\n    \"billTo\": \"@{pipeline().parameters.c_warning_bill_to}\",\n    \"errorMessage\": @{pipeline().parameters.p_error_array},\n    \"pipelineName\": \"@{pipeline().parameters.c_warning_pipeline}\",\n    \"priority\": \"@{pipeline().parameters.c_warning_priority}\",\n    \"receiver\": \"@{pipeline().parameters.c_warning_receiver}\",\n    \"subject\": \"@{pipeline().parameters.c_warning_subject}\",\n    \"synapseWorkspaceName\": \"@{pipeline().DataFactory}\",\n    \"triageBox\": \"@{pipeline().parameters.c_warning_triage_box}\",\n    \"warningMessage\": \"@{pipeline().parameters.c_warning_message}\",\n    \"troubleshootInstructions\": \"@{pipeline().parameters.c_warning_troubleshoot_instructions}\",    \n}",
											"type": "Expression"
										}
									}
								},
								{
									"name": "EnforcedFailure",
									"type": "Fail",
									"dependsOn": [
										{
											"activity": "WarningEmail_Ingestion",
											"dependencyConditions": [
												"Succeeded"
											]
										}
									],
									"userProperties": [],
									"typeProperties": {
										"message": {
											"value": "@concat(pipeline().Pipeline, ' failure')",
											"type": "Expression"
										},
										"errorCode": "000"
									}
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"c_warning_email_url": {
						"type": "string",
						"defaultValue": "https://prod-30.westus.logic.azure.com:443/workflows/89eb2a2d7d714262a1c33b4150f77e4d/triggers/manual/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=T9Glr0u4q2YIPjf5mOiOM45c0Ra2rjOTMkQczOEOrVU"
					},
					"c_warning_receiver": {
						"type": "string",
						"defaultValue": "Shirai.Ivan@jdirving.com"
					},
					"c_warning_ccreceiver": {
						"type": "string",
						"defaultValue": "Shirai.Ivan@jdirving.com"
					},
					"c_warning_bill_to": {
						"type": "string",
						"defaultValue": "Bill to Company"
					},
					"c_warning_message": {
						"type": "string",
						"defaultValue": "Please open incident and contact On Call Team"
					},
					"c_warning_troubleshoot_instructions": {
						"type": "string",
						"defaultValue": "Contact Synapse Admin"
					},
					"c_warning_priority": {
						"type": "string",
						"defaultValue": "PR1"
					},
					"c_warning_subject": {
						"type": "string",
						"defaultValue": "Failure"
					},
					"c_warning_triage_box": {
						"type": "string",
						"defaultValue": "Triage Box"
					},
					"p_error_array": {
						"type": "array",
						"defaultValue": []
					},
					"c_warning_pipeline": {
						"type": "string",
						"defaultValue": "TemplateOrchestration"
					}
				},
				"variables": {
					"v_error_array": {
						"type": "Array"
					}
				},
				"folder": {
					"name": "Templates"
				},
				"annotations": [],
				"lastPublishTime": "2024-03-13T02:41:42Z"
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/DummyJson')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templaterawst_ARIR",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "dummy.json",
						"fileSystem": "raw"
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templaterawst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericCuratedJsonFolder')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templatecurst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templatecurst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericCuratedParquet')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templatecurst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@concat(dataset().p_file, '.parquet')",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templatecurst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericEnrichedJsonFolder')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templateenrst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericEnrichedParquet')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templateenrst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@concat(dataset().p_file, '.parquet')",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericRawCSV_NoHeaderNoQuote')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templaterawst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@concat(dataset().p_file, '.csv')",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": false,
					"quoteChar": ""
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templaterawst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericRawJson')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templaterawst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@concat(dataset().p_file, '.json')",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templaterawst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericRawJson_NoExtension')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templaterawst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@dataset().p_file",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templaterawst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericRawParquet')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templaterawst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@concat(dataset().p_file, '.parquet')",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templaterawst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericRawParquet_NoExtension')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "templaterawst_ARIR",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"p_container": {
						"type": "string"
					},
					"p_folder": {
						"type": "string"
					},
					"p_file": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@dataset().p_file",
							"type": "Expression"
						},
						"folderPath": {
							"value": "@dataset().p_folder",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().p_container",
							"type": "Expression"
						}
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/templaterawst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/GenericServerlessSQL')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "serverless_ARIR",
					"type": "LinkedServiceReference",
					"parameters": {
						"p_database": {
							"value": "@dataset().p_database",
							"type": "Expression"
						}
					}
				},
				"parameters": {
					"p_database": {
						"type": "string"
					},
					"p_schema": {
						"type": "string"
					},
					"p_table": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "AzureSqlDWTable",
				"schema": [],
				"typeProperties": {
					"schema": {
						"value": "@dataset().p_schema",
						"type": "Expression"
					},
					"table": {
						"value": "@dataset().p_table",
						"type": "Expression"
					}
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/serverless_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TMPL_DATASOURCE2')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ivs-synapse-WorkspaceDefaultStorage",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "TMPL_DATASOURCE2.csv",
						"folderPath": "source",
						"fileSystem": "adftemplate"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/ivs-synapse-WorkspaceDefaultStorage')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TMPL_DATASOURCE3')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ivs-synapse-WorkspaceDefaultStorage",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "TMPL_DATASOURCE3.csv",
						"folderPath": "source",
						"fileSystem": "adftemplate"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": [
					{
						"type": "String"
					},
					{
						"type": "String"
					},
					{
						"type": "String"
					},
					{
						"type": "String"
					},
					{
						"type": "String"
					},
					{
						"type": "String"
					},
					{
						"type": "String"
					},
					{
						"type": "String"
					}
				]
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/ivs-synapse-WorkspaceDefaultStorage')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TMPL_DIMENSION1')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ivs-synapse-WorkspaceDefaultSqlServer",
					"type": "LinkedServiceReference",
					"parameters": {
						"DBName": "ivs_sqlpool"
					}
				},
				"annotations": [],
				"type": "AzureSqlDWTable",
				"schema": [
					{
						"name": "DIMENSION1_KEY",
						"type": "int",
						"precision": 10
					},
					{
						"name": "SOURCE2_ID",
						"type": "int",
						"precision": 10
					},
					{
						"name": "NCHAR_ATTRIBUTE1",
						"type": "nchar"
					},
					{
						"name": "NCHAR_ATTRIBUTE2",
						"type": "nchar"
					},
					{
						"name": "DATETIME_ATTRIBUTE1",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DATETIME_ATTRIBUTE2",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DSS_CREATE_TIME",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DSS_UPDATE_TIME",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					}
				],
				"typeProperties": {
					"tableName": "dbo.TMPL_DIMENSION1"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/ivs-synapse-WorkspaceDefaultSqlServer')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TMPL_DIMENSION2')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ivs-synapse-WorkspaceDefaultSqlServer",
					"type": "LinkedServiceReference",
					"parameters": {
						"DBName": "ivs_sqlpool"
					}
				},
				"annotations": [],
				"type": "AzureSqlDWTable",
				"schema": [
					{
						"name": "DIMENSION2_KEY",
						"type": "int",
						"precision": 10
					},
					{
						"name": "SOURCE3_ID",
						"type": "int",
						"precision": 10
					},
					{
						"name": "NCHAR_ATTRIBUTE1",
						"type": "nchar"
					},
					{
						"name": "NCHAR_ATTRIBUTE2",
						"type": "nchar"
					},
					{
						"name": "DATETIME_ATTRIBUTE1",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DATETIME_ATTRIBUTE2",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DSS_CREATE_TIME",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DSS_UPDATE_TIME",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					}
				],
				"typeProperties": {
					"tableName": "dbo.TMPL_DIMENSION2"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/ivs-synapse-WorkspaceDefaultSqlServer')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TMPL_FACT')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ivs-synapse-WorkspaceDefaultSqlServer",
					"type": "LinkedServiceReference",
					"parameters": {
						"DBName": "ivs_sqlpool"
					}
				},
				"annotations": [],
				"type": "AzureSqlDWTable",
				"schema": [
					{
						"name": "DIMENSION1_KEY",
						"type": "int",
						"precision": 10
					},
					{
						"name": "DIMENSION2_KEY",
						"type": "int",
						"precision": 10
					},
					{
						"name": "SOURCE1_ID",
						"type": "int",
						"precision": 10
					},
					{
						"name": "SRC1_MEASURE1",
						"type": "decimal",
						"precision": 18,
						"scale": 4
					},
					{
						"name": "SRC1_MEASURE2",
						"type": "decimal",
						"precision": 18,
						"scale": 4
					},
					{
						"name": "SRC2_MEASURE1",
						"type": "decimal",
						"precision": 18,
						"scale": 4
					},
					{
						"name": "SRC2_MEASURE2",
						"type": "decimal",
						"precision": 18,
						"scale": 4
					},
					{
						"name": "SRC3_MEASURE1",
						"type": "decimal",
						"precision": 18,
						"scale": 4
					},
					{
						"name": "SRC3_MEASURE2",
						"type": "decimal",
						"precision": 18,
						"scale": 4
					},
					{
						"name": "SRC1_CDC_TIMESTAMP",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DSS_CREATE_TIME",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "DSS_UPDATE_TIME",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					}
				],
				"typeProperties": {
					"tableName": "dbo.TMPL_FACT"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/ivs-synapse-WorkspaceDefaultSqlServer')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TMPL_STAGING')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ivs-synapse-WorkspaceDefaultStorage",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"folderPath": "staging/data",
						"fileSystem": "adftemplate"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/ivs-synapse-WorkspaceDefaultStorage')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/azuresynapse')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "azuresynapse_REST",
					"type": "LinkedServiceReference",
					"parameters": {
						"p_workspace": {
							"value": "@dataset().p_workspace",
							"type": "Expression"
						}
					}
				},
				"parameters": {
					"p_workspace": {
						"type": "string"
					},
					"p_relative_url": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@dataset().p_relative_url",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/azuresynapse_REST')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/BloombergAPI')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('BloombergAPI_properties_typeProperties_url')]",
					"enableServerCertificateValidation": false,
					"authenticationType": "Anonymous",
					"authHeaders": {
						"Content-Type": {
							"type": "SecureString",
							"value": "**********"
						},
						"jwt": {
							"type": "SecureString",
							"value": "**********"
						},
						"Api-version": {
							"type": "SecureString",
							"value": "**********"
						}
					}
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/azuresynapse_REST')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"parameters": {
					"p_workspace": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('azuresynapse_REST_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "ManagedServiceIdentity",
					"aadResourceId": "[parameters('azuresynapse_REST_properties_typeProperties_aadResourceId')]"
				},
				"connectVia": {
					"referenceName": "SHIR",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/SHIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ivs-synapse-WorkspaceDefaultSqlServer')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"parameters": {
					"DBName": {
						"type": "String"
					}
				},
				"annotations": [],
				"type": "AzureSqlDW",
				"typeProperties": {
					"connectionString": "[parameters('ivs-synapse-WorkspaceDefaultSqlServer_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ivs-synapse-WorkspaceDefaultStorage')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('ivs-synapse-WorkspaceDefaultStorage_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/serverless_ARIR')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"parameters": {
					"p_database": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "AzureSqlDW",
				"typeProperties": {
					"connectionString": "[parameters('serverless_ARIR_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/template_kv')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureKeyVault",
				"typeProperties": {
					"baseUrl": "[parameters('template_kv_properties_typeProperties_baseUrl')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/templatecurst_ARIR')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('templatecurst_ARIR_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/templateenrst_ARIR')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('templateenrst_ARIR_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/templaterawst_ARIR')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('templaterawst_ARIR_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SchedSQLPoolPaused')]",
			"type": "Microsoft.Synapse/workspaces/triggers",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"runtimeState": "Stopped",
				"pipelines": [
					{
						"pipelineReference": {
							"referenceName": "SQLPoolPause",
							"type": "PipelineReference"
						},
						"parameters": {
							"p_subscription": "[parameters('SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_subscription')]",
							"p_resourceGroup": "[parameters('SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_resourceGroup')]",
							"p_workspace": "[parameters('SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_workspace')]",
							"p_sqlPool": "[parameters('SchedSQLPoolPaused_properties_SQLPoolPause_parameters_p_sqlPool')]"
						}
					}
				],
				"type": "ScheduleTrigger",
				"typeProperties": {
					"recurrence": {
						"frequency": "Day",
						"interval": 1,
						"startTime": "2021-01-17T04:03:00",
						"timeZone": "Atlantic Standard Time",
						"schedule": {
							"minutes": [
								0
							],
							"hours": [
								1
							]
						}
					}
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/pipelines/SQLPoolPause')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/AutoResolveIntegrationRuntime')]",
			"type": "Microsoft.Synapse/workspaces/integrationRuntimes",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "Managed",
				"typeProperties": {
					"computeProperties": {
						"location": "AutoResolve",
						"dataFlowProperties": {
							"computeType": "General",
							"coreCount": 8,
							"timeToLive": 0
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SHIR')]",
			"type": "Microsoft.Synapse/workspaces/integrationRuntimes",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "SelfHosted",
				"typeProperties": {}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromDeltaToWideDelta')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "sourceWide"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "sourcePartitionPruning"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "templateenrst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "sinkWide"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "alterRowWide"
						},
						{
							"name": "derivedWide"
						}
					],
					"scriptLines": [
						"parameters{",
						"     c_trg_object as string ('dataflows_datasets_WIDE'),",
						"     c_trg_container as string ('template'),",
						"     c_trg_root_folder as string ('FromDeltaToWideDelta'),",
						"     p_keyCols as string ('dataflows_datasets_name, dataflows_datasets_propertiestypePropertiessourcesdatasetreferenceName'),",
						"     p_source_query as string (\"select dataflows_datasets.DELTA_PARTITION as dataflows_datasets_DELTA_PARTITION, dataflows_datasets.enrTimestamp as dataflows_datasets_enrTimestamp, dataflows_datasets.name as dataflows_datasets_name, dataflows_datasets.propertiestypePropertiessourcesdatasetreferenceName as dataflows_datasets_propertiestypePropertiessourcesdatasetreferenceName, dataflows_datasets.rawTimestamp as dataflows_datasets_rawTimestamp, dataflows.DELTA_PARTITION as dataflows_DELTA_PARTITION, dataflows.enrTimestamp as dataflows_enrTimestamp, dataflows.etag as dataflows_etag, dataflows.id as dataflows_id, dataflows.name as dataflows_name, dataflows.rawTimestamp as dataflows_rawTimestamp, dataflows.type as dataflows_type, datasets.DELTA_PARTITION as datasets_DELTA_PARTITION, datasets.enrTimestamp as datasets_enrTimestamp, datasets.etag as datasets_etag, datasets.id as datasets_id, datasets.name as datasets_name, datasets.rawTimestamp as datasets_rawTimestamp, datasets.type as datasets_type, dataflows_datasets.DELTA_PARTITION as _PARTITION, cast('2024-03-07T14:10:09.9058210Z' as datetime2) as _DSS_UPDATE_TIME from enr.dataflows_datasets_REST_API as dataflows_datasets left outer join enr.dataflows_REST_API as dataflows on dataflows.name = dataflows_datasets.name left outer join enr.datasets_REST_API as datasets on datasets.name = dataflows_datasets.propertiestypePropertiessourcesdatasetreferenceName where (dataflows_datasets.enrTimestamp > '1900-01-01' or dataflows.enrTimestamp > '1900-01-01' or datasets.enrTimestamp > '1900-01-01')\"),",
						"     p_pruning_query as string (\"select distinct(dataflows_datasets.DELTA_PARTITION) as _PARTITION from enr.dataflows_datasets_REST_API as dataflows_datasets left outer join enr.dataflows_REST_API as dataflows on dataflows.name = dataflows_datasets.name left outer join enr.datasets_REST_API as datasets on datasets.name = dataflows_datasets.propertiestypePropertiessourcesdatasetreferenceName where (dataflows_datasets.enrTimestamp > '1900-01-01' or dataflows.enrTimestamp > '1900-01-01' or datasets.enrTimestamp > '1900-01-01')\"),",
						"     c_trg_partition_col as string ('_PARTITION'),",
						"     p_iteration as integer (0)",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: ($p_source_query),",
						"     format: 'query',",
						"     staged: false) ~> sourceWide",
						"source(output(",
						"          PartitionPruning as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: (\"select distinct \" + $c_trg_partition_col + \" as PartitionPruning from (select 'dummy' as \" + $c_trg_partition_col + \" union \" + $p_pruning_query + \") q\"),",
						"     format: 'query',",
						"     staged: false) ~> sourcePartitionPruning",
						"derivedWide alterRow(upsertIf($p_iteration==0),",
						"     updateIf($p_iteration!=0)) ~> alterRowWide",
						"sourceWide derive({_PARTITION} = byName($c_trg_partition_col)) ~> derivedWide",
						"alterRowWide sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     fileSystem: ($c_trg_container),",
						"     folderPath: ($c_trg_root_folder + \"/\" + $c_trg_object),",
						"     mergeSchema: false,",
						"     autoCompact: false,",
						"     optimizedWrite: false,",
						"     vacuum: 0,",
						"     deletable: false,",
						"     insertable: true,",
						"     updateable: false,",
						"     upsertable: false,",
						"     pruneCondition: ['_PARTITION' -> (sinkPartitionPruning#outputs().PartitionPruning)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 2,",
						"     partitionBy('key',",
						"          0,",
						"          {_PARTITION}",
						"     )) ~> sinkWide",
						"sourcePartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromJsonToDeltaParquet_Basic')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericRawJson_NoExtension",
								"type": "DatasetReference"
							},
							"name": "RawDataset"
						},
						{
							"dataset": {
								"referenceName": "GenericRawJson_NoExtension",
								"type": "DatasetReference"
							},
							"name": "PartitionPruning"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "dummyPartitionPruning"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "templateenrst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "EnrichedDeltaLake"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "flattenRaw"
						},
						{
							"name": "alterRow"
						},
						{
							"name": "elicitDuplicates"
						},
						{
							"name": "derivedId",
							"description": "Added as Window function cannot interpret byName('Id') as valid for OVER statement"
						},
						{
							"name": "filterDuplicates"
						},
						{
							"name": "removeTempColumns"
						},
						{
							"name": "aggregatePartitionPruning"
						},
						{
							"name": "unionPartitionPruning"
						},
						{
							"name": "collectPartitionPruning"
						},
						{
							"name": "flattenPartition"
						}
					],
					"scriptLines": [
						"parameters{",
						"     c_target_container as string ('sandpit'),",
						"     c_target_folder as string ('FromJsonToDeltaParquet_Basic'),",
						"     c_key_column_name as string ('name'),",
						"     c_cdc_column_name as string ('fileName'),",
						"     c_enriched_cdc_column as string ('enrTimestamp'),",
						"     p_partition_formula as string (\"'dummy'\"),",
						"     p_dss_update_time as string ('2023-10-20T00:00:00Z'),",
						"     c_raw_cdc_column as string ('rawTimestamp')",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     rowUrlColumn: 'fileName',",
						"     documentForm: 'documentPerLine',",
						"     dateFormats: ['yyyy-MM-dd'],",
						"     timestampFormats: ['yyyy-MM-dd\\'T\\'HH:mm:ss.SSS\\'Z\\'','yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\''],",
						"     preferredIntegralType: 'long',",
						"     preferredFractionalType: 'decimal') ~> RawDataset",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     documentForm: 'documentPerLine') ~> PartitionPruning",
						"source(output(",
						"          PARTITION as string,",
						"          CONSTANT as string,",
						"          AGGREGATE as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: 'select \\'dummy\\' as PARTITION,\\n\\'CONSTANT\\' as CONSTANT, \\'dummy\\' as AGGREGATE',",
						"     format: 'query',",
						"     staged: false) ~> dummyPartitionPruning",
						"RawDataset foldDown(unroll((byName('value'))),",
						"     mapColumn(",
						"          every(match(locate('@',name)==0),",
						"               replace($0,'value.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenRaw",
						"removeTempColumns alterRow(upsertIf(true())) ~> alterRow",
						"derivedId window(over(keyColumn),",
						"     desc(toString(byName($c_cdc_column_name)), true),",
						"     rowNum = rowNumber()) ~> elicitDuplicates",
						"flattenRaw derive(keyColumn = toString(byName($c_key_column_name)),",
						"          each(match(true()), $$ = toString($$)),",
						"          each(match(name=='fileName'), $c_enriched_cdc_column = toTimestamp($p_dss_update_time, \"yyyy-MM-dd'T'HH:mm:ss'Z'\"), $c_raw_cdc_column = replace(reverse(substring(reverse(toString($$)), 0, locate('_', reverse(toString($$))) - 1)), '.json')),",
						"          DELTA_PARTITION = expr($p_partition_formula)) ~> derivedId",
						"elicitDuplicates filter(rowNum == 1 && not(isNull(keyColumn))) ~> filterDuplicates",
						"filterDuplicates select(mapColumn(",
						"          each(match(name!='rowNum'&&name!='fileName'&&name!='keyColumn'&&name!='cdcValue'&&left(name,length('properties.'))!='properties.'))",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> removeTempColumns",
						"flattenPartition aggregate(groupBy(PARTITION = expr($p_partition_formula),",
						"          CONSTANT = 'CONSTANT'),",
						"     AGGREGATE = first(expr($p_partition_formula))) ~> aggregatePartitionPruning",
						"aggregatePartitionPruning, dummyPartitionPruning union(byName: true)~> unionPartitionPruning",
						"unionPartitionPruning aggregate(groupBy(CONSTANT),",
						"     PARTITION = distinct(collect(AGGREGATE))) ~> collectPartitionPruning",
						"PartitionPruning foldDown(unroll((byName('value'))),",
						"     mapColumn(",
						"          every(match(locate('@',name)==0),",
						"               replace($0,'value.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenPartition",
						"alterRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     compressionType: 'snappy',",
						"     compressionLevel: 'Fastest',",
						"     fileSystem: ($c_target_container),",
						"     folderPath: ($c_target_folder),",
						"     mergeSchema: true,",
						"     autoCompact: true,",
						"     optimizedWrite: true,",
						"     vacuum: 1,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:(array($c_key_column_name)),",
						"     pruneCondition: ['DELTA_PARTITION' -> (sinkPartitionPruning#outputs().PARTITION_PRUNING)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 2,",
						"     partitionBy('key',",
						"          0,",
						"          DELTA_PARTITION",
						"     )) ~> EnrichedDeltaLake",
						"collectPartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1,",
						"     mapColumn(",
						"          PARTITION_PRUNING = PARTITION",
						"     )) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericRawJson_NoExtension')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromJsonToDeltaParquet_Relations11')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericRawJson_NoExtension",
								"type": "DatasetReference"
							},
							"name": "RawDataset"
						},
						{
							"dataset": {
								"referenceName": "GenericRawJson_NoExtension",
								"type": "DatasetReference"
							},
							"name": "PartitionPruning"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "dummyPartitionPruning"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "templateenrst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "EnrichedDeltaLake"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "flattenKey"
						},
						{
							"name": "alterRow"
						},
						{
							"name": "elicitDuplicates"
						},
						{
							"name": "derivedColumns",
							"description": "Added as Window function cannot interpret byName('Id') as valid for OVER statement"
						},
						{
							"name": "filterDuplicates"
						},
						{
							"name": "removeTempColumns"
						},
						{
							"name": "flattenKeyPartition"
						},
						{
							"name": "aggregatePartitionPruning"
						},
						{
							"name": "unionPartitionPruning"
						},
						{
							"name": "collectPartitionPruning"
						}
					],
					"scriptLines": [
						"parameters{",
						"     c_target_container as string ('sandpit'),",
						"     c_target_folder as string ('FromJsonToDeltaParquet_RelationsMM'),",
						"     c_key_column_name as string ('name'),",
						"     c_cdc_column_name as string ('fileName'),",
						"     c_enriched_cdc_column as string ('enrTimestamp'),",
						"     p_partition_formula as string (\"'dummy'\"),",
						"     p_dss_update_time as string ('2023-10-20T00:00:00Z'),",
						"     c_raw_cdc_column as string ('rawTimestamp')",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     rowUrlColumn: 'fileName',",
						"     documentForm: 'documentPerLine',",
						"     dateFormats: ['yyyy-MM-dd'],",
						"     timestampFormats: ['yyyy-MM-dd\\'T\\'HH:mm:ss.SSS\\'Z\\'','yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\''],",
						"     preferredIntegralType: 'long',",
						"     preferredFractionalType: 'decimal') ~> RawDataset",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     documentForm: 'documentPerLine') ~> PartitionPruning",
						"source(output(",
						"          PARTITION as string,",
						"          CONSTANT as string,",
						"          AGGREGATE as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: 'select \\'dummy\\' as PARTITION,\\n\\'CONSTANT\\' as CONSTANT, \\'dummy\\' as AGGREGATE',",
						"     format: 'query',",
						"     staged: false) ~> dummyPartitionPruning",
						"RawDataset foldDown(unroll((byName('value'))),",
						"     mapColumn(",
						"          every(match(locate('@',name)==0),",
						"               replace($0,'value.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenKey",
						"removeTempColumns alterRow(upsertIf(true())) ~> alterRow",
						"derivedColumns window(over(keyColumn),",
						"     desc(toString(byName($c_cdc_column_name)), true),",
						"     rowNum = rowNumber()) ~> elicitDuplicates",
						"flattenKey derive(keyColumn = toString(byName($c_key_column_name)),",
						"          each(match(name=='fileName'), $c_enriched_cdc_column = toTimestamp($p_dss_update_time, \"yyyy-MM-dd'T'HH:mm:ss'Z'\"), $c_raw_cdc_column = replace(reverse(substring(reverse(toString($$)), 0, locate('_', reverse(toString($$))) - 1)), '.json')),",
						"          DELTA_PARTITION = expr($p_partition_formula)) ~> derivedColumns",
						"elicitDuplicates filter(rowNum == 1 && not(isNull(keyColumn))) ~> filterDuplicates",
						"filterDuplicates select(mapColumn(",
						"          each(match(name==$c_key_column_name||right(name,length('referenceName'))=='referenceName'||name=='DELTA_PARTITION'||name==$c_raw_cdc_column||name==$c_enriched_cdc_column),",
						"               replace($$,'.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> removeTempColumns",
						"PartitionPruning foldDown(unroll((byName('value'))),",
						"     mapColumn(",
						"          every(match(locate('@',name)==0),",
						"               replace($0,'value.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenKeyPartition",
						"flattenKeyPartition aggregate(groupBy(PARTITION = expr($p_partition_formula),",
						"          CONSTANT = 'CONSTANT'),",
						"     AGGREGATE = first(expr($p_partition_formula))) ~> aggregatePartitionPruning",
						"aggregatePartitionPruning, dummyPartitionPruning union(byName: true)~> unionPartitionPruning",
						"unionPartitionPruning aggregate(groupBy(CONSTANT),",
						"     PARTITION = distinct(collect(AGGREGATE))) ~> collectPartitionPruning",
						"alterRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     compressionType: 'snappy',",
						"     compressionLevel: 'Fastest',",
						"     fileSystem: ($c_target_container),",
						"     folderPath: ($c_target_folder),",
						"     mergeSchema: true,",
						"     autoCompact: true,",
						"     optimizedWrite: true,",
						"     vacuum: 1,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:(array($c_key_column_name)),",
						"     pruneCondition: ['DELTA_PARTITION' -> (sinkPartitionPruning#outputs().PARTITION_PRUNING)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 2,",
						"     partitionBy('key',",
						"          0,",
						"          DELTA_PARTITION",
						"     )) ~> EnrichedDeltaLake",
						"collectPartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1,",
						"     mapColumn(",
						"          PARTITION_PRUNING = PARTITION",
						"     )) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericRawJson_NoExtension')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromJsonToDeltaParquet_RelationsMM')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericRawJson_NoExtension",
								"type": "DatasetReference"
							},
							"name": "RawDataset"
						},
						{
							"dataset": {
								"referenceName": "GenericRawJson_NoExtension",
								"type": "DatasetReference"
							},
							"name": "PartitionPruning"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "dummyPartitionPruning"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "templateenrst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "EnrichedDeltaLake"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "flattenKey"
						},
						{
							"name": "alterRow"
						},
						{
							"name": "elicitDuplicates"
						},
						{
							"name": "derivedColumns",
							"description": "Added as Window function cannot interpret byName('Id') as valid for OVER statement"
						},
						{
							"name": "filterDuplicates"
						},
						{
							"name": "removeTempColumns"
						},
						{
							"name": "flattenRel"
						},
						{
							"name": "flattenKeyPartition"
						},
						{
							"name": "flattenRelPartition"
						},
						{
							"name": "aggregatePartitionPruning"
						},
						{
							"name": "unionPartitionPruning"
						},
						{
							"name": "collectPartitionPruning"
						}
					],
					"scriptLines": [
						"parameters{",
						"     c_target_container as string ('sandpit'),",
						"     c_target_folder as string ('FromJsonToDeltaParquet_RelationsMM'),",
						"     c_key_column_name as string ('name'),",
						"     c_cdc_column_name as string ('fileName'),",
						"     c_enriched_cdc_column as string ('enrTimestamp'),",
						"     c_relation_column_name as string ('properties.typeProperties.sources.dataset.referenceName'),",
						"     p_partition_formula as string (\"'dummy'\"),",
						"     p_dss_update_time as string ('2023-10-20T00:00:00Z'),",
						"     c_raw_cdc_column as string ('rawTimestamp')",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     rowUrlColumn: 'fileName',",
						"     documentForm: 'documentPerLine',",
						"     dateFormats: ['yyyy-MM-dd'],",
						"     timestampFormats: ['yyyy-MM-dd\\'T\\'HH:mm:ss.SSS\\'Z\\'','yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\''],",
						"     preferredIntegralType: 'long',",
						"     preferredFractionalType: 'decimal') ~> RawDataset",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     documentForm: 'documentPerLine') ~> PartitionPruning",
						"source(output(",
						"          PARTITION as string,",
						"          CONSTANT as string,",
						"          AGGREGATE as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: 'select \\'dummy\\' as PARTITION,\\n\\'CONSTANT\\' as CONSTANT, \\'dummy\\' as AGGREGATE',",
						"     format: 'query',",
						"     staged: false) ~> dummyPartitionPruning",
						"RawDataset foldDown(unroll((byName('value'))),",
						"     mapColumn(",
						"          every(match(locate('@',name)==0),",
						"               replace($0,'value.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenKey",
						"removeTempColumns alterRow(upsertIf(true())) ~> alterRow",
						"derivedColumns window(over(keyColumn),",
						"     desc(toString(byName($c_cdc_column_name)), true),",
						"     rowNum = rowNumber()) ~> elicitDuplicates",
						"flattenRel derive(keyColumn = toString(byName($c_key_column_name)) + '-' + toString(byName(replace($c_relation_column_name, '.', ''))),",
						"          each(match(name=='fileName'), $c_enriched_cdc_column = toTimestamp($p_dss_update_time, \"yyyy-MM-dd'T'HH:mm:ss'Z'\"), $c_raw_cdc_column = replace(reverse(substring(reverse(toString($$)), 0, locate('_', reverse(toString($$))) - 1)), '.json')),",
						"          DELTA_PARTITION = expr($p_partition_formula)) ~> derivedColumns",
						"elicitDuplicates filter(rowNum == 1 && not(isNull(keyColumn))) ~> filterDuplicates",
						"filterDuplicates select(mapColumn(",
						"          each(match(name==replace($c_key_column_name,'.','')||name==replace($c_relation_column_name,'.','')||name=='DELTA_PARTITION'||name==$c_raw_cdc_column||name==$c_enriched_cdc_column))",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> removeTempColumns",
						"flattenKey foldDown(unroll((byName($c_relation_column_name))),",
						"     mapColumn(",
						"          fileName,",
						"          each(match(name==$c_key_column_name||name==$c_relation_column_name),",
						"               replace($$,'.','') = $$),",
						"          each(match(name!=$c_key_column_name&&name!=$c_relation_column_name&&name!='fileName'),",
						"               $0 = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenRel",
						"PartitionPruning foldDown(unroll((byName('value'))),",
						"     mapColumn(",
						"          every(match(locate('@',name)==0),",
						"               replace($0,'value.','') = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenKeyPartition",
						"flattenKeyPartition foldDown(unroll((byName($c_relation_column_name))),",
						"     mapColumn(",
						"          each(match(name==$c_key_column_name||name==$c_relation_column_name),",
						"               replace($$,'.','') = $$),",
						"          each(match(name!=$c_key_column_name&&name!=$c_relation_column_name&&name!='fileName'),",
						"               $0 = $$)",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flattenRelPartition",
						"flattenRelPartition aggregate(groupBy(PARTITION = expr($p_partition_formula),",
						"          CONSTANT = 'CONSTANT'),",
						"     AGGREGATE = first(expr($p_partition_formula))) ~> aggregatePartitionPruning",
						"aggregatePartitionPruning, dummyPartitionPruning union(byName: true)~> unionPartitionPruning",
						"unionPartitionPruning aggregate(groupBy(CONSTANT),",
						"     PARTITION = distinct(collect(AGGREGATE))) ~> collectPartitionPruning",
						"alterRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     compressionType: 'snappy',",
						"     compressionLevel: 'Fastest',",
						"     fileSystem: ($c_target_container),",
						"     folderPath: ($c_target_folder),",
						"     mergeSchema: true,",
						"     autoCompact: true,",
						"     optimizedWrite: true,",
						"     vacuum: 1,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:(array($c_key_column_name, replace($c_relation_column_name, '.', ''))),",
						"     pruneCondition: ['DELTA_PARTITION' -> (sinkPartitionPruning#outputs().PARTITION_PRUNING)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 2,",
						"     partitionBy('key',",
						"          0,",
						"          DELTA_PARTITION",
						"     )) ~> EnrichedDeltaLake",
						"collectPartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1,",
						"     mapColumn(",
						"          PARTITION_PRUNING = PARTITION",
						"     )) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericRawJson_NoExtension')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/FromParquetToDeltaParquet')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericRawParquet_NoExtension",
								"type": "DatasetReference"
							},
							"name": "RawDataset"
						},
						{
							"dataset": {
								"referenceName": "GenericRawParquet_NoExtension",
								"type": "DatasetReference"
							},
							"name": "RawPartitionPruning"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "dummyPartitionPruning"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "templateenrst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "EnrichedDeltaLake"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "alterRow"
						},
						{
							"name": "elicitDuplicates"
						},
						{
							"name": "derivedId",
							"description": "Added as Window function cannot interpret byName('Id') as valid for OVER statement"
						},
						{
							"name": "filterDuplicates"
						},
						{
							"name": "removeTempColumns"
						},
						{
							"name": "aggregatePartitionPruning"
						},
						{
							"name": "unionPartitionPruning"
						},
						{
							"name": "collectPartitionPruning"
						}
					],
					"scriptLines": [
						"parameters{",
						"     c_target_container as string ('template'),",
						"     c_key_column_name as string[] ([\"name\"]),",
						"     c_raw_cdc_column as string ('rawTimestamp_ParquetToDeltaParquet'),",
						"     p_dss_update_time as string ('2024-03-06T22:24:32Z'),",
						"     c_enr_cdc_column as string ('enrTimestamp_ParquetToDeltaParquet'),",
						"     p_partition_formula as string (\"'dummy'\"),",
						"     c_target_root_folder as string ('FromParquetToDeltaParquet'),",
						"     p_object as string ('dataflows_SQL'),",
						"     p_processing_mode as string ('bulk')",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     rowUrlColumn: 'fileName',",
						"     format: 'parquet',",
						"     dateFormats: ['yyyy-MM-dd'],",
						"     timestampFormats: ['yyyy-MM-dd\\'T\\'HH:mm:ss.SSS\\'Z\\'','yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\''],",
						"     preferredIntegralType: 'long',",
						"     preferredFractionalType: 'decimal') ~> RawDataset",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     fileList: true,",
						"     format: 'parquet') ~> RawPartitionPruning",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: 'select \\'dummy\\' as PARTITION,\\n\\'CONSTANT\\' as CONSTANT, \\'dummy\\' as AGGREGATE',",
						"     format: 'query',",
						"     staged: false) ~> dummyPartitionPruning",
						"removeTempColumns alterRow(upsertIf(true())) ~> alterRow",
						"derivedId window(over(keyColumn),",
						"     desc(toString(byName($c_raw_cdc_column)), true),",
						"     rowNum = rowNumber()) ~> elicitDuplicates",
						"RawDataset derive(keyColumn = md5(byNames($c_key_column_name)),",
						"          each(match(name=='fileName'), $c_raw_cdc_column = iif($p_processing_mode == 'incremental', replace(reverse(substring(reverse(toString($$)), 0, locate('_', reverse(toString($$))) - 1)), '.parquet'), toString(null())), $c_enr_cdc_column = toTimestamp($p_dss_update_time, \"yyyy-MM-dd'T'HH:mm:ss'Z'\")),",
						"          DELTA_PARTITION = expr($p_partition_formula)) ~> derivedId",
						"elicitDuplicates filter(rowNum == 1 && not(isNull(keyColumn))) ~> filterDuplicates",
						"filterDuplicates select(mapColumn(",
						"          each(match(name!='rowNum'&&name!='fileName'&&name!='keyColumn'))",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> removeTempColumns",
						"RawPartitionPruning aggregate(groupBy(PARTITION = expr($p_partition_formula),",
						"          CONSTANT = 'CONSTANT'),",
						"     AGGREGATE = first(expr($p_partition_formula))) ~> aggregatePartitionPruning",
						"aggregatePartitionPruning, dummyPartitionPruning union(byName: true)~> unionPartitionPruning",
						"unionPartitionPruning aggregate(groupBy(CONSTANT),",
						"     PARTITION = collect(AGGREGATE)) ~> collectPartitionPruning",
						"alterRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     compressionType: 'snappy',",
						"     compressionLevel: 'Fastest',",
						"     fileSystem: ($c_target_container),",
						"     folderPath: ($c_target_root_folder + '/' + $p_object),",
						"     mergeSchema: false,",
						"     autoCompact: false,",
						"     optimizedWrite: false,",
						"     vacuum: 0,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:($c_key_column_name),",
						"     pruneCondition: ['DELTA_PARTITION' -> (sinkPartitionPruning#outputs().PARTITION_PRUNING)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 2,",
						"     partitionBy('key',",
						"          0,",
						"          DELTA_PARTITION",
						"     )) ~> EnrichedDeltaLake",
						"collectPartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1,",
						"     mapColumn(",
						"          PARTITION_PRUNING = PARTITION",
						"     )) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericRawParquet_NoExtension')]",
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templateenrst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/StarSchemaDimension')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "DataSource"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "Dimension"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "DimensionMaxKey"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "DimensionZeroRow"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "SourcePartitionPruning"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "dummyPartitionPruning"
						}
					],
					"sinks": [
						{
							"name": "CacheMaxKey"
						},
						{
							"linkedService": {
								"referenceName": "templatecurst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "sinkZeroRecord"
						},
						{
							"linkedService": {
								"referenceName": "templatecurst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "sinkDimension"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "lookupDimension"
						},
						{
							"name": "selectDimension"
						},
						{
							"name": "derivedNewKey"
						},
						{
							"name": "surrogateKey"
						},
						{
							"name": "split1"
						},
						{
							"name": "derivedColumns"
						},
						{
							"name": "derivedExistingKey"
						},
						{
							"name": "union"
						},
						{
							"name": "selectBeforeSink"
						},
						{
							"name": "alterRow"
						},
						{
							"name": "alterZeroRow"
						},
						{
							"name": "sourceLookupKey"
						},
						{
							"name": "dimLookupKey"
						},
						{
							"name": "derivedMaxKey"
						},
						{
							"name": "aggregatePartitionPruning"
						},
						{
							"name": "unionPartitionPruning"
						},
						{
							"name": "collectPartitionPruning"
						}
					],
					"scriptLines": [
						"parameters{",
						"     p_src_key_cols as string[] ([\"name\"]),",
						"     p_src_cdc_col as string ('enrTimestamp'),",
						"     p_surrogate_key_col as string,",
						"     c_trg_dss_update_col as string ('dss_update_time'),",
						"     c_trg_dss_create_col as string ('dss_create_time'),",
						"     p_partition_formula as string (\"'dummy'\"),",
						"     c_trg_partition_col as string ('DIM_PARTITION'),",
						"     p_src_schema as string ('enr'),",
						"     p_src_object as string ('dataflows_REST_API'),",
						"     p_datetime_from as string ('2024-03-06T21:24:57'),",
						"     p_trg_table as string ('DimDataflows'),",
						"     p_init_load as boolean (false()),",
						"     c_trg_container as string ('template'),",
						"     c_trg_root_folder as string ('StarSchemaObjects')",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: (\"select * from \" + $p_src_schema + \".\" + $p_src_object + iif(length(coalesce($p_src_cdc_col, \"\")) == 0, \"\", \" where \" + $p_src_cdc_col + \" > '\" + iif(length(coalesce($p_datetime_from, \"\")) == 0, \"1900-01-01\", $p_datetime_from) + \"'\")),",
						"     format: 'query',",
						"     staged: false) ~> DataSource",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: (iif(not($p_init_load), \"select \" + $p_surrogate_key_col + reduce($p_src_key_cols, \"\", #acc + \", \" + #item, #result) + iif(length(coalesce($c_trg_dss_create_col, \"\")) == 0, \"\", \", \" + $c_trg_dss_create_col) + \" from \" + $p_trg_table, \"select cast(0 as bigint) as \" + $p_surrogate_key_col + reduce($p_src_key_cols, \"\", #acc + \", '' as \" + #item, #result) + iif(length(coalesce($c_trg_dss_create_col, \"\")) == 0, \"\", \", cast('1900-01-01' as datetime) as \" + $c_trg_dss_create_col + \" where 1 = 0\"))),",
						"     format: 'query',",
						"     staged: false) ~> Dimension",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: (iif(not($p_init_load), \"select max(\" + $p_surrogate_key_col + \") as \" + $p_surrogate_key_col + \" from \" + $p_trg_table, \"select cast(0 as bigint) as \" + $p_surrogate_key_col)),",
						"     format: 'query',",
						"     staged: false) ~> DimensionMaxKey",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: (\"select cast(0 as bigint) as \" + $p_surrogate_key_col + reduce($p_src_key_cols, \"\", #acc + \", '' as \" + #item, #result) + \", 'dummy' as \" + $c_trg_partition_col),",
						"     format: 'query',",
						"     staged: false) ~> DimensionZeroRow",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: (\"select * from \" + $p_src_schema + \".\" + $p_src_object + iif(length(coalesce($p_src_cdc_col, \"\")) == 0, \"\", \" where \" + $p_src_cdc_col + \" > '\" + iif(length(coalesce($p_datetime_from, \"\")) == 0, \"1900-01-01\", $p_datetime_from) + \"'\")),",
						"     format: 'query',",
						"     staged: false) ~> SourcePartitionPruning",
						"source(output(",
						"          PARTITION as string,",
						"          CONSTANT as string,",
						"          AGGREGATE as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: 'select \\'dummy\\' as PARTITION,\\n\\'CONSTANT\\' as CONSTANT, \\'dummy\\' as AGGREGATE',",
						"     format: 'query',",
						"     staged: false) ~> dummyPartitionPruning",
						"sourceLookupKey, selectDimension lookup(lookupKey == PREFIX_lookupKey,",
						"     multiple: false,",
						"     pickup: 'any',",
						"     broadcast: 'auto')~> lookupDimension",
						"dimLookupKey select(mapColumn(",
						"          each(match(true()),",
						"               'PREFIX_'+$$ = $$)",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectDimension",
						"surrogateKey derive(each(match(name=='surrogateKey'), $p_surrogate_key_col = surrogateKey + coalesce(CacheMaxKey#outputs()[0].surrogateKey, 0))) ~> derivedNewKey",
						"split1@NullKey keyGenerate(output(surrogateKey as long),",
						"     startAt: 1L,",
						"     stepValue: 1L) ~> surrogateKey",
						"derivedColumns split(isNull(toLong(byName('PREFIX_' + $p_surrogate_key_col))),",
						"     disjoint: false) ~> split1@(NullKey, NotNullKey)",
						"lookupDimension derive(each(match(name=='PREFIX_'+$c_trg_dss_create_col), $c_trg_dss_create_col = coalesce($$, currentTimestamp())),",
						"          each(match(name=='PREFIX_'+$p_surrogate_key_col), $c_trg_dss_update_col = currentTimestamp(), $c_trg_partition_col = expr($p_partition_formula))) ~> derivedColumns",
						"split1@NotNullKey derive(each(match(name=='PREFIX_'+$p_surrogate_key_col), $p_surrogate_key_col = $$)) ~> derivedExistingKey",
						"derivedNewKey, derivedExistingKey union(byName: true)~> union",
						"union select(mapColumn(",
						"          each(match(left(name,length('PREFIX_'))!='PREFIX_'&&name!='surrogateKey'&&name!='lookupKey'))",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectBeforeSink",
						"selectBeforeSink alterRow(upsertIf(true())) ~> alterRow",
						"DimensionZeroRow alterRow(upsertIf(true())) ~> alterZeroRow",
						"DataSource derive(lookupKey = md5(byNames($p_src_key_cols))) ~> sourceLookupKey",
						"Dimension derive(lookupKey = md5(byNames($p_src_key_cols))) ~> dimLookupKey",
						"DimensionMaxKey derive(surrogateKey = toLong(byName($p_surrogate_key_col))) ~> derivedMaxKey",
						"SourcePartitionPruning aggregate(groupBy(PARTITION = expr($p_partition_formula),",
						"          CONSTANT = 'CONSTANT'),",
						"     AGGREGATE = first(expr($p_partition_formula))) ~> aggregatePartitionPruning",
						"aggregatePartitionPruning, dummyPartitionPruning union(byName: true)~> unionPartitionPruning",
						"unionPartitionPruning aggregate(groupBy(CONSTANT),",
						"     PARTITION = collect(AGGREGATE)) ~> collectPartitionPruning",
						"derivedMaxKey sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 2,",
						"     mapColumn(",
						"          surrogateKey",
						"     )) ~> CacheMaxKey",
						"alterZeroRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     fileSystem: ($c_trg_container),",
						"     folderPath: ($c_trg_root_folder + \"/\" + $p_trg_table),",
						"     mergeSchema: true,",
						"     autoCompact: true,",
						"     optimizedWrite: true,",
						"     vacuum: 0,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:($p_src_key_cols),",
						"     pruneCondition: [($c_trg_partition_col) -> ([\"dummy\"])],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 1,",
						"     partitionBy('key',",
						"          0,",
						"          byName($c_trg_partition_col)",
						"     )) ~> sinkZeroRecord",
						"alterRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     fileSystem: ($c_trg_container),",
						"     folderPath: ($c_trg_root_folder + \"/\" + $p_trg_table),",
						"     mergeSchema: true,",
						"     autoCompact: true,",
						"     optimizedWrite: true,",
						"     vacuum: 0,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:($p_src_key_cols),",
						"     pruneCondition: [($c_trg_partition_col) -> (sinkPartitionPruning#outputs().PARTITION_PRUNING)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 3,",
						"     partitionBy('key',",
						"          0,",
						"          byName($c_trg_partition_col)",
						"     )) ~> sinkDimension",
						"collectPartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1,",
						"     mapColumn(",
						"          PARTITION_PRUNING = PARTITION",
						"     )) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templatecurst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/StarSchemaFact')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "DataSource"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "Fact"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "SourcePartitionPruning"
						},
						{
							"dataset": {
								"referenceName": "GenericServerlessSQL",
								"type": "DatasetReference"
							},
							"name": "dummyPartitionPruning"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "templatecurst_ARIR",
								"type": "LinkedServiceReference"
							},
							"name": "sinkDimension"
						},
						{
							"name": "sinkPartitionPruning"
						}
					],
					"transformations": [
						{
							"name": "lookupDimension"
						},
						{
							"name": "selectFact"
						},
						{
							"name": "derivedColumns"
						},
						{
							"name": "selectBeforeSink"
						},
						{
							"name": "alterRow"
						},
						{
							"name": "sourceLookupKey"
						},
						{
							"name": "factLookupKey"
						},
						{
							"name": "aggregatePartitionPruning"
						},
						{
							"name": "unionPartitionPruning"
						},
						{
							"name": "collectPartitionPruning"
						}
					],
					"scriptLines": [
						"parameters{",
						"     p_src_key_cols as string[] ([\"dataflows_name\",\"datasets_name\"]),",
						"     c_trg_dss_update_col as string ('dss_update_time'),",
						"     c_trg_dss_create_col as string ('dss_create_time'),",
						"     p_partition_formula as string (\"'dummy'\"),",
						"     c_trg_partition_col as string ('FACT_PARTITION'),",
						"     p_trg_table as string ('FactDataflowsDatasets'),",
						"     c_trg_container as string ('template'),",
						"     c_trg_root_folder as string ('StarSchemaObjects'),",
						"     p_src_query as string (\"select coalesce(DimDataflows.dataflows_key, 0) dataflows_key, coalesce(DimDatasets.datasets_key, 0) datasets_key, stg.* from openrowset(bulk 'https://ivsenr.dfs.core.windows.net/template/Staging/FactDataflowsDatasetsStg.parquet', format = 'PARQUET') as stg left outer join DimDataflows DimDataflows on stg.dataflows_name = DimDataflows.name left outer join DimDatasets DimDatasets on stg.datasets_name = DimDatasets.name\"),",
						"     p_trg_query as string (\"select null as dataflows_name, null as datasets_name, cast(null as datetime) as dss_create_time where 1 = 0\")",
						"}",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: ($p_src_query),",
						"     format: 'query',",
						"     staged: false) ~> DataSource",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: ($p_trg_query),",
						"     format: 'query',",
						"     staged: false) ~> Fact",
						"source(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: ($p_src_query),",
						"     format: 'query',",
						"     staged: false) ~> SourcePartitionPruning",
						"source(output(",
						"          PARTITION as string,",
						"          CONSTANT as string,",
						"          AGGREGATE as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     query: 'select \\'dummy\\' as PARTITION,\\n\\'CONSTANT\\' as CONSTANT, \\'dummy\\' as AGGREGATE',",
						"     format: 'query',",
						"     staged: false) ~> dummyPartitionPruning",
						"sourceLookupKey, selectFact lookup(lookupKey == PREFIX_lookupKey,",
						"     multiple: false,",
						"     pickup: 'any',",
						"     broadcast: 'auto')~> lookupDimension",
						"factLookupKey select(mapColumn(",
						"          each(match(true()),",
						"               'PREFIX_'+$$ = $$)",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectFact",
						"lookupDimension derive(each(match(name=='PREFIX_'+$c_trg_dss_create_col), $c_trg_dss_create_col = coalesce($$, currentTimestamp()), $c_trg_dss_update_col = currentTimestamp(), $c_trg_partition_col = expr($p_partition_formula))) ~> derivedColumns",
						"derivedColumns select(mapColumn(",
						"          each(match(left(name,length('PREFIX_'))!='PREFIX_'&&name!='surrogateKey'&&name!='lookupKey'))",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectBeforeSink",
						"selectBeforeSink alterRow(upsertIf(true())) ~> alterRow",
						"DataSource derive(lookupKey = md5(byNames($p_src_key_cols))) ~> sourceLookupKey",
						"Fact derive(lookupKey = md5(byNames($p_src_key_cols))) ~> factLookupKey",
						"SourcePartitionPruning aggregate(groupBy(PARTITION = expr($p_partition_formula),",
						"          CONSTANT = 'CONSTANT'),",
						"     AGGREGATE = first(expr($p_partition_formula))) ~> aggregatePartitionPruning",
						"aggregatePartitionPruning, dummyPartitionPruning union(byName: true)~> unionPartitionPruning",
						"unionPartitionPruning aggregate(groupBy(CONSTANT),",
						"     PARTITION = collect(AGGREGATE)) ~> collectPartitionPruning",
						"alterRow sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'delta',",
						"     fileSystem: ($c_trg_container),",
						"     folderPath: ($c_trg_root_folder + \"/\" + $p_trg_table),",
						"     mergeSchema: true,",
						"     autoCompact: true,",
						"     optimizedWrite: true,",
						"     vacuum: 0,",
						"     deletable: false,",
						"     insertable: false,",
						"     updateable: false,",
						"     upsertable: true,",
						"     keys:($p_src_key_cols),",
						"     pruneCondition: [($c_trg_partition_col) -> (sinkPartitionPruning#outputs().PARTITION_PRUNING)],",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     saveOrder: 2,",
						"     partitionBy('key',",
						"          0,",
						"          byName($c_trg_partition_col)",
						"     )) ~> sinkDimension",
						"collectPartitionPruning sink(validateSchema: false,",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     store: 'cache',",
						"     format: 'inline',",
						"     output: false,",
						"     saveOrder: 1,",
						"     mapColumn(",
						"          PARTITION_PRUNING = PARTITION",
						"     )) ~> sinkPartitionPruning"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/GenericServerlessSQL')]",
				"[concat(variables('workspaceId'), '/linkedServices/templatecurst_ARIR')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TemplateDimension1')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "TMPL_DATASOURCE2",
								"type": "DatasetReference"
							},
							"name": "DataSource"
						},
						{
							"dataset": {
								"referenceName": "TMPL_DIMENSION1",
								"type": "DatasetReference"
							},
							"name": "Dimension"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "TMPL_DIMENSION1",
								"type": "DatasetReference"
							},
							"name": "DimensionSink"
						}
					],
					"transformations": [
						{
							"name": "SelectDimension"
						},
						{
							"name": "LookupDimension"
						},
						{
							"name": "SelectColumns"
						},
						{
							"name": "DerivedColumns"
						},
						{
							"name": "AlterRow"
						}
					],
					"script": "source(output(\n\t\tSOURCE2_ID as string,\n\t\tNCHAR_VALUE1 as string,\n\t\tNCHAR_VALUE2 as string,\n\t\tNUMERIC_VALUE1 as double,\n\t\tNUMERIC_VALUE2 as double,\n\t\tDATETIME_VALUE1 as string,\n\t\tDATETIME_VALUE2 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> DataSource\nsource(output(\n\t\tDIMENSION1_KEY as string,\n\t\tSOURCE2_ID as string,\n\t\tNCHAR_ATTRIBUTE1 as string,\n\t\tNCHAR_ATTRIBUTE2 as string,\n\t\tDATETIME_ATTRIBUTE1 as string,\n\t\tDATETIME_ATTRIBUTE2 as string,\n\t\tDSS_CREATE_TIME as string,\n\t\tDSS_UPDATE_TIME as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> Dimension\nDimension select(mapColumn(\n\t\teach(match(true()),\n\t\t\t'DIMPREFIX_'+$$ = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDimension\nDataSource, SelectDimension lookup(SOURCE2_ID == DIMPREFIX_SOURCE2_ID,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupDimension\nLookupDimension select(mapColumn(\n\t\tDSS_CREATE_TIME = DIMPREFIX_DSS_CREATE_TIME,\n\t\teach(match(left(name,length('DIMPREFIX_'))!='DIMPREFIX_'),\n\t\t\treplace($$,'VALUE','ATTRIBUTE') = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectColumns\nSelectColumns derive(DSS_CREATE_TIME = iif(isNull(DSS_CREATE_TIME), toString(currentTimestamp()), DSS_CREATE_TIME),\n\t\tDSS_UPDATE_TIME = toString(currentTimestamp())) ~> DerivedColumns\nDerivedColumns alterRow(upsertIf(true())) ~> AlterRow\nAlterRow sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tDIMENSION1_KEY as integer,\n\t\tSOURCE2_ID as integer,\n\t\tNCHAR_ATTRIBUTE1 as string,\n\t\tNCHAR_ATTRIBUTE2 as string,\n\t\tDATETIME_ATTRIBUTE1 as timestamp,\n\t\tDATETIME_ATTRIBUTE2 as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['SOURCE2_ID'],\n\tformat: 'table',\n\tstaged: true,\n\tpreSQLs:['EXEC\t[dbo].[ZeroRow]\\n\t\t@p_tabname = N\\'TMPL_DIMENSION1\\',\\n\t\t@p_keycolname = N\\'DIMENSION1_KEY\\',\\n\t\t@p_varchar = N\\'Unknown\\',\\n\t\t@p_numeric = NULL,\\n\t\t@p_date = NULL,\\n\t\t@p_time = NULL,\\n\t\t@p_bit = NULL'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> DimensionSink"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/TMPL_DATASOURCE2')]",
				"[concat(variables('workspaceId'), '/datasets/TMPL_DIMENSION1')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TemplateDimension2')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "TMPL_DATASOURCE3",
								"type": "DatasetReference"
							},
							"name": "DataSource"
						},
						{
							"dataset": {
								"referenceName": "TMPL_DIMENSION2",
								"type": "DatasetReference"
							},
							"name": "Dimension"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "TMPL_DIMENSION2",
								"type": "DatasetReference"
							},
							"name": "DimensionSink"
						}
					],
					"transformations": [
						{
							"name": "SelectDimension"
						},
						{
							"name": "LookupDimension"
						},
						{
							"name": "SelectColumns"
						},
						{
							"name": "DerivedColumns"
						},
						{
							"name": "AlterRow"
						}
					],
					"script": "source(output(\n\t\tSOURCE3_ID as short,\n\t\tNCHAR_VALUE1 as string,\n\t\tNCHAR_VALUE2 as string,\n\t\tNUMERIC_VALUE1 as double,\n\t\tNUMERIC_VALUE2 as double,\n\t\tDATETIME_VALUE1 as string,\n\t\tDATETIME_VALUE2 as string,\n\t\tCDC_TIMESTAMP as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> DataSource\nsource(output(\n\t\tDIMENSION2_KEY as integer,\n\t\tSOURCE3_ID as integer,\n\t\tNCHAR_ATTRIBUTE1 as string,\n\t\tNCHAR_ATTRIBUTE2 as string,\n\t\tDATETIME_ATTRIBUTE1 as timestamp,\n\t\tDATETIME_ATTRIBUTE2 as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> Dimension\nDimension select(mapColumn(\n\t\teach(match(true()),\n\t\t\t'DIMPREFIX_'+$$ = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDimension\nDataSource, SelectDimension lookup(SOURCE3_ID == DIMPREFIX_SOURCE3_ID,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupDimension\nLookupDimension select(mapColumn(\n\t\tSOURCE3_ID,\n\t\tDSS_CREATE_TIME = DIMPREFIX_DSS_CREATE_TIME,\n\t\teach(match(left(name,length('DIMPREFIX_'))!='DIMPREFIX_'),\n\t\t\treplace($$,'VALUE','ATTRIBUTE') = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectColumns\nSelectColumns derive(DSS_CREATE_TIME = iif(isNull(DSS_CREATE_TIME), currentTimestamp(), DSS_CREATE_TIME),\n\t\tDSS_UPDATE_TIME = toString(currentTimestamp())) ~> DerivedColumns\nDerivedColumns alterRow(upsertIf(true())) ~> AlterRow\nAlterRow sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tDIMENSION2_KEY as integer,\n\t\tSOURCE3_ID as integer,\n\t\tNCHAR_ATTRIBUTE1 as string,\n\t\tNCHAR_ATTRIBUTE2 as string,\n\t\tDATETIME_ATTRIBUTE1 as timestamp,\n\t\tDATETIME_ATTRIBUTE2 as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['SOURCE3_ID'],\n\tformat: 'table',\n\tstaged: true,\n\tpreSQLs:['EXEC\t[dbo].[ZeroRow]\\n\t\t@p_tabname = N\\'TMPL_DIMENSION2\\',\\n\t\t@p_keycolname = N\\'DIMENSION2_KEY\\',\\n\t\t@p_varchar = N\\'Unknown\\',\\n\t\t@p_numeric = NULL,\\n\t\t@p_date = NULL,\\n\t\t@p_time = NULL,\\n\t\t@p_bit = NULL'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> DimensionSink"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/TMPL_DATASOURCE3')]",
				"[concat(variables('workspaceId'), '/datasets/TMPL_DIMENSION2')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/TemplateFact')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Templates"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "TMPL_STAGING",
								"type": "DatasetReference"
							},
							"name": "Source"
						},
						{
							"dataset": {
								"referenceName": "TMPL_DIMENSION1",
								"type": "DatasetReference"
							},
							"name": "Dimension1"
						},
						{
							"dataset": {
								"referenceName": "TMPL_DIMENSION2",
								"type": "DatasetReference"
							},
							"name": "Dimension2"
						},
						{
							"dataset": {
								"referenceName": "TMPL_FACT",
								"type": "DatasetReference"
							},
							"name": "Fact"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "TMPL_FACT",
								"type": "DatasetReference"
							},
							"name": "FactSink"
						}
					],
					"transformations": [
						{
							"name": "SelectSource"
						},
						{
							"name": "LookupDimension1"
						},
						{
							"name": "Select1"
						},
						{
							"name": "LookupDimension2"
						},
						{
							"name": "Select2"
						},
						{
							"name": "SelectFact"
						},
						{
							"name": "LookupFact"
						},
						{
							"name": "Select3"
						},
						{
							"name": "DerivedColumns"
						},
						{
							"name": "AlterRow"
						}
					],
					"script": "source(output(\n\t\tSRC1_SOURCE1_ID as integer,\n\t\tSRC1_SOURCE2_REF_ID as integer,\n\t\tSRC1_SOURCE3_REF_ID as integer,\n\t\tSRC1_NCHAR_VALUE1 as string,\n\t\tSRC1_NCHAR_VALUE2 as string,\n\t\tSRC1_NUMERIC_VALUE1 as decimal(18,4),\n\t\tSRC1_NUMERIC_VALUE2 as decimal(18,4),\n\t\tSRC1_DATETIME_VALUE1 as timestamp,\n\t\tSRC1_DATETIME_VALUE2 as timestamp,\n\t\tSRC1_CDC_TIMESTAMP as timestamp,\n\t\tSRC2_SOURCE2_ID as integer,\n\t\tSRC2_NCHAR_VALUE1 as string,\n\t\tSRC2_NCHAR_VALUE2 as string,\n\t\tSRC2_NUMERIC_VALUE1 as decimal(18,4),\n\t\tSRC2_NUMERIC_VALUE2 as decimal(18,4),\n\t\tSRC2_DATETIME_VALUE1 as timestamp,\n\t\tSRC2_DATETIME_VALUE2 as timestamp,\n\t\tSRC3_SOURCE3_ID as integer,\n\t\tSRC3_NCHAR_VALUE1 as string,\n\t\tSRC3_NCHAR_VALUE2 as string,\n\t\tSRC3_NUMERIC_VALUE1 as decimal(18,4),\n\t\tSRC3_NUMERIC_VALUE2 as decimal(18,4),\n\t\tSRC3_DATETIME_VALUE1 as timestamp,\n\t\tSRC3_DATETIME_VALUE2 as timestamp,\n\t\tDSS_CREATE_TIME as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet') ~> Source\nsource(output(\n\t\tDIMENSION1_KEY as integer,\n\t\tSOURCE2_ID as integer,\n\t\tNCHAR_ATTRIBUTE1 as string,\n\t\tNCHAR_ATTRIBUTE2 as string,\n\t\tDATETIME_ATTRIBUTE1 as timestamp,\n\t\tDATETIME_ATTRIBUTE2 as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'select * from TMPL_DIMENSION1 d where exists (select 1 from ADLS_TMPL_STAGING_KEY k where k.SRC1_SOURCE2_REF_ID = d.SOURCE2_ID)',\n\tformat: 'query',\n\tstaged: false) ~> Dimension1\nsource(output(\n\t\tDIMENSION2_KEY as integer,\n\t\tSOURCE3_ID as integer,\n\t\tNCHAR_ATTRIBUTE1 as string,\n\t\tNCHAR_ATTRIBUTE2 as string,\n\t\tDATETIME_ATTRIBUTE1 as timestamp,\n\t\tDATETIME_ATTRIBUTE2 as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'select * from TMPL_DIMENSION2 d where exists (select 1 from ADLS_TMPL_STAGING_KEY k where k.SRC1_SOURCE3_REF_ID = d.SOURCE3_ID)',\n\tformat: 'query',\n\tstaged: false) ~> Dimension2\nsource(output(\n\t\tDIMENSION1_KEY as integer,\n\t\tDIMENSION2_KEY as integer,\n\t\tSOURCE1_ID as integer,\n\t\tSRC1_MEASURE1 as decimal(18,4),\n\t\tSRC1_MEASURE2 as decimal(18,4),\n\t\tSRC2_MEASURE1 as decimal(18,4),\n\t\tSRC2_MEASURE2 as decimal(18,4),\n\t\tSRC3_MEASURE1 as decimal(18,4),\n\t\tSRC3_MEASURE2 as decimal(18,4),\n\t\tSRC1_CDC_TIMESTAMP as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> Fact\nSource select(mapColumn(\n\t\teach(match(true()),\n\t\t\t'SOURCE_'+$$ = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSource\nSelectSource, Dimension1 lookup(SOURCE_SRC1_SOURCE2_REF_ID == SOURCE2_ID,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupDimension1\nLookupDimension1 select(mapColumn(\n\t\teach(match(left(name,length('SOURCE_'))=='SOURCE_')),\n\t\teach(match(right(name,length('_KEY'))=='_KEY'))\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSelect1, Dimension2 lookup(SOURCE_SRC1_SOURCE3_REF_ID == SOURCE3_ID,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupDimension2\nLookupDimension2 select(mapColumn(\n\t\teach(match(left(name,length('SOURCE_'))=='SOURCE_')),\n\t\teach(match(right(name,length('_KEY'))=='_KEY'))\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\nFact select(mapColumn(\n\t\teach(match(true()),\n\t\t\t'FACT_'+$$ = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFact\nSelect2, SelectFact lookup(SOURCE_SRC1_SOURCE1_ID == FACT_SOURCE1_ID,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupFact\nLookupFact select(mapColumn(\n\t\tSOURCE1_ID = SOURCE_SRC1_SOURCE1_ID,\n\t\tSRC1_CDC_TIMESTAMP = SOURCE_SRC1_CDC_TIMESTAMP,\n\t\tDSS_CREATE_TIME = FACT_DSS_CREATE_TIME,\n\t\teach(match(right(name,length('_KEY'))=='_KEY'&&left(name,length('FACT_'))!='FACT_')),\n\t\teach(match(left(name,length('SOURCE_'))=='SOURCE_'&&instr(name,'NUMERIC')>0),\n\t\t\treplace(right($$,length($$)-length('SOURCE_')),'NUMERIC_VALUE','MEASURE') = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select3\nSelect3 derive(each(match(right(name,length('_KEY'))=='_KEY'), $$ = iifNull($$, 0)),\n\t\tDSS_CREATE_TIME = iif(isNull(DSS_CREATE_TIME), currentTimestamp(), DSS_CREATE_TIME),\n\t\tDSS_UPDATE_TIME = currentTimestamp()) ~> DerivedColumns\nDerivedColumns alterRow(upsertIf(true())) ~> AlterRow\nAlterRow sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tDIMENSION1_KEY as integer,\n\t\tDIMENSION2_KEY as integer,\n\t\tSOURCE1_ID as integer,\n\t\tSRC1_MEASURE1 as decimal(18,4),\n\t\tSRC1_MEASURE2 as decimal(18,4),\n\t\tSRC2_MEASURE1 as decimal(18,4),\n\t\tSRC2_MEASURE2 as decimal(18,4),\n\t\tSRC3_MEASURE1 as decimal(18,4),\n\t\tSRC3_MEASURE2 as decimal(18,4),\n\t\tSRC1_CDC_TIMESTAMP as timestamp,\n\t\tDSS_CREATE_TIME as timestamp,\n\t\tDSS_UPDATE_TIME as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['SOURCE1_ID'],\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> FactSink"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/TMPL_STAGING')]",
				"[concat(variables('workspaceId'), '/datasets/TMPL_DIMENSION1')]",
				"[concat(variables('workspaceId'), '/datasets/TMPL_DIMENSION2')]",
				"[concat(variables('workspaceId'), '/datasets/TMPL_FACT')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/WorkspaceSystemIdentity')]",
			"type": "Microsoft.Synapse/workspaces/credentials",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "ManagedIdentity",
				"typeProperties": {}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Template_cur_source')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Serverless Deploy"
				},
				"content": {
					"query": "use templateDB\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'TemplateCuratedSource') \n\tCREATE EXTERNAL DATA SOURCE [TemplateCuratedSource] \n\tWITH (\n\t\tLOCATION = 'https://{cur_storage_account}.blob.core.windows.net/template',\n\t\tCREDENTIAL = [SynapseIdentity] \n\t)",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "templateDB",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Template_delta_format')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Serverless Deploy"
				},
				"content": {
					"query": "use templateDB\n\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'Delta') \n\tCREATE EXTERNAL FILE FORMAT Delta\n\tWITH (\n\t\tFORMAT_TYPE = DELTA\n\t)",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "templateDB",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Template_enr_schema')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "Serverless Deploy"
				},
				"content": {
					"query": "use templateDB\n\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'enr') \nEXEC('CREATE SCHEMA [enr]')",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "templateDB",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ivssql')]",
			"type": "Microsoft.Synapse/workspaces/sqlPools",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"collation": "SQL_Latin1_General_CP1_CI_AS",
				"maxSizeBytes": 263882790666240,
				"annotations": []
			},
			"dependsOn": [],
			"location": "westus"
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ivsspark')]",
			"type": "Microsoft.Synapse/workspaces/bigDataPools",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"autoPause": {
					"enabled": true,
					"delayInMinutes": 5
				},
				"autoScale": {
					"enabled": false,
					"maxNodeCount": 10,
					"minNodeCount": 3
				},
				"nodeCount": 3,
				"nodeSize": "Small",
				"nodeSizeFamily": "MemoryOptimized",
				"sparkVersion": "3.1",
				"isComputeIsolationEnabled": false,
				"sessionLevelPackagesEnabled": false,
				"annotations": []
			},
			"dependsOn": [],
			"location": "westus"
		}
	]
}